<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>

    <!-- 不再用 script src 方式載 transformers，改在 module 裡 import -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
        .disclaimer { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #856404; }
        .title { text-align: center; color: #6c5ce7; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #a29bfe; font-size: 1.2em; margin-bottom: 20px; }
        .section { display: none; margin-bottom: 40px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white; min-height: 60vh; }
        .section.active { display: block; }
        .front-page { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border-radius: 8px; margin-bottom: 20px; }
        .front-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
        .front-btn { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; transition: transform 0.2s; }
        .front-btn:hover { transform: scale(1.05); }
        .analysis-btn { background: #00b894; color: white; }
        .gists-btn { background: #fdcb6e; color: #2d3436; }
        .back-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #74b9ff; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 1000; display: none; }
        .back-btn.active { display: block; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="file"] { margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        button:not(.front-btn):not(.back-btn) { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #74b9ff; color: white; }
        .output { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; }
        .diff { margin-top: 10px; }
        .feedback { background: #d1ecf1; padding: 10px; border-left: 4px solid #17a2b8; margin-top: 10px; }
        .gist-area { background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        #writing-materials { height: 200px; overflow-y: auto; }
        #printable-drafts { display: none; }
        @media print {
            .no-print { display: none; }
            .printable { page-break-after: always; }
        }
        @media (max-width: 600px) {
            .front-buttons { flex-direction: column; align-items: center; }
            .controls { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goHome()">← Back to Home</button>

    <h1 class="title">Shirley's AI Writing Coach</h1>
    <p class="subtitle">Educational practice and entertainment only. Use this tool to enhance your writing skills with AI feedback.</p>

    <div class="disclaimer">
        <strong>This tool—"Shirley's AI Writing Coach"—is for educational practice and entertainment only.</strong><br>
        Focus on iterating with the feedback—practice drives progress!
    </div>

    <!-- Home -->
    <section class="section active front-page" id="home-section">
        <h2>Welcome! Choose Your Writing Adventure</h2>
        <p>Press a button below to enter the next level of your writing journey.</p>
        <div class="front-buttons">
            <button class="front-btn analysis-btn" onclick="enterLevel('analysis')">Writing Analysis Level</button>
            <button class="front-btn gists-btn" onclick="enterLevel('gists')">Gists for English Writing Level</button>
        </div>
    </section>

    <!-- Level 1 -->
    <section class="section" id="analysis-section">
        <h2>Level 1: Writing Analysis / Feedback</h2>
        <p>Paste or upload your writing below. The AI will provide grammar corrections and feedback based on a rubric (rubric.csv in your GitHub repo).</p>
        <textarea id="input-text" placeholder="Paste your writing here..."></textarea>
        <input type="file" id="file-upload" accept=".txt" style="display: block; margin-bottom: 10px;">
        <div class="controls">
            <button onclick="analyzeWriting()" class="no-print">Analyze & Feedback</button>
        </div>
        <div id="output" class="output"></div>
        <textarea id="edit-text" placeholder="Edit your draft here..."></textarea>
        <div class="controls">
            <button onclick="submitEdit()" class="no-print">Submit Edit for Feedback</button>
            <button onclick="printDrafts()" class="no-print">Print All Drafts</button>
        </div>
    </section>

    <!-- Level 2 -->
    <section class="section" id="gists-section">
        <h2>Level 2: Shirley's Gists for English Writing</h2>
        <p>Enhance your writing skills with these resources.</p>

        <div class="gist-area">
            <h3>1) All about Writing: Self-Designed Materials</h3>
            <div id="writing-materials">Loading materials...</div>
        </div>

        <div class="gist-area">
            <h3>2) Practice with a Topic</h3>
            <input type="text" id="topic-input" placeholder="Enter the topic (e.g., 'Describe your favorite holiday')">
            <textarea id="topic-text" placeholder="Write your essay here..."></textarea>
            <div class="controls">
                <button onclick="analyzeTopic()">Submit for Feedback</button>
            </div>
            <div id="topic-output" class="output"></div>
        </div>
    </section>

    <div id="printable-drafts" class="printable"></div>

    <!-- 這段用 ES module，匯入 transformers，並把所有需要被 onclick 呼叫的函式掛到 window 上 -->
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        let currentLevel = 'home';
        let drafts = [];
        let generator = null;
        let feedbackGenerator = null;
        let rubricText = '';

        async function loadModels() {
            if (!generator) {
                generator = await pipeline('text2text-generation', 'Xenova/t5-base-grammar-correction');
            }
            if (!feedbackGenerator) {
                feedbackGenerator = await pipeline('text-generation', 'Xenova/distilgpt2');
            }
        }

        async function loadRubric() {
            try {
                const response = await fetch('https://ducj-creator.github.io/Shirley-AI-Writing/writing%20rubric.csv');
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true }).data;
                rubricText = parsed
                    .map(row => `${row.Criterion || 'Criterion'}: ${row.Description || 'N/A'}`)
                    .join('\n');
            } catch (e) {
                rubricText = 'Default rubric: Check for grammar, clarity, structure, and coherence.';
                console.warn('Rubric not found, using default.', e);
            }
        }

        async function loadWritingMaterials() {
            try {
                // TODO: 把 YOUR_USERNAME / YOUR_REPO 換成你自己的 GitHub raw 路徑
                const response = await fetch('https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/writing-materials.md');
                const md = await response.text();
                document.getElementById('writing-materials').innerHTML = `<pre>${md}</pre>`;
            } catch (e) {
                document.getElementById('writing-materials').innerHTML =
                    '<p>Place your self-designed materials in writing-materials.md in the repo and update the fetch URL.</p>';
            }
        }

        // ---- 下面這些函式都掛到 window，給 HTML 的 onclick 用 ----
        window.enterLevel = function(level) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(level + '-section');
            if (target) target.classList.add('active');
            document.querySelector('.back-btn').classList.add('active');
            currentLevel = level;
            if (level === 'gists') loadWritingMaterials();
        };

        window.goHome = function() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            document.querySelector('.back-btn').classList.remove('active');
            currentLevel = 'home';
        };

        window.analyzeWriting = async function() {
            await loadModels();
            await loadRubric();
            const text = document.getElementById('input-text').value;
            if (!text) {
                alert('Please enter text.');
                return;
            }

            const corrected = await generator('grammar: ' + text, { max_new_tokens: 512 });

            const prompt =
                `Provide detailed feedback on the following writing based on this rubric:\n` +
                `${rubricText}\n\nWriting: ${text}\n\nFeedback:`;
            const feedback = await feedbackGenerator(prompt, {
                max_new_tokens: 150,
                do_sample: true
            });

            const diff = Diff.diffWords(text, corrected[0].generated_text);
            const display = diff
                .map(part => {
                    const className = part.added ? 'ins' : part.removed ? 'del' : '';
                    return `<span class="${className}">${part.value}</span>`;
                })
                .join('');

            document.getElementById('output').innerHTML = `
                <h3>Corrected Version:</h3>
                <div class="diff">${display}</div>
                <style>
                    .ins { background: #d4fcbc; }
                    .del { background: #fbb; text-decoration: line-through; }
                </style>
                <div class="feedback">
                    <h3>AI Feedback:</h3>
                    <p>${feedback[0].generated_text}</p>
                </div>
            `;

            document.getElementById('edit-text').value = corrected[0].generated_text;
            drafts.push({
                original: text,
                corrected: corrected[0].generated_text,
                feedback: feedback[0].generated_text
            });
        };

        window.submitEdit = function() {
            document.getElementById('input-text').value = document.getElementById('edit-text').value;
            window.analyzeWriting();
        };

        window.printDrafts = function() {
            const printable = document.getElementById('printable-drafts');
            printable.innerHTML = drafts
                .map(
                    (draft, i) => `
                <div class="printable">
                    <h2>Draft ${i + 1}</h2>
                    <h3>Original:</h3><p>${draft.original}</p>
                    <h3>Corrected:</h3><p>${draft.corrected}</p>
                    <h3>Feedback:</h3><p>${draft.feedback}</p>
                </div>
            `
                )
                .join('');
            printable.style.display = 'block';
            window.print();
            printable.style.display = 'none';
        };

        window.analyzeTopic = async function() {
            await loadModels();
            await loadRubric();
            const topic = document.getElementById('topic-input').value;
            const text = document.getElementById('topic-text').value;
            if (!text || !topic) {
                alert('Please enter topic and text.');
                return;
            }

            const corrected = await generator('grammar: ' + text, { max_new_tokens: 512 });

            const prompt =
                `Topic: ${topic}\nProvide feedback on how well this essay addresses the topic, based on rubric:\n` +
                `${rubricText}\n\nEssay: ${text}\n\nFeedback:`;
            const feedback = await feedbackGenerator(prompt, {
                max_new_tokens: 200,
                do_sample: true
            });

            const diff = Diff.diffWords(text, corrected[0].generated_text);
            const display = diff
                .map(
                    part =>
                        `<span class="${part.added ? 'ins' : part.removed ? 'del' : ''}">${part.value}</span>`
                )
                .join('');

            document.getElementById('topic-output').innerHTML = `
                <h3>Corrected Essay:</h3>
                <div class="diff">${display}</div>
                <style>
                    .ins { background: #d4fcbc; }
                    .del { background: #fbb; text-decoration: line-through; }
                </style>
                <div class="feedback">
                    <h3>Topic-Specific Feedback:</h3>
                    <p>${feedback[0].generated_text}</p>
                </div>
            `;
        };

        // 檔案上傳事件（這個不需要掛到 window）
        document.getElementById('file-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    document.getElementById('input-text').value = ev.target.result;
                };
                reader.readAsText(file);
            }
        });

        // 進頁面時先試著載一遍教材
        loadWritingMaterials();
    </script>
</body>
</html>
