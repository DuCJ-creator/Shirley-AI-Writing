<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>
    <!-- diff / csv parser（全域掛在 window） -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- OCR / PDF / DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --bg-main: #f6efe5;
            --bg-card: #fbf7f0;
            --bg-front: #f0e2c9;
            --accent: #c39a6b;
            --accent-dark: #8b5e34;
            --accent-soft: #e2c9a3;
            --text-main: #4a3b2a;
            --text-muted: #8a7b6a;
            --border-soft: #e0d2c3;
            --error-bg: #ffe9d9;
            --error-border: #e17055;
            --info-bg: #e8f4f6;
            --info-border: #17a2b8;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 60px;
            background: radial-gradient(circle at top, #fdf7ee 0, #f3eadf 40%, #ebdfd1 100%);
            color: var(--text-main);
        }
        .title {
            text-align: center;
            color: var(--accent-dark);
            font-size: 2.4em;
            margin-bottom: 8px;
            letter-spacing: 0.03em;
        }
        .subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.05em;
            margin-bottom: 20px;
        }
        .disclaimer {
            background: #fff7ea;
            border: 1px solid var(--border-soft);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .section {
            display: none;
            margin-bottom: 40px;
            border: 1px solid var(--border-soft);
            padding: 20px;
            border-radius: 16px;
            background: var(--bg-card);
            min-height: 60vh;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
        }
        .section.active { display: block; }
        .front-page {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f4e0c2, #e3c59a);
            color: #4e3424;
            border-radius: 18px;
            margin-bottom: 20px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .front-page h2 {
            margin-top: 0;
            font-size: 1.8em;
        }
        .front-page p {
            max-width: 600px;
            margin: 8px auto 0;
        }
        .front-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .front-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
            box-shadow: 0 6px 14px rgba(0,0,0,0.12);
        }
        .front-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 10px 22px rgba(0,0,0,0.16);
        }
        .analysis-btn {
            background: #c39a6b;
            color: white;
        }
        .gists-btn {
            background: #f3d9a4;
            color: #4a3422;
        }
        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 10px 20px;
            background: #d5b692;
            color: #3e2a19;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
        }
        .back-btn.active { display: inline-flex; align-items: center; gap: 4px; }
        textarea,
        select {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 12px;
            border: 1px solid var(--border-soft);
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            background: #fffdf8;
            color: var(--text-main);
        }
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }
        #prompt-input { height: 80px; }
        #input-text, #topic-text { height: 200px; }
        #checked-text, #topic-checked-text { height: 200px; }
        input[type="file"] {
            margin-bottom: 10px;
            font-size: 13px;
        }
        input[type="text"] {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            font-size: 13px;
            background: #fffdf8;
            width: 100%;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        button:not(.front-btn):not(.back-btn) {
            padding: 10px 18px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease;
        }
        button:not(.front-btn):not(.back-btn):hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
        }
        .output {
            margin-top: 16px;
            padding: 15px;
            border-radius: 12px;
            background: #fffdf8;
            border: 1px solid var(--border-soft);
        }
        .analysis-run {
            border: 1px solid var(--border-soft);
            background: var(--bg-card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .version-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) auto minmax(0, 1.1fr);
            gap: 14px;
        }
        .version-col h3 {
            margin-top: 0;
            font-size: 0.95em;
            color: var(--text-muted);
        }
        .version-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            justify-content: center;
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .version-actions small { display: block; text-align: center; }
        .version-header-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .diff { margin-top: 10px; }
        .feedback {
            background: var(--info-bg);
            padding: 10px 12px;
            border-left: 4px solid var(--info-border);
            margin-top: 14px;
            border-radius: 8px;
            font-size: 0.92em;
        }
        .scores-block {
            background: #fff9eb;
            border: 1px solid var(--accent-soft);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            font-size: 0.92em;
        }
        .scores-block strong {
            display: inline-block;
            margin-bottom: 4px;
        }
        .scores-block ul {
            padding-left: 18px;
            margin: 4px 0 6px;
        }
        .gist-area {
            background: #fff9ef;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-soft);
        }
        #writing-materials { min-height: 100px; }
        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .material-card {
            flex: 1 1 260px;
            background: #ffffff;
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 12px;
        }
        .material-card h4 { margin-top: 0; }
        #printable-drafts { display: none; }
        /* 錯誤高亮共用基底 */
        .err {
            background: #ffeaa7;
            border-bottom: 2px solid #d63031;
            cursor: help;
        }
        /* 不同版本的顏色（Version 1~6 循環使用） */
        .err-v1 { background: #ffeaa7; border-bottom-color: #d63031; }
        .err-v2 { background: #d1ffd6; border-bottom-color: #16a085; }
        .err-v3 { background: #d6e9ff; border-bottom-color: #2980b9; }
        .err-v4 { background: #f9d1ff; border-bottom-color: #8e44ad; }
        .err-v5 { background: #ffe6d1; border-bottom-color: #e67e22; }
        .err-v6 { background: #fff8b3; border-bottom-color: #f1c40f; }
        /* Level 2（topic 練習）的顏色 */
        .err-topic { background: #ffd6e0; border-bottom-color: #c0392b; }
        /* Rubric reminder block（預設收合，由按鈕開啟） */
        .rubric-reminder {
            background: #fffdf8;
            border-radius: 10px;
            border: 1px dashed var(--accent-soft);
            padding: 10px 12px;
            margin-top: 8px;
            margin-bottom: 4px;
            font-size: 0.9em;
            max-height: 260px;
            overflow-y: auto;
        }
        .rubric-reminder h3 {
            margin: 0 0 6px;
            font-size: 0.95em;
            color: var(--accent-dark);
        }
        .rubric-toggle-btn {
            margin-top: 6px;
            margin-bottom: 4px;
            font-size: 0.82em;
            padding: 6px 14px;
        }
        /* 原本 sticky 的 class，現在只當一般容器用（取消凍結） */
        .analysis-sticky {
            position: static;
        }
        /* 版本顏色 legend */
        .version-legend {
            margin: 4px 0 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 6px 14px;
        }
        .version-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            display: inline-block;
            width: 14px;
            height: 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            vertical-align: middle;
        }
        .legend-v1 { background: #ffeaa7; border-color: #d63031; }
        .legend-v2 { background: #d1ffd6; border-color: #16a085; }
        .legend-v3 { background: #d6e9ff; border-color: #2980b9; }
        .legend-v4 { background: #f9d1ff; border-color: #8e44ad; }
        .legend-v5 { background: #ffe6d1; border-color: #e67e22; }
        .legend-v6 { background: #fff8b3; border-color: #f1c40f; }
        .legend-topic { background: #ffd6e0; border-color: #c0392b; }
        /* 版本標題的小彩色 badge */
        .version-chip {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .version-chip-v1 { background: #fff4d0; border: 1px solid #d63031; color: #6b2b1e; }
        .version-chip-v2 { background: #ddffea; border: 1px solid #16a085; color: #10624f; }
        .version-chip-v3 { background: #e1f0ff; border: 1px solid #2980b9; color: #1c496d; }
        .version-chip-v4 { background: #fbe3ff; border: 1px solid #8e44ad; color: #5a2c73; }
        .version-chip-v5 { background: #ffe9d6; border: 1px solid #e67e22; color: #8c3f09; }
        .version-chip-v6 { background: #fffad1; border: 1px solid #f1c40f; color: #8a6d1e; }
        .version-chip-ref { background: #e6e6e6; border: 1px solid #aaaaaa; color: #444; }
        /* Prompt + 學生資訊 */
        .prompt-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 8px;
            margin-bottom: 10px;
        }
        .prompt-main {
            flex: 2 1 0;
        }
        .student-info {
            flex: 1 1 0;
            font-size: 0.85em;
            color: var(--text-muted);
            background: #fffdf8;
            border-radius: 10px;
            border: 1px solid var(--border-soft);
            padding: 8px 10px;
        }
        .student-info-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--accent-dark);
        }
        .student-info-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }
        .student-info-row label {
            min-width: 55px;
        }
        .student-info-row input {
            flex: 1 1 auto;
        }

        /* ✅ 列印：只印 report，從 #printable-drafts 開始 */
        @media print {
            /* 1. 預設把所有東西隱藏 */
            body * {
                visibility: hidden;
            }

            /* 2. 只顯示報告區塊 */
            #printable-drafts,
            #printable-drafts * {
                visibility: visible;
            }

            /* 3. 讓報告從頁面最上方開始排版 */
            #printable-drafts {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0 10mm;
                box-sizing: border-box;
            }

            /* 每一份版本報告獨立一頁 */
            .printable {
                page-break-after: always;
            }
        }

        @media (max-width: 900px) {
            .version-layout {
                grid-template-columns: minmax(0, 1fr);
            }
            .version-actions {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        @media (max-width: 800px) {
            .prompt-row {
                flex-direction: column;
            }
        }
        @media (max-width: 600px) {
            .front-buttons { flex-direction: column; align-items: center; }
            body { padding: 16px 12px 40px; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goHome()">← <span>Back to Home</span></button>
    <h1 class="title">Shirley's AI Writing Coach</h1>
    <p class="subtitle">Educational practice & entertainment only · Elegant beige edition</p>
    <div class="disclaimer">
        <strong>This tool—"Shirley's AI Writing Coach"—is for educational practice and entertainment only.</strong><br>
        Focus on iterating with the feedback—practice drives progress!
    </div>
    <!-- Home -->
    <section class="section active front-page" id="home-section">
        <h2>Welcome! Choose Your Writing Adventure</h2>
        <p>Press a button below to enter the next level of your writing journey.</p>
        <div class="front-buttons">
            <button class="front-btn analysis-btn" onclick="enterLevel('analysis')">Writing Analysis Level</button>
            <button class="front-btn gists-btn" onclick="enterLevel('gists')">Gists for English Writing Level</button>
        </div>
    </section>
    <!-- Level 1 -->
    <section class="section" id="analysis-section">
        <div class="analysis-sticky">
            <div class="analysis-header-inner">
                <h2>Level 1: Writing Analysis / Feedback</h2>
                <p>Paste or upload your writing below. The AI will provide grammar corrections, rubric-based feedback, and scores.<br>
                   <strong>Important:</strong> Your essay must answer the writing prompt and stay on topic.</p>
                <button type="button" class="rubric-toggle-btn" onclick="toggleRubric()">
                    Show / hide rubric reminder
                </button>
                <div id="rubric-reminder" class="rubric-reminder" style="display:none;">
                    <h3>Rubric Reminder (for all drafts)</h3>
                    <p>Loading rubric...</p>
                </div>
                <div class="prompt-row">
                    <div class="prompt-main">
                        <label for="prompt-input"><strong>Writing prompt / question:</strong></label>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start;">
                            <textarea id="prompt-input" placeholder="Enter the writing task or question here..."></textarea>
                            <div style="flex: 0 0 200px;">
                                <input type="file" id="prompt-image-upload" accept="image/*" style="font-size:12px;margin-bottom:6px;">
                                <small>Optional: Add an image to the prompt</small>
                                <div id="prompt-image-preview" style="margin-top:8px; display:none;">
                                    <img id="prompt-preview-img" src="" alt="Prompt preview" style="max-width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="student-info">
                        <div class="student-info-title">Student Information</div>
                        <div class="student-info-row">
                            <label for="student-school">School</label>
                            <input type="text" id="student-school" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-class">Class</label>
                            <input type="text" id="student-class" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-seat">Seat No.</label>
                            <input type="text" id="student-seat" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-name">Name</label>
                            <input type="text" id="student-name" placeholder="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis-run">
                <div class="version-header-inline">
                    <span><strong>Current Draft Workspace</strong></span>
                    <span style="font-size:0.85em;">Use this row for each version. History is kept for printing.</span>
                </div>
                <div class="version-legend">
                    <span class="version-legend-item">
                        <span class="legend-color legend-v1"></span> Version 1 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v2"></span> Version 2 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v3"></span> Version 3 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v4"></span> Version 4 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v5"></span> Version 5 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v6"></span> Version 6 highlight style
                    </span>
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text (or OCR result)</h3>
                        <textarea id="input-text" placeholder="Paste your writing here, or upload a file / image to extract text..."></textarea>
                    </div>
                    <div class="version-col version-actions">
                        <div>
                            <strong style="font-size:0.9em;">Upload a file</strong>
                            <input
                                type="file"
                                id="file-upload-main"
                                accept=".txt,.pdf,.doc,.docx,image/*"
                            >
                            <small>Supports images (OCR), txt, pdf, doc / docx.</small>
                        </div>
                        <button onclick="analyzeWriting()">Analyze &amp; Feedback</button>
                        <button id="ref-btn" onclick="generateReferenceEssay()" style="display:none;">Generate reference essay</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea id="checked-text" placeholder="Corrected version will appear here. You can still edit it manually."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div id="output" class="output"></div>
        <div class="controls no-print" style="margin-top:16px;">
            <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
                <button onclick="printDrafts()">Print selected versions</button>
            </div>
        </div>
    </section>
    <!-- Level 2 -->
    <section class="section" id="gists-section">
        <h2>Level 2: Shirley's Gists for English Writing</h2>
        <p>Enhance your writing skills with these resources.</p>
        <div class="gist-area">
            <h3>1) All about Writing: Self-Designed Materials</h3>
            <div id="writing-materials">Loading materials...</div>
        </div>
        <div class="gist-area">
            <h3>2) Practice with a Topic</h3>
            <label for="topic-category-select"><strong>Topic Category:</strong></label>
            <select id="topic-category-select">
                <option value="">-- Choose a category --</option>
            </select>
            <label for="topic-select" style="margin-top:6px;"><strong>Choose a writing topic:</strong></label>
            <select id="topic-select">
                <option value="">-- Please choose a topic --</option>
            </select>
            <!-- Level 2: Prompt Image Upload -->
            <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;">
                <div style="flex:1; min-width:300px;">
                    <label><strong>Optional: Add an image to the topic (for inspiration)</strong></label>
                    <input type="file" id="topic-image-upload" accept="image/*" style="font-size:12px;margin-top:4px;">
                </div>
                <div style="flex:0 0 200px;">
                    <div id="topic-image-preview" style="margin-top:8px; display:none;">
                        <img id="topic-preview-img" src="" alt="Topic image preview" style="max-width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                    </div>
                </div>
            </div>
            <p style="margin-top:8px; font-size: 0.9em;">
                (Teachers can edit category & topics in the JavaScript topicCategories object.)
            </p>
            <div class="analysis-run no-print">
                <div class="version-header-inline">
                    <span><strong>Topic Practice Workspace</strong></span>
                    <span style="font-size:0.85em;">Same analysis flow as Level 1 (with file upload).</span>
                </div>
                <div class="version-legend">
                    <span class="version-legend-item">
                        <span class="legend-color legend-topic"></span> Topic draft highlight style
                    </span>
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text (or OCR result)</h3>
                        <textarea id="topic-text" placeholder="Write your essay here, or upload a file / image..."></textarea>
                    </div>
                    <div class="version-col version-actions">
                        <div>
                            <strong style="font-size:0.9em;">Upload a file</strong>
                            <input
                                type="file"
                                id="file-upload-topic"
                                accept=".txt,.pdf,.doc,.docx,image/*"
                            >
                            <small>Supports images (OCR), txt, pdf, doc / docx.</small>
                        </div>
                        <button onclick="analyzeTopic()">Analyze &amp; Feedback</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea id="topic-checked-text" placeholder="Corrected topic essay will appear here."></textarea>
                    </div>
                </div>
            </div>
            <div id="topic-output" class="output"></div>
            <div class="controls no-print" style="margin-top:16px;">
                <button onclick="printTopicDrafts()">Print selected topic versions</button>
            </div>
        </div>
    </section>
    <div id="printable-drafts"></div>
    <script>
        let currentLevel = 'home';
        let drafts = [];
        let rubricText = '';
        let rubricItems = [];
        let realDraftCount = 0;
        let topicReport = null;
        let promptImageBase64 = '';
        let topicImageBase64 = '';
        let topicDrafts = [];
        let topicRealDraftCount = 0;
        const topicCategories = {
            'Descriptive Writing': ['Describe your favorite holiday.'],
            'Personal Narrative': ['Explain a challenge you have overcome.'],
            'Opinion / Argumentative': ['Should students use smartphones in the classroom? Give your opinion and reasons.']
        };

        // ---------- Util ----------
        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '<')
                .replace(/>/g, '>')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // LanguageTool API
        async function checkWithLanguageTool(text) {
            const params = new URLSearchParams();
            params.append('text', text);
            params.append('language', 'en-US');
            const res = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            if (!res.ok) throw new Error('LanguageTool error: ' + res.status);
            return await res.json();
        }

        function findCapitalizationMatches(text) {
            const regex = /(^|[.!?]\s+)([a-z])/g;
            const matches = [];
            let m;
            while ((m = regex.exec(text)) !== null) {
                const offset = m.index + m[1].length;
                const length = 1;
                const wrongChar = m[2];
                matches.push({
                    offset,
                    length,
                    replacements: [{ value: wrongChar.toUpperCase() }],
                    message: 'Sentence should start with a capital letter.',
                    rule: {
                        issueType: 'grammar',
                        description: 'Capitalization at the beginning of a sentence'
                    }
                });
            }
            return matches;
        }

        function buildCorrectedText(text, matches) {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const replacement = (m.replacements && m.replacements[0])
                    ? m.replacements[0].value
                    : text.slice(start, end);
                result += text.slice(cursor, start) + replacement;
                cursor = end;
            }
            result += text.slice(cursor);
            return result;
        }

        function computePromptCoverage(text, promptOrTopic) {
            if (!promptOrTopic) {
                return { coverage: 1, matchedKeywords: [], totalKeywords: 0 };
            }
            const lowerPrompt = promptOrTopic.toLowerCase();
            const keywordCandidates = lowerPrompt.match(/[a-z]{4,}/g) || [];
            const uniqueKeywords = Array.from(new Set(keywordCandidates));
            const lowerText = text.toLowerCase();
            let matched = 0;
            const matchedWords = [];
            uniqueKeywords.forEach(w => {
                if (lowerText.includes(w)) {
                    matched++;
                    matchedWords.push(w);
                }
            });
            const coverage = uniqueKeywords.length ? matched / uniqueKeywords.length : 1;
            return { coverage, matchedKeywords: matchedWords, totalKeywords: uniqueKeywords.length };
        }

        function buildHighlightedHtml(text, matches, highlightClass = 'err') {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const original = text.slice(start, end);
                const tipBase = m.message || '';
                const suggestion = (m.replacements && m.replacements[0])
                    ? ' → ' + m.replacements[0].value
                    : '';
                const tip = escapeHtml(tipBase + suggestion);
                result += escapeHtml(text.slice(cursor, start));
                result += `<span class="${highlightClass}" title="${tip}">${escapeHtml(original)}</span>`;
                cursor = end;
            }
            result += escapeHtml(text.slice(cursor));
            return result;
        }

        function calculateScores(text, matches, options = {}) {
            const wordTokens = text.trim().split(/\s+/).filter(Boolean);
            const wordCount = wordTokens.length;
            const sentencesArr = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentences = sentencesArr.length || 1;
            const paragraphs = text.split(/\n{2,}/).filter(p => p.trim().length > 0).length || 1;
            const grammarMatches = matches.filter(m =>
                m.rule && (m.rule.issueType === 'grammar' || m.rule.issueType === 'misspelling')
            );
            const spellingMatches = matches.filter(m =>
                m.rule && m.rule.issueType === 'misspelling'
            );
            const styleMatches = matches.filter(m =>
                m.rule && m.rule.issueType === 'style'
            );
            const errorPer100 = wordCount ? (grammarMatches.length / wordCount) * 100 : grammarMatches.length;
            const promptOrTopic = options.prompt || options.topic || '';
            const coverageInfo = computePromptCoverage(text, promptOrTopic);
            const cov = coverageInfo.coverage;

            let structureScore = 3;
            if (paragraphs >= 3 && wordCount >= 120) structureScore = 5;
            else if (paragraphs >= 3 && wordCount >= 80) structureScore = 4;
            else if (paragraphs === 2 && wordCount >= 60) structureScore = 3;
            else if (paragraphs === 1 && wordCount >= 40) structureScore = 2;
            else structureScore = 1;

            const linkingWords = ['however','therefore','in addition','for example','for instance','on the other hand','because','although','since','as a result'];
            const lowerText = text.toLowerCase();
            let linkingCount = 0;
            linkingWords.forEach(w => {
                if (lowerText.includes(w)) linkingCount++;
            });
            let coherenceScore = 3;
            if (linkingCount >= 4) coherenceScore = 5;
            else if (linkingCount >= 2) coherenceScore = 4;
            else if (linkingCount === 1) coherenceScore = 3;
            else if (linkingCount === 0 && sentences >= 5) coherenceScore = 2;
            else coherenceScore = 2;

            let onTopicScore = 5;
            if (cov < 0.15) onTopicScore = 1;
            else if (cov < 0.3) onTopicScore = 2;
            else if (cov < 0.45) onTopicScore = 3;
            else if (cov < 0.6) onTopicScore = 4;
            coherenceScore = Math.min(coherenceScore, onTopicScore);

            let grammarScore = 3;
            if (errorPer100 <= 1) grammarScore = 5;
            else if (errorPer100 <= 3) grammarScore = 4;
            else if (errorPer100 <= 6) grammarScore = 3;
            else if (errorPer100 <= 10) grammarScore = 2;
            else grammarScore = 1;

            const types = new Set(wordTokens.map(w => w.toLowerCase().replace(/[^a-z']/g, '')));
            const typeTokenRatio = wordCount ? types.size / wordCount : 0;
            const simpleWords = ['good','nice','very','really','a lot','many','things','stuff'];
            let simpleCount = 0;
            simpleWords.forEach(w => {
                if (lowerText.includes(w)) simpleCount++;
            });
            let vocabScore = 3;
            if (typeTokenRatio > 0.6 && simpleCount <= 1) vocabScore = 5;
            else if (typeTokenRatio > 0.45 && simpleCount <= 3) vocabScore = 4;
            else if (typeTokenRatio > 0.3) vocabScore = 3;
            else if (typeTokenRatio > 0.2) vocabScore = 2;
            else vocabScore = 1;

            const total = structureScore + coherenceScore + grammarScore + vocabScore;
            return {
                structure: { label: 'Structure & Organization', score: structureScore, max: 5, reason: `Paragraphs: ${paragraphs}; Words: ${wordCount}.` },
                coherence: { label: 'Coherence, Cohesion & Relevance', score: coherenceScore, max: 5, reason: `Linking devices: ${linkingCount}; on-topic coverage ≈ ${(cov * 100).toFixed(0)}% of key prompt words.` },
                grammar: { label: 'Grammar Accuracy', score: grammarScore, max: 5, reason: `Approx. ${grammarMatches.length} grammar/spelling issues (~${errorPer100.toFixed(1)} per 100 words).` },
                vocabulary: { label: 'Vocabulary Range & Precision', score: vocabScore, max: 5, reason: `Type-token ratio ≈ ${(typeTokenRatio*100).toFixed(1)}%; simple/common words flagged: ${simpleCount}.` },
                total: { label: 'Total', score: total, max: 20 },
                meta: {
                    wordCount, sentences, paragraphs, grammarMatchesCount: grammarMatches.length,
                    spellingMatchesCount: spellingMatches.length, styleMatchesCount: styleMatches.length,
                    linkingCount, onTopicCoverage: cov, onTopicMatchedKeywords: coverageInfo.matchedKeywords,
                    onTopicTotalKeywords: coverageInfo.totalKeywords
                }
            };
        }

        function buildFeedback(text, matches, options = {}, scores) {
            const topic = options.topic || null;
            const prompt = options.prompt || null;
            const mode = options.mode || 'first';
            const prevScores = options.prevScores || null;
            const previousVersionLabel = options.previousVersionLabel || null;
            const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
            const sentencesArr = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentences = sentencesArr.length;
            const avgLen = sentences ? (wordCount / sentences).toFixed(1) : 'N/A';
            const paragraphs = text.split(/\n{2,}/).filter(p => p.trim().length > 0).length || 1;
            const grammarCount = matches.filter(m => m.rule && m.rule.issueType === 'grammar').length;
            const spellingCount = matches.filter(m => m.rule && m.rule.issueType === 'misspelling').length;
            const styleCount = matches.filter(m => m.rule && m.rule.issueType === 'style').length;
            const meta = scores && scores.meta ? scores.meta : null;
            let msg = '';
            if (prompt) msg += `Writing prompt:\n"${prompt}"\n\n`;
            if (topic) msg += `Topic:\n"${topic}"\n\n`;
            if (mode === 'first' || !prevScores) {
                if (scores) {
                    msg += '=== Rubric Scores (out of 5) ===\n';
                    msg += `- ${scores.structure.label}: ${scores.structure.score} / ${scores.structure.max}\n`;
                    msg += `  Reason: ${scores.structure.reason}\n`;
                    msg += `- ${scores.coherence.label}: ${scores.coherence.score} / ${scores.coherence.max}\n`;
                    msg += `  Reason: ${scores.coherence.reason}\n`;
                    msg += `- ${scores.grammar.label}: ${scores.grammar.score} / ${scores.grammar.max}\n`;
                    msg += `  Reason: ${scores.grammar.reason}\n`;
                    msg += `- ${scores.vocabulary.label}: ${scores.vocabulary.score} / ${scores.vocabulary.max}\n`;
                    msg += `  Reason: ${scores.vocabulary.reason}\n\n`;
                    msg += `>>> TOTAL SCORE: ${scores.total.score} / ${scores.total.max} <<<\n\n`;
                }
                msg += `Length & structure:\n`;
                msg += `- Paragraphs: ${paragraphs} (aim for at least 3: introduction, body, conclusion)\n`;
                msg += `- Words: ${wordCount}\n`;
                msg += `- Sentences: ${sentences}\n`;
                msg += `- Average words per sentence: ${avgLen}\n\n`;
                msg += `Issues detected:\n`;
                msg += `- Grammar: ${grammarCount}\n`;
                msg += `- Spelling: ${spellingCount}\n`;
                msg += `- Style / phrasing: ${styleCount}\n\n`;
                if (meta && meta.onTopicTotalKeywords > 0) {
                    const covPercent = (meta.onTopicCoverage * 100).toFixed(0);
                    msg += `Relevance to prompt/topic:\n`;
                    msg += `- About ${covPercent}% of key words/ideas from the prompt appear in your essay.\n`;
                    if (meta.onTopicCoverage < 0.3) {
                        msg += `- Your essay seems partly off-topic. Make sure each main paragraph responds directly to the question.\n`;
                    } else {
                        msg += `- Overall, you are mostly on-topic. Check if any paragraph drifts away from the main task.\n`;
                    }
                }
                const exampleLines = [];
                matches.slice(0, 5).forEach(m => {
                    const snippet = text.slice(m.offset, m.offset + m.length);
                    const repl = (m.replacements && m.replacements[0]) ? m.replacements[0].value : null;
                    const rule = m.rule && (m.rule.description || m.rule.issueType || '');
                    if (repl) {
                        exampleLines.push(`- "${snippet}" → "${repl}" (${rule})`);
                    } else {
                        exampleLines.push(`- "${snippet}" (${rule})`);
                    }
                });
                if (exampleLines.length > 0) {
                    msg += `\nExample grammar / wording issues:\n`;
                    msg += exampleLines.join('\n') + '\n';
                }
                msg += `\nSuggestions on structure & logic:\n`;
                msg += `- Make sure the first paragraph clearly introduces the topic and your main idea.\n`;
                msg += `- Each body paragraph should focus on ONE main point, supported by examples.\n`;
                msg += `- Use linking words (for example, however, therefore, in addition) to connect ideas.\n`;
                msg += `- End with a conclusion that summarizes the main points and reflects on the topic.\n`;
                if (prompt || topic) {
                    msg += `- Check that every paragraph directly responds to the prompt/topic, not just tells unrelated details.\n`;
                }
                msg += '\nSuggestions on language:\n';
                msg += `- Review highlighted grammar and spelling errors and rewrite the sentences.\n`;
                msg += `- Replace repeated simple words (good, nice, very) with more precise vocabulary when possible.\n`;
            } else {
                msg += `=== Targeted Feedback for This Version ===\n`;
                if (previousVersionLabel) msg += `(Compared with ${previousVersionLabel})\n\n`;
                const dims = ['structure','coherence','grammar','vocabulary'];
                const prettyNames = { structure: 'Structure & Organization', coherence: 'Coherence / Relevance', grammar: 'Grammar', vocabulary: 'Vocabulary' };
                const improvements = [], regressions = [], unchanged = [];
                dims.forEach(key => {
                    const newS = scores[key].score;
                    const oldS = prevScores[key].score;
                    if (newS > oldS) improvements.push(`${prettyNames[key]}: ${oldS} → ${newS}`);
                    else if (newS < oldS) regressions.push(`${prettyNames[key]}: ${oldS} → ${newS}`);
                    else unchanged.push(`${prettyNames[key]}: still at ${newS}`);
                });
                if (improvements.length) {
                    msg += `Areas of improvement:\n`;
                    improvements.forEach(line => msg += `- ${line}\n`);
                    msg += '\n';
                }
                if (regressions.length) {
                    msg += `Areas slightly weaker than last time:\n`;
                    regressions.forEach(line => msg += `- ${line}\n`);
                    msg += '\n';
                }
                const prevMeta = prevScores.meta || null;
                const metaNow = scores.meta || null;
                if (metaNow && prevMeta) {
                    const prevErrors = prevMeta.grammarMatchesCount + prevMeta.spellingMatchesCount;
                    const nowErrors = metaNow.grammarMatchesCount + metaNow.spellingMatchesCount;
                    const diff = prevErrors - nowErrors;
                    msg += `Grammar & spelling progress:\n`;
                    msg += `- Previous errors: ${prevErrors}\n`;
                    msg += `- Current errors: ${nowErrors}\n`;
                    if (diff > 0) msg += `→ Nice! You reduced about ${diff} grammar/spelling issues.\n`;
                    else if (diff < 0) msg += `→ Be careful: there are slightly more issues than the last draft.\n`;
                    else msg += `→ Number of issues is similar. Focus on correcting the highlighted ones.\n`;
                    msg += '\n';
                    if (metaNow.onTopicTotalKeywords > 0) {
                        const prevCov = (prevMeta.onTopicCoverage * 100).toFixed(0);
                        const nowCov = (metaNow.onTopicCoverage * 100).toFixed(0);
                        msg += `Relevance to prompt/topic:\n`;
                        msg += `- Previous on-topic coverage: ~${prevCov}% of key prompt words.\n`;
                        msg += `- Current on-topic coverage: ~${nowCov}%.\n`;
                        if (metaNow.onTopicCoverage > prevMeta.onTopicCoverage) {
                            msg += `→ Better connection to the prompt. Keep making each paragraph answer the question.\n`;
                        } else if (metaNow.onTopicCoverage < prevMeta.onTopicCoverage) {
                            msg += `→ Some parts may drift away from the prompt. Re-check each paragraph against the question.\n`;
                        } else {
                            msg += `→ Similar level of relevance. Make sure new details still support your main point.\n`;
                        }
                        msg += '\n';
                    }
                }
                const needWork = ['structure','coherence','grammar','vocabulary'].filter(d => scores[d].score < 4);
                if (needWork.length) {
                    msg += `Key areas to focus on next:\n`;
                    needWork.forEach(key => {
                        const sc = scores[key];
                        msg += `- ${sc.label}: now ${sc.score}/${sc.max}. ${sc.reason}\n`;
                    });
                    msg += '\n';
                }
                msg += `Short checklist for your next revision:\n`;
                msg += `- Re-read the writing prompt and underline the key words. Check if each body paragraph matches them.\n`;
                msg += `- Fix the remaining highlighted grammar and spelling errors.\n`;
                msg += `- Add 1–2 clear linking words between paragraphs (for example, however, as a result).\n`;
                msg += `- Replace very simple words with more precise ones where appropriate.\n`;
            }
            return msg;
        }

        async function loadRubric() {
            if (rubricText) return;
            try {
                const response = await fetch('https://ducj-creator.github.io/Shirley-AI-Writing/writing%20rubric.csv');
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true }).data;
                rubricItems = [];
                parsed.forEach(row => {
                    const crit = (row['Criteria'] || '').trim();
                    if (!crit) return;
                    const levels = {
                        1: (row['1 Point'] || '').trim(),
                        2: (row['2 Points'] || '').trim(),
                        3: (row['3 Points'] || '').trim(),
                        4: (row['4 Points'] || '').trim(),
                        5: (row['5 Points'] || '').trim()
                    };
                    rubricItems.push({ criteria: crit, levels });
                });
                if (rubricItems.length === 0) throw new Error('Empty rubric after parsing');
                rubricText = rubricItems.map(item => {
                    const lv3 = item.levels[3] ? `3 pts: ${item.levels[3]}` : '';
                    const lv4 = item.levels[4] ? `4 pts: ${item.levels[4]}` : '';
                    const lv5 = item.levels[5] ? `5 pts: ${item.levels[5]}` : '';
                    const parts = [lv3, lv4, lv5].filter(Boolean).join('\n');
                    return `- ${item.criteria}:\n${parts}`;
                }).join('\n');
                const rubricDiv = document.getElementById('rubric-reminder');
                if (rubricDiv) {
                    rubricDiv.innerHTML = `
                        <h3>Rubric Reminder (for all drafts)</h3>
                        <pre style="white-space: pre-wrap; font-size:0.9em;">${escapeHtml(rubricText)}</pre>
                    `;
                }
            } catch (e) {
                console.warn('Rubric parse failed, using default.', e);
                rubricItems = [
                    { criteria: 'Essay Structure', levels: { 3: 'Clear introduction, body, and conclusion.' } },
                    { criteria: 'Coherence & Cohesion', levels: { 3: 'Logical order and basic transitions.' } },
                    { criteria: 'Grammar Accuracy', levels: { 3: 'Some minor errors but meaning is clear.' } },
                    { criteria: 'Vocabulary Range & Precision', levels: { 3: 'Adequate vocabulary with some variety.' } }
                ];
                rubricText = rubricItems.map(i => `- ${i.criteria}: ${Object.values(i.levels)[0]}`).join('\n');
                const rubricDiv = document.getElementById('rubric-reminder');
                if (rubricDiv) {
                    rubricDiv.innerHTML = `
                        <h3>Rubric Reminder (default)</h3>
                        <pre style="white-space: pre-wrap; font-size:0.9em;">${escapeHtml(rubricText)}</pre>
                    `;
                }
            }
        }

        async function loadWritingMaterials() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing-materials.md');
                const md = await response.text();
                const container = document.getElementById('writing-materials');
                container.innerHTML = `
                    <div class="materials-grid">
                        <div class="material-card">
                            <h4>Writing Tips & Guidelines</h4>
                            <pre style="white-space: pre-wrap;">${escapeHtml(md)}</pre>
                        </div>
                        <div class="material-card">
                            <h4>Model Essays (coming soon)</h4>
                            <p>Teachers can place sample essays here in the future.</p>
                        </div>
                        <div class="material-card">
                            <h4>Idea Bank / Writing Materials (coming soon)</h4>
                            <p>Collect interesting ideas, vocabulary, or prompts for students.</p>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('writing-materials').innerHTML =
                    '<p>Place your self-designed materials in writing-materials.md in the repo and update the fetch URL.</p>';
            }
        }

        function toggleRubric() {
            const div = document.getElementById('rubric-reminder');
            if (!div) return;
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function enterLevel(level) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(level + '-section');
            if (target) target.classList.add('active');
            document.querySelector('.back-btn').classList.add('active');
            currentLevel = level;
            if (level === 'gists') {
                loadWritingMaterials();
                initTopicCategories();
            }
            if (level === 'analysis') loadRubric();
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            document.querySelector('.back-btn').classList.remove('active');
            currentLevel = 'home';
        }

        function updateReferenceButtonVisibility() {
            const btn = document.getElementById('ref-btn');
            if (!btn) return;
            btn.style.display = realDraftCount >= 2 ? 'inline-block' : 'none';
        }

        if (window['pdfjsLib']) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // ✅ 強化版 OCR：對 image 先放大＋灰階＋提高對比，再丟給 Tesseract
        function handleFileInput(file, targetTextareaId) {
            if (!file) return;
            const name = file.name.toLowerCase();
            const textarea = document.getElementById(targetTextareaId);
            if (!textarea) return;

            if (file.type.startsWith('image/')) {
                textarea.value = 'Reading text from image (OCR, enhanced)...';

                const reader = new FileReader();
                reader.onload = function(ev) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        const maxDim = 1600; // 盡量不要太小，提高手寫辨識機率
                        let width = img.width;
                        let height = img.height;
                        const scale = Math.min(maxDim / Math.max(width, height), 1);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);

                        canvas.width = width;
                        canvas.height = height;

                        // 畫上去
                        ctx.drawImage(img, 0, 0, width, height);

                        // 灰階 + 對比
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            // 灰階
                            let v = 0.299 * r + 0.587 * g + 0.114 * b;
                            // 調對比（1.3 可以依實際再微調）
                            v = (v - 128) * 1.3 + 128;
                            if (v < 0) v = 0;
                            if (v > 255) v = 255;
                            data[i] = data[i + 1] = data[i + 2] = v;
                        }
                        ctx.putImageData(imageData, 0, 0);

                        // 丟 Tesseract
                        Tesseract.recognize(
                            canvas,
                            'eng',
                            {
                                logger: m => console.log(m)
                            }
                        ).then(({ data }) => {
                            textarea.value = data.text || '';
                        }).catch(err => {
                            console.error(err);
                            textarea.value = '';
                            alert('Unable to recognize text from this image.');
                        });
                    };
                    img.onerror = function() {
                        textarea.value = '';
                        alert('Cannot load this image for OCR.');
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            } else if (name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = ev => {
                    textarea.value = ev.target.result;
                };
                reader.readAsText(file);
            } else if (name.endsWith('.pdf')) {
                textarea.value = 'Extracting text from PDF (first page)...';
                const reader = new FileReader();
                reader.onload = async ev => {
                    try {
                        const typedArray = new Uint8Array(ev.target.result);
                        const pdf = await pdfjsLib.getDocument({ typedArray }).promise;
                        const page = await pdf.getPage(1);
                        const content = await page.getTextContent();
                        const strings = content.items.map(item => item.str);
                        textarea.value = strings.join(' ');
                    } catch (e) {
                        console.error(e);
                        textarea.value = '';
                        alert('Unable to extract text from this PDF in the browser.');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (name.endsWith('.docx')) {
                textarea.value = 'Extracting text from DOCX...';
                const reader = new FileReader();
                reader.onload = ev => {
                    const arrayBuffer = ev.target.result;
                    mammoth.extractRawText({ arrayBuffer })
                        .then(result => {
                            textarea.value = result.value || '';
                        })
                        .catch(err => {
                            console.error(err);
                            textarea.value = '';
                            alert('Unable to extract text from this DOCX in the browser.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (name.endsWith('.doc')) {
                alert('Legacy .doc files are not fully supported in this browser-only version. Please convert to .docx or .pdf first.');
            } else {
                alert('Unsupported file type. Please use image / txt / pdf / doc / docx.');
            }
        }

        function getLastRealDraft() {
            for (let i = drafts.length - 1; i >= 0; i--) {
                if (!drafts[i].isReference) return drafts[i];
            }
            return null;
        }

        // ========== 圖片上傳處理 ==========
        document.getElementById('prompt-image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('prompt-image-preview');
            const img = document.getElementById('prompt-preview-img');
            if (!file) {
                promptImageBase64 = '';
                preview.style.display = 'none';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                const result = event.target.result;
                promptImageBase64 = result;
                img.src = result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('topic-image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('topic-image-preview');
            const img = document.getElementById('topic-preview-img');
            if (!file) {
                topicImageBase64 = '';
                preview.style.display = 'none';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                const result = event.target.result;
                topicImageBase64 = result;
                img.src = result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // ========== Level 1 ==========
        async function analyzeWriting() {
            const container = document.getElementById('output');
            const text = document.getElementById('input-text').value;
            const prompt = document.getElementById('prompt-input').value;
            if (!text.trim()) {
                alert('Please enter text.');
                return;
            }
            const tempDiv = document.createElement('div');
            tempDiv.className = 'analysis-run';
            tempDiv.innerHTML = '<em>Checking your writing... (grammar, capitalization, relevance to the prompt, rubric scores)</em>';
            container.prepend(tempDiv);
            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matchesLT = result.matches || [];
                const capMatches = findCapitalizationMatches(text);
                const allMatches = [...matchesLT, ...capMatches];
                const isFirstRealDraft = !getLastRealDraft();
                const prevDraft = isFirstRealDraft ? null : getLastRealDraft();
                const prevScores = prevDraft ? prevDraft.scores : null;
                const upcomingRealVersion = realDraftCount + 1;
                const colorIndex = ((upcomingRealVersion - 1) % 6) + 1;
                const highlightClass = `err err-v${colorIndex}`;
                const corrected = buildCorrectedText(text, allMatches);
                const highlighted = buildHighlightedHtml(text, allMatches, highlightClass);
                const scores = calculateScores(text, allMatches, { prompt });
                const feedbackText = buildFeedback(
                    text,
                    allMatches,
                    {
                        prompt,
                        mode: isFirstRealDraft ? 'first' : 'revision',
                        prevScores,
                        previousVersionLabel: prevDraft ? prevDraft.label : null
                    },
                    scores
                );
                realDraftCount += 1;
                const label = `Version ${realDraftCount}`;
                const index = drafts.length;
                drafts.push({
                    original: text,
                    corrected,
                    highlighted,
                    feedback: feedbackText,
                    scores,
                    meta: scores.meta,
                    label,
                    isReference: false
                });
                document.getElementById('checked-text').value = corrected;
                tempDiv.innerHTML = renderVersionBlock({
                    index,
                    label,
                    original: text,
                    corrected,
                    highlighted,
                    feedback: feedbackText,
                    scores,
                    isReference: false
                });
                updateReferenceButtonVisibility();
            } catch (err) {
                console.error(err);
                tempDiv.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        function buildVersionChip(label) {
            let cls = 'version-chip';
            const match = label.match(/Version\s+(\d+)/i);
            if (match) {
                const n = parseInt(match[1], 10);
                const idx = ((n - 1) % 6) + 1;
                cls += ' version-chip-v' + idx;
            } else if (/Reference Essay/i.test(label)) {
                cls += ' version-chip-ref';
            }
            return `<span class="${cls}">${escapeHtml(label)}</span>`;
        }

        function renderVersionBlock({ index, label, original, corrected, highlighted, feedback, scores, isReference }) {
            const scoreHtml = scores ? `
                <div class="scores-block">
                    <strong>Rubric scores (out of 5)</strong>
                    <ul>
                        <li>${escapeHtml(scores.structure.label)}: <strong>${scores.structure.score}/${scores.structure.max}</strong></li>
                        <li>${escapeHtml(scores.coherence.label)}: <strong>${scores.coherence.score}/${scores.coherence.max}</strong></li>
                        <li>${escapeHtml(scores.grammar.label)}: <strong>${scores.grammar.score}/${scores.grammar.max}</strong></li>
                        <li>${escapeHtml(scores.vocabulary.label)}: <strong>${scores.vocabulary.score}/${scores.vocabulary.max}</strong></li>
                    </ul>
                    <div><strong>Total: ${scores.total.score} / ${scores.total.max}</strong></div>
                </div>
            ` : '';
            const chipHtml = buildVersionChip(label);
            const checkboxHtml = isReference
                ? ''
                : `<label class="no-print" style="font-size:0.9em;">
                        <input type="checkbox" class="print-select" data-index="${index}">
                        Select this version for printing
                   </label>`;
            return `
                <div class="version-header-inline">
                    <span>${chipHtml}</span>
                    ${checkboxHtml}
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text</h3>
                        <textarea>${escapeHtml(original)}</textarea>
                    </div>
                    <div class="version-col version-actions">
                        <small>You can copy this text into the current workspace to create a new version.</small>
                        <button onclick="useVersionAsCurrent(${index})">Use as current draft</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea>${escapeHtml(corrected)}</textarea>
                    </div>
                </div>
                ${scoreHtml}
                <h3 style="margin-top:16px;font-size:0.95em;">Original with highlighted issues:</h3>
                <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                <div class="feedback">
                    <h3 style="margin-top:0;font-size:1em;">Feedback &amp; suggestions:</h3>
                    <pre style="white-space: pre-wrap;">${escapeHtml(feedback)}</pre>
                </div>
            `;
        }

        function useVersionAsCurrent(idx) {
            const draft = drafts[idx];
            if (!draft) return;
            document.getElementById('input-text').value = draft.corrected;
            document.getElementById('checked-text').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateReferenceEssay() {
            const lastRealDraft = getLastRealDraft();
            if (!lastRealDraft) {
                alert('Please run analysis at least once first.');
                return;
            }
            const container = document.getElementById('output');
            Array.from(container.querySelectorAll('.analysis-run[data-ref="true"]'))
                .forEach(el => el.remove());
            drafts = drafts.filter(d => !d.isReference);
            const div = document.createElement('div');
            div.className = 'analysis-run';
            div.dataset.ref = 'true';
            const referenceText =
                'This is a polished reference version based on your latest corrected draft:\n' +
                lastRealDraft.corrected;
            const feedbackText =
                'Reference essay notes:\n' +
                '- Use this version only as a model. Do NOT copy it directly.\n' +
                '- Compare it with your own draft and highlight what has improved in grammar, vocabulary, and structure.\n' +
                '- Try to write your OWN final version after reading this reference.\n';
            const index = drafts.length;
            const label = `Reference Essay (based on ${lastRealDraft.label})`;
            const scores = lastRealDraft.scores || null;
            drafts.push({
                original: lastRealDraft.corrected,
                corrected: referenceText,
                highlighted: escapeHtml(lastRealDraft.corrected),
                feedback: feedbackText,
                scores,
                meta: scores ? scores.meta : null,
                label,
                isReference: true
            });
            div.innerHTML = renderVersionBlock({
                index,
                label,
                original: lastRealDraft.corrected,
                corrected: referenceText,
                highlighted: escapeHtml(lastRealDraft.corrected),
                feedback: feedbackText,
                scores,
                isReference: true
            });
            container.prepend(div);
        }

        function printDrafts() {
            const allCheckboxes = Array.from(document.querySelectorAll('.print-select:checked'));
            if (allCheckboxes.length === 0) {
                alert('Please select at least one version to print.');
                return;
            }
            const selectedDrafts = allCheckboxes
                .map(cb => {
                    const idx = parseInt(cb.getAttribute('data-index'), 10);
                    return drafts[idx];
                })
                .filter(d => d && !d.isReference);
            if (selectedDrafts.length === 0) {
                alert('Reference essays are not included in the report. Please select at least one actual draft version.');
                return;
            }
            const school = document.getElementById('student-school')?.value || '';
            const klass = document.getElementById('student-class')?.value || '';
            const seat = document.getElementById('student-seat')?.value || '';
            const name = document.getElementById('student-name')?.value || '';
            const prompt = document.getElementById('prompt-input')?.value || '';
            const schoolEsc = escapeHtml(school || '________');
            const classEsc = escapeHtml(klass || '________');
            const seatEsc = escapeHtml(seat || '________');
            const nameEsc = escapeHtml(name || '________');
            const promptEsc = escapeHtml(prompt || '____________________________________________');
            const promptImageHtml = promptImageBase64
                ? `<p><img src="${promptImageBase64}" alt="Prompt illustration" style="max-width:100%; margin-top:10px; border-radius:6px;"></p>`
                : '';
            const headerHtml = `
                <div class="print-header">
                    <h1>A Writing Progress &amp; Product Report Generated by Shirley's AI Writing Coach</h1>
                    <p>School: ${schoolEsc} &nbsp;&nbsp; Class: ${classEsc} &nbsp;&nbsp; Seat No.: ${seatEsc} &nbsp;&nbsp; Name: ${nameEsc}</p>
                    <p><strong>Writing Prompt:</strong> ${promptEsc}</p>
                    ${promptImageHtml}
                </div>
            `;
            const draftsHtml = selectedDrafts.map(draft => {
                return `
                    <div class="printable">
                        <h2>${escapeHtml(draft.label || '')}</h2>
                        <h3>Original with highlighted issues:</h3>
                        <p>${draft.highlighted.replace(/\n/g, '<br>')}</p>
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(draft.feedback)}</pre>
                    </div>
                `;
            }).join('');
            let topicHtml = '';
            if (topicReport && topicReport.topic && topicReport.highlighted) {
                const topicImageHtml = topicImageBase64
                    ? `<p><img src="${topicImageBase64}" alt="Topic illustration" style="max-width:100%; margin-top:10px; border-radius:6px;"></p>`
                    : '';
                topicHtml = `
                    <div class="printable">
                        <h2>Topic Practice Essay</h2>
                        <p><strong>Topic:</strong> ${escapeHtml(topicReport.topic)}</p>
                        ${topicImageHtml}
                        <h3>Original with highlighted issues:</h3>
                        <p>${topicReport.highlighted.replace(/\n/g, '<br>')}</p>
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(topicReport.feedback)}</pre>
                    </div>
                `;
            }
            const printable = document.getElementById('printable-drafts');
            printable.innerHTML = headerHtml + draftsHtml + topicHtml;
            const bodyChildren = Array.from(document.body.children);
            const toHide = bodyChildren.filter(el => el !== printable);
            toHide.forEach(el => el.classList.add('no-print-temp'));
            printable.style.display = 'block';
            window.print();
            printable.style.display = 'none';
            toHide.forEach(el => el.classList.remove('no-print-temp'));
        }

        // ========== Level 2 ==========
        async function analyzeTopic() {
            const output = document.getElementById('topic-output');
            const topic = document.getElementById('topic-select').value;
            const text = document.getElementById('topic-text').value;
            if (!topic.trim() || !text.trim()) {
                alert('Please choose a topic and enter your essay.');
                return;
            }
            const tempDiv = document.createElement('div');
            tempDiv.className = 'analysis-run';
            tempDiv.innerHTML = '<em>Checking your essay for this topic (grammar, capitalization, relevance, rubric scores)...</em>';
            output.prepend(tempDiv);
            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matchesLT = result.matches || [];
                const capMatches = findCapitalizationMatches(text);
                const allMatches = [...matchesLT, ...capMatches];
                let prevTopicDraft = null;
                for (let i = topicDrafts.length - 1; i >= 0; i--) {
                    if (topicDrafts[i].topic === topic) {
                        prevTopicDraft = topicDrafts[i];
                        break;
                    }
                }
                const isFirstTopicDraft = !prevTopicDraft;
                const prevScores = prevTopicDraft ? prevTopicDraft.scores : null;
                const corrected = buildCorrectedText(text, allMatches);
                const highlighted = buildHighlightedHtml(text, allMatches, 'err err-topic');
                const scores = calculateScores(text, allMatches, { topic });
                const feedbackText = buildFeedback(
                    text,
                    allMatches,
                    {
                        topic,
                        mode: isFirstTopicDraft ? 'first' : 'revision',
                        prevScores,
                        previousVersionLabel: prevTopicDraft ? prevTopicDraft.label : null
                    },
                    scores
                );
                document.getElementById('topic-checked-text').value = corrected;
                topicRealDraftCount += 1;
                const label = `Topic Version ${topicRealDraftCount}`;
                const index = topicDrafts.length;
                topicDrafts.push({
                    topic,
                    original: text,
                    corrected,
                    highlighted,
                    feedback: feedbackText,
                    scores,
                    label
                });
                topicReport = {
                    topic,
                    corrected,
                    highlighted,
                    feedback: feedbackText,
                    scores
                };
                tempDiv.innerHTML = renderTopicVersionBlock({
                    index,
                    label,
                    topic,
                    original: text,
                    corrected,
                    highlighted,
                    feedback: feedbackText,
                    scores
                });
            } catch (err) {
                console.error(err);
                tempDiv.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        function renderTopicVersionBlock({ index, label, topic, original, corrected, highlighted, feedback, scores }) {
            const scoreHtml = scores ? `
                <div class="scores-block">
                    <strong>Rubric scores (out of 5)</strong>
                    <ul>
                        <li>${escapeHtml(scores.structure.label)}: <strong>${scores.structure.score}/${scores.structure.max}</strong></li>
                        <li>${escapeHtml(scores.coherence.label)}: <strong>${scores.coherence.score}/${scores.coherence.max}</strong></li>
                        <li>${escapeHtml(scores.grammar.label)}: <strong>${scores.grammar.score}/${scores.grammar.max}</strong></li>
                        <li>${escapeHtml(scores.vocabulary.label)}: <strong>${scores.vocabulary.score}/${scores.vocabulary.max}</strong></li>
                    </ul>
                    <div><strong>Total: ${scores.total.score} / ${scores.total.max}</strong></div>
                </div>
            ` : '';
            const chipHtml = buildVersionChip(label);
            return `
                <div class="version-header-inline">
                    <span>
                        ${chipHtml}
                        &nbsp;
                        <span style="font-size:0.85em;color:var(--text-muted);">
                            Topic: ${escapeHtml(topic)}
                        </span>
                    </span>
                    <label class="no-print" style="font-size:0.9em;">
                        <input type="checkbox" class="topic-print-select" data-index="${index}">
                        Select this topic version for printing
                    </label>
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text</h3>
                        <textarea>${escapeHtml(original)}</textarea>
                    </div>
                    <div class="version-col version-actions">
                        <small>You can copy this text into the current topic workspace to create a new version.</small>
                        <button onclick="useTopicVersionAsCurrent(${index})">Use as current topic draft</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea>${escapeHtml(corrected)}</textarea>
                    </div>
                </div>
                ${scoreHtml}
                <h3 style="margin-top:16px;font-size:0.95em;">Original with highlighted issues:</h3>
                <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                <div class="feedback">
                    <h3 style="margin-top:0;font-size:1em;">Feedback &amp; suggestions for this topic:</h3>
                    <pre style="white-space: pre-wrap;">${escapeHtml(feedback)}</pre>
                </div>
            `;
        }

        function useTopicVersionAsCurrent(idx) {
            const draft = topicDrafts[idx];
            if (!draft) return;
            document.getElementById('topic-text').value = draft.corrected;
            document.getElementById('topic-checked-text').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function printTopicDrafts() {
            const allCheckboxes = Array.from(document.querySelectorAll('.topic-print-select:checked'));
            if (allCheckboxes.length === 0) {
                alert('Please select at least one topic version to print.');
                return;
            }
            const selected = allCheckboxes
                .map(cb => {
                    const idx = parseInt(cb.getAttribute('data-index'), 10);
                    return topicDrafts[idx];
                })
                .filter(Boolean);
            if (selected.length === 0) {
                alert('No valid topic versions selected.');
                return;
            }
            const school = document.getElementById('student-school')?.value || '';
            const klass = document.getElementById('student-class')?.value || '';
            const seat = document.getElementById('student-seat')?.value || '';
            const name = document.getElementById('student-name')?.value || '';
            const schoolEsc = escapeHtml(school || '________');
            const classEsc = escapeHtml(klass || '________');
            const seatEsc = escapeHtml(seat || '________');
            const nameEsc = escapeHtml(name || '________');
            const topic = selected[0].topic || '';
            const topicEsc = escapeHtml(topic || '');
            const topicImageHtml = topicImageBase64
                ? `<p><img src="${topicImageBase64}" alt="Topic illustration" style="max-width:100%; margin-top:10px; border-radius:6px;"></p>`
                : '';
            const headerHtml = `
                <div class="print-header">
                    <h1>A Writing Progress &amp; Product Report Generated by Shirley's AI Writing Coach</h1>
                    <p>School: ${schoolEsc} &nbsp;&nbsp; Class: ${classEsc} &nbsp;&nbsp; Seat No.: ${seatEsc} &nbsp;&nbsp; Name: ${nameEsc}</p>
                    <p><strong>Level 2: Topic Practice</strong></p>
                    <p><strong>Topic:</strong> ${topicEsc}</p>
                    ${topicImageHtml}
                </div>
            `;
            const bodyHtml = selected.map(d => {
                return `
                    <div class="printable">
                        <h2>${escapeHtml(d.label || '')}</h2>
                        <h3>Original with highlighted issues:</h3>
                        <p>${d.highlighted.replace(/\n/g, '<br>')}</p>
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(d.feedback)}</pre>
                    </div>
                `;
            }).join('');
            const printable = document.getElementById('printable-drafts');
            printable.innerHTML = headerHtml + bodyHtml;
            const bodyChildren = Array.from(document.body.children);
            const toHide = bodyChildren.filter(el => el !== printable);
            toHide.forEach(el => el.classList.add('no-print-temp'));
            printable.style.display = 'block';
            window.print();
            printable.style.display = 'none';
            toHide.forEach(el => el.classList.remove('no-print-temp'));
        }

        function initTopicCategories() {
            const catSelect = document.getElementById('topic-category-select');
            const topicSelect = document.getElementById('topic-select');
            if (!catSelect || !topicSelect) return;
            catSelect.innerHTML = '<option value="">-- Choose a category --</option>';
            Object.keys(topicCategories).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                catSelect.appendChild(opt);
            });
            topicSelect.innerHTML = '<option value="">-- Please choose a topic --</option>';
            catSelect.addEventListener('change', () => {
                const cat = catSelect.value;
                topicSelect.innerHTML = '<option value="">-- Please choose a topic --</option>';
                if (!cat || !topicCategories[cat]) return;
                topicCategories[cat].forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    topicSelect.appendChild(opt);
                });
            });
        }

        document.getElementById('file-upload-main').addEventListener('change', e => {
            const file = e.target.files[0];
            handleFileInput(file, 'input-text');
        });
        document.getElementById('file-upload-topic').addEventListener('change', e => {
            const file = e.target.files[0];
            handleFileInput(file, 'topic-text');
        });

        // Expose functions to global scope
        window.enterLevel = enterLevel;
        window.goHome = goHome;
        window.analyzeWriting = analyzeWriting;
        window.printDrafts = printDrafts;
        window.analyzeTopic = analyzeTopic;
        window.generateReferenceEssay = generateReferenceEssay;
        window.useVersionAsCurrent = useVersionAsCurrent;
        window.toggleRubric = toggleRubric;
        window.useTopicVersionAsCurrent = useTopicVersionAsCurrent;
        window.printTopicDrafts = printTopicDrafts;

        // Init on load
        loadWritingMaterials();
        loadRubric();
        initTopicCategories();
    </script>
</body>
</html>
