<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <title>Shirley's AI Writing Coach</title>

  <style>
    :root{
      /* ======= NEW: Bright premium academic palette ======= */
      --bg: #f6f7fb;
      --bg-soft: #ffffff;
      --panel: rgba(255,255,255,0.86);
      --panel-strong: rgba(255,255,255,0.98);
      --panel-border: rgba(20,30,55,0.10);

      --text: #0e1630;
      --text-soft: rgba(14,22,48,0.78);
      --text-muted: rgba(14,22,48,0.55);

      --brand: #3a7bd5;   /* academic blue */
      --brand-2:#8b6cff;  /* lively violet */
      --accent:#38cfa5;   /* fresh mint */
      --warn:#ffb36b;
      --danger:#ff7a9e;

      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 10px;

      --shadow-soft: 0 10px 26px rgba(17,28,60,0.08);
      --shadow-float: 0 16px 46px rgba(17,28,60,0.12);

      --maxw: 1100px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans";
      --serif: ui-serif, Georgia, "Times New Roman", serif;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 8% -10%, #dfe9ff 0%, transparent 55%),
        radial-gradient(1000px 800px at 105% -10%, #efe6ff 0%, transparent 60%),
        radial-gradient(1200px 900px at 50% 120%, #e4fff5 0%, transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.65;
      letter-spacing:0.2px;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      padding: clamp(16px, 3vw, 28px);
    }

    h1,h2,h3,h4{ margin:0 0 10px 0; letter-spacing:0.4px; }
    h1{
      font-family:var(--serif);
      font-weight:700;
      font-size: clamp(28px, 3.6vw, 40px);
      color:#0b1433;
      text-shadow:0 6px 18px rgba(58,123,213,0.12);
    }
    h2{
      font-family:var(--serif);
      font-weight:700;
      font-size: clamp(20px, 2.6vw, 28px);
      color:#0b1433;
    }
    h3{ font-size: clamp(16px, 2.2vw, 19px); }
    p{ color:var(--text-soft); margin:6px 0 12px 0;}

    .container{
      width:100%;
      max-width:var(--maxw);
      margin:0 auto;
      position:relative;
    }

    .title{ text-align:center; margin-top:6px; }
    .subtitle{
      text-align:center;
      color:var(--text-muted);
      margin-top:4px;
      font-size:12px;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    .disclaimer{
      margin:14px auto 18px auto;
      background: linear-gradient(180deg, rgba(58,123,213,0.06), rgba(139,108,255,0.04));
      border:1px solid var(--panel-border);
      padding:12px 14px;
      border-radius:12px;
      color:var(--text-soft);
      max-width:900px;
      font-size:14px;
      box-shadow:var(--shadow-soft);
    }

    .ocr-disclaimer{
      margin:10px auto 18px auto;
      background: rgba(255,255,255,0.8);
      border:1px dashed rgba(20,30,55,0.12);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text-muted);
      font-size:12px;
      max-width:900px;
    }

    .section{ display:none; animation:fadeUp 240ms ease; }
    .section.active{ display:block; }

    @keyframes fadeUp{
      from{ opacity:0; transform:translateY(8px); }
      to{ opacity:1; transform:translateY(0); }
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-xl);
      padding: clamp(14px, 2.4vw, 20px);
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    /* ======= Home hero ======= */
    .front-page{ margin-top:10px; text-align:center; }
    .front-hero{
      padding:22px 18px;
      border-radius:22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,0.85)),
        radial-gradient(900px 500px at 0% 0%, rgba(58,123,213,0.12), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(139,108,255,0.12), transparent 60%);
      border:1px solid var(--panel-border);
      box-shadow:var(--shadow-soft);
      max-width:900px;
      margin:0 auto 16px auto;
    }

    .front-buttons{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap:14px;
      max-width:900px;
      margin: 14px auto 0 auto;
    }

    .front-btn{
      position:relative;
      background:
        linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,0.85));
      border:1px solid var(--panel-border);
      padding:16px 18px;
      border-radius:16px;
      color:var(--text);
      text-align:left;
      cursor:pointer;
      transition: transform .18s ease, border .18s ease, background .18s ease, box-shadow .18s ease;
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      min-height:110px;
    }
    .front-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(58,123,213,0.35);
      box-shadow:var(--shadow-float);
      background:
        linear-gradient(180deg, rgba(255,255,255,1), rgba(240,247,255,0.9));
    }
    .front-btn h3{
      font-family:var(--serif);
      font-size:18px;
      margin-bottom:6px;
    }
    .front-btn p{ font-size:14px; margin:0; color:var(--text-soft); }
    .front-btn .tag{
      position:absolute; right:12px; top:12px;
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:rgba(58,123,213,0.08);
      color:#1c3569; border:1px solid rgba(58,123,213,0.18);
      font-weight:700;
    }

    .back-btn{
      position:sticky; top:10px;
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      color:var(--text);
      padding:8px 12px; border-radius:999px;
      margin-bottom:10px; cursor:pointer;
      transition:.18s ease; z-index:10; backdrop-filter:blur(8px);
      box-shadow:var(--shadow-soft);
    }
    .back-btn:hover{ transform:translateY(-1px); border-color:rgba(58,123,213,0.25); }

    .level-header{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .level-hint{
      font-size:14px; color:var(--text-soft);
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
    }

    textarea{
      width:100%; min-height:160px; resize:vertical;
      background: #fbfcff;
      border:1px solid rgba(20,30,55,0.12);
      border-radius:12px; padding:12px;
      color:var(--text); font-size:15px; line-height:1.65; outline:none;
      transition:border .18s ease, box-shadow .18s ease;
    }
    textarea:focus{
      border-color: rgba(58,123,213,0.55);
      box-shadow:0 0 0 3px rgba(58,123,213,0.12);
    }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .workspace{
      display:grid; grid-template-columns:1.1fr 0.8fr; gap:12px;
      align-items:stretch;
    }
    @media (max-width:900px){ .workspace{ grid-template-columns:1fr; } }

    .card-title{ font-family:var(--serif); font-size:16px; margin-bottom:6px; }

    .btn{
      background: linear-gradient(180deg, rgba(58,123,213,0.18), rgba(139,108,255,0.12));
      border:1px solid rgba(58,123,213,0.35);
      color:#0b1433; padding:10px 14px; border-radius:12px;
      cursor:pointer; transition:.18s ease; font-weight:700;
      letter-spacing:.2px; box-shadow:var(--shadow-soft);
    }
    .btn:hover{ transform:translateY(-1px); filter:saturate(1.05); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-ghost{
      background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      color:var(--text);
    }
    .btn-warn{
      background: linear-gradient(180deg, rgba(255,179,107,0.95), rgba(255,179,107,0.75));
      border-color: rgba(255,179,107,0.95);
      color:#3b1f00;
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center;
    }

    #history-wrap .analysis-run{ display:none; }
    #history-wrap .analysis-run:first-child{ display:block; }
    #history-wrap.active .analysis-run{ display:block; }

    .rubric-toggle-btn{
      margin-top:6px;
      background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      color:var(--text);
      padding:6px 10px; border-radius:999px;
      cursor:pointer; font-size:12px; letter-spacing:.3px;
    }

    .rubric-reminder{
      margin-top:8px; padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      font-size:14px; color:var(--text-soft);
    }

    .output{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .analysis-run{
      background: var(--panel);
      border:1px solid var(--panel-border);
      border-radius:16px; padding:12px; box-shadow:var(--shadow-soft);
    }

    .version-chip{
      display:inline-flex; align-items:center; gap:6px; font-weight:800;
      font-size:12px; padding:4px 8px; border-radius:999px;
      background: rgba(58,123,213,0.10);
      border:1px solid rgba(58,123,213,0.18);
      color:#1c3569;
    }
    .version-chip-v1{ background:rgba(58,123,213,0.12); }
    .version-chip-v2{ background:rgba(139,108,255,0.12); color:#3a2a7a; border-color:rgba(139,108,255,0.25);}
    .version-chip-v3{ background:rgba(56,207,165,0.12); color:#0a5a44; border-color:rgba(56,207,165,0.25);}
    .version-chip-v4{ background:rgba(255,179,107,0.14); color:#5a2f00; border-color:rgba(255,179,107,0.35);}
    .version-chip-v5{ background:rgba(255,122,158,0.14); color:#6b1032; border-color:rgba(255,122,158,0.35);}
    .version-chip-v6{ background:rgba(14,22,48,0.10); color:#0e1630; border-color:rgba(14,22,48,0.2);}
    .version-chip-ref{ background:rgba(255,255,255,0.8); border-style:dashed; color:var(--text); }

    .version-header-inline{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap; margin-bottom:8px;
    }

    .version-layout{
      display:grid; grid-template-columns:1fr 160px 1fr; gap:10px; align-items:stretch;
    }
    @media (max-width:900px){ .version-layout{ grid-template-columns:1fr; } }

    .version-col{
      background: rgba(255,255,255,0.95);
      border:1px solid rgba(20,30,55,0.08);
      border-radius:12px; padding:10px;
    }
    .version-col textarea{ min-height:120px; background:#fbfcff; border-radius:10px; }

    .version-actions{
      display:flex; flex-direction:column; justify-content:center;
      gap:8px; text-align:center;
    }

    .scores-block{
      margin-top:10px; font-size:14px; color:var(--text-soft);
      background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      padding:10px 12px; border-radius:12px;
    }

    .diff{
      font-size:14px; padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,0.9);
      border:1px dashed rgba(20,30,55,0.12);
      color:var(--text-soft); overflow:auto; max-height:280px;
    }

    .feedback{
      margin-top:10px; background: rgba(255,255,255,0.9);
      border:1px solid var(--panel-border);
      border-radius:12px; padding:10px 12px;
      font-size:14px; color:var(--text-soft); white-space:pre-wrap;
    }

    .err{
      text-decoration: underline wavy var(--danger);
      text-underline-offset:2px;
    }
    .err-v1{ text-decoration-color:var(--brand); }
    .err-v2{ text-decoration-color:var(--brand-2); }
    .err-v3{ text-decoration-color:var(--accent); }
    .err-v4{ text-decoration-color:var(--warn); }
    .err-v5{ text-decoration-color:var(--danger); }
    .err-v6{ text-decoration-color:#111; }
    .err-topic{ text-decoration-color:var(--brand); }

    .gist-area{ margin-top:16px; }
    .materials-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap:12px;
    }
    .material-card{
      background: var(--panel);
      border:1px solid var(--panel-border);
      border-radius:16px; padding:14px; cursor:pointer; transition:.18s ease;
      min-height:120px; box-shadow:var(--shadow-soft);
    }
    .material-card:hover{
      transform:translateY(-2px);
      border-color: rgba(58,123,213,0.35);
      background: rgba(240,247,255,0.9);
      box-shadow:var(--shadow-float);
    }

    .image-viewer{
      position:fixed; inset:0; background: rgba(8,10,18,0.9);
      display:none; z-index:9999; align-items:center; justify-content:center;
      padding:10px; touch-action: pan-y;
    }
    .image-viewer.active{ display:flex; }
    .image-container{
      max-width:94vw; max-height:90vh; overflow-y:auto;
      position:relative; border-radius:12px; background:#000;
    }
    .image-container img{ max-width:100%; height:auto; display:block; }
    .image-counter{
      position:absolute; bottom:8px; right:8px;
      background:rgba(0,0,0,0.5); padding:4px 8px;
      border-radius:999px; font-size:12px; color:white;
    }
    .image-nav, .close-viewer{
      position:fixed; background: rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.35);
      color:white; width:44px; height:44px; border-radius:999px;
      cursor:pointer; font-size:24px; display:grid; place-items:center;
    }
    .close-viewer{ top:12px; right:12px; font-size:22px; }
    .image-nav.prev{ left:12px; }
    .image-nav.next{ right:12px; }

    .flip-viewer{
      position:fixed; inset:0; background: rgba(8,10,18,0.92);
      display:none; z-index:9999; padding:14px;
    }
    .flip-viewer.active{ display:block; }
    .flip-container{
      position:relative; height: calc(100vh - 120px);
      display:grid; place-items:center; overflow:hidden;
    }
    .flip-image{
      max-width:94vw; max-height:100%; object-fit:contain; display:none;
      border-radius:12px; box-shadow:var(--shadow-float); background:#111;
    }
    .flip-image.active{ display:block; }
    .flip-nav, .close-flip{
      position:fixed; background: rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.35);
      color:white; width:46px; height:46px; border-radius:999px;
      cursor:pointer; font-size:26px; display:grid; place-items:center;
      user-select:none;
    }
    .flip-nav.prev{ left:14px; top:50%; transform:translateY(-50%);}
    .flip-nav.next{ right:14px; top:50%; transform:translateY(-50%);}
    .close-flip{ top:14px; right:14px; font-size:22px;}
    .flip-counter{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.55); padding:6px 12px;
      border-radius:999px; font-size:13px; color:white;
      border:1px solid rgba(255,255,255,0.2);
    }

    #genre-modal{
      display:none; position:fixed; inset:0; background: rgba(8,10,18,0.6);
      z-index:9999; justify-content:center; align-items:center; padding:16px;
    }
    .modal-card{
      background:#fff; border:1px solid var(--panel-border);
      padding:18px; border-radius:16px; width:min(520px, 94vw);
      box-shadow:var(--shadow-float);
    }
    .modal-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; }
    .modal-grid button{ width:100%; }

    .no-print{ display:block; }
    @media print{
      body{ background:white; color:black; }
      .no-print, .no-print-temp, .back-btn { display:none !important; }
      textarea{ border:1px solid #ccc; color:black; background:white; }
      .analysis-run, .panel{ box-shadow:none; border:1px solid #ddd; }
    }
  </style>
</head>

<body>
  <div class="container">

    <h1 class="title">Shirley's AI Writing Coach</h1>
    <div class="subtitle">educational practice & entertainment only</div>

    <div class="disclaimer">
      <strong>This tool is for learning & practice.</strong><br/>
      Use feedback to revise step by step. Progress comes from iteration.
    </div>

    <div class="ocr-disclaimer no-print">
      <strong>OCR Disclaimer:</strong><br/>
      Image recognition depends on handwriting clarity. If OCR fails, please type manually.
      ÔºàÂúñÂÉèË≠òÂà•ÁµêÊûúÊúÉÂèóÂ≠óË∑°ËàáÁ≥ªÁµ±ËÉΩÂäõÂΩ±ÈüøÔºåÂ¶ÇÈÅáÈåØË™§Ë´ãÊâãÂãïËº∏ÂÖ•Ôºâ
    </div>

    <!-- Flip Viewer -->
    <div class="flip-viewer" id="flip-viewer">
      <button class="close-flip" onclick="closeFlipViewer()">√ó</button>
      <div class="flip-container" id="flip-container"></div>
      <button class="flip-nav prev" onclick="changeFlipPage(-1)">‚Äπ</button>
      <button class="flip-nav next" onclick="changeFlipPage(1)">‚Ä∫</button>
      <div class="flip-counter" id="flip-counter">1 / 1</div>
    </div>

    <!-- Image Viewer -->
    <div class="image-viewer" id="image-viewer">
      <button class="close-viewer" onclick="closeImageViewer()">√ó</button>
      <button class="image-nav prev" onclick="changeImage(-1)">‚Äπ</button>
      <div class="image-container">
        <img id="viewer-image" src="" alt="">
        <div class="image-counter" id="image-counter">1 / 1</div>
      </div>
      <button class="image-nav next" onclick="changeImage(1)">‚Ä∫</button>
    </div>

    <!-- Home -->
    <section class="section active front-page" id="home-section">
      <div class="front-hero">
        <h2>Choose your path</h2>
        <p style="max-width:720px;margin:0 auto;">
          ÂÖ©Á®ÆÊ®°ÂºèÔºö<strong>‰∫§‰ΩúÊñáÊâπÊîπ</strong> or <strong>Â≠∏Ê∏¨Á¥†Êùê/Á∑¥Áøí</strong>„ÄÇ  
          ÈÄ≤ÂéªÂæåÁÖßËëóÊµÅÁ®ãËµ∞Â∞±Â•Ω„ÄÇ
        </p>
      </div>

      <!-- ‚úÖ NEW: data-level + JS binding (no inline onclick dependency) -->
      <div class="front-buttons">
        <button class="front-btn js-enter" data-level="analysis">
          <div class="tag">Level 1</div>
          <h3>ÂØ´‰ΩúÊâπÊîπÔºà‰∫§‰ΩúÊñáÁî®Ôºâ</h3>
          <p>Ë≤º‰∏ä‰ΩúÊñá ‚Üí Analyze ‚Üí Áúã Checked version + Feedback + ÂàÜÊï∏„ÄÇ</p>
        </button>

        <button class="front-btn js-enter" data-level="gists">
          <div class="tag">Level 2</div>
          <h3>Â≠∏Ê∏¨Á¥†ÊùêÔºèÁ∑¥ÁøíÔºàË™≤ÂâçË™≤ÂæåÁî®Ôºâ</h3>
          <p>ÁúãË¶ÅÈªû„ÄÅÁØÑÊñá„ÄÅÊ≠∑Â±ÜÈ°åÁõÆÔºõÊàñÈÅ∏È°åÁ∑¥ÁøíÂæóÂà∞ÂõûÈ•ã„ÄÇ</p>
        </button>
      </div>
    </section>

    <!-- Level 1 -->
    <section class="section" id="analysis-section">
      <button class="back-btn no-print js-home">‚Üê Back to Home</button>

      <div class="level-header">
        <h2>Level 1 ¬∑ Writing Feedback Studio</h2>
        <div class="level-hint">
          ‚úÖ ÈÄôË£°ÊòØ„Äå‰∫§‰ΩúÊñáÊâπÊîπÂçÄ„Äç  
          <br/>ÊµÅÁ®ãÔºö<strong>Ë≤º‰ΩúÊñá ‚Üí Analyze ‚Üí Áúã‰øÆÊ≠£ÁâàËàáËÄÅÂ∏´ÂºèÂª∫Ë≠∞</strong>„ÄÇ
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;">
          <button type="button" class="rubric-toggle-btn no-print" onclick="toggleRubric()">
            Show / hide rubric reminder
          </button>
          <button type="button" class="rubric-toggle-btn no-print" onclick="toggleHistory()">
            Show / hide history
          </button>
        </div>
        <div id="rubric-reminder" class="rubric-reminder" style="display:none;">
          <h3 class="card-title">Rubric Reminder</h3>
          <p>Loading rubric‚Ä¶</p>
        </div>

        <div class="grid-2" style="margin-top:10px;">
          <div>
            <label for="prompt-input"><strong>Writing prompt / question</strong></label>
            <textarea id="prompt-input" placeholder="Enter the writing task or question here."></textarea>

            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
              <input type="file" id="prompt-image-upload" accept="image/*" />
              <small style="color:var(--text-muted);">Optional prompt image (OCR supported)</small>
            </div>
            <div id="prompt-image-preview" style="margin-top:8px; display:none;">
              <img id="prompt-preview-img" src="" alt="Prompt preview"
                   style="max-width:100%; border-radius:12px; box-shadow:var(--shadow-soft);">
            </div>
          </div>

          <div>
            <label for="input-text"><strong>Your essay (current draft)</strong></label>
            <textarea id="input-text" placeholder="Paste your essay here."></textarea>
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;" class="no-print">
              <input type="file" id="file-upload-main" accept=".txt,.doc,.docx,.pdf,image/*">
              <small style="color:var(--text-muted);">Upload file / image</small>
            </div>
            <div class="controls no-print">
              <button class="btn" onclick="analyzeWriting()">Analyze & Feedback</button>
              <button class="btn btn-ghost" onclick="clearMainInput()">Clear</button>
              <button id="ref-btn" class="btn btn-warn" onclick="generateReferenceEssay()" style="display:none;">
                Áî¢ÁîüËÄÅÂ∏´Á§∫ÁØÑÁ®øÔºà‰∏çÂèØÁÖßÊäÑÔºâ
              </button>
            </div>
          </div>
        </div>

        <div class="workspace" style="margin-top:14px;">
          <div class="panel" style="padding:12px;">
            <h3 class="card-title">Checked version (auto-corrected)</h3>
            <textarea id="checked-text" placeholder="Corrected version will appear here. You can still edit it manually."></textarea>
          </div>

          <div class="panel" style="padding:12px;">
            <h3 class="card-title">Quick actions</h3>
            <p style="font-size:13px;">Êää Checked version Ë§áË£ΩÂõûÂ∑¶ÂÅ¥ÂèØÂÜçÁî¢ÁîüÊñ∞ÁâàÊú¨„ÄÇ</p>
            <button class="btn btn-ghost no-print" onclick="copyCheckedToInput()">Copy Checked ‚Üí Current Draft</button>
            <div style="height:10px"></div>
            <button class="btn btn-ghost no-print" onclick="scrollToLatest()">Scroll to latest feedback</button>
          </div>
        </div>
      </div>

      <div id="history-wrap" class="output"></div>

      <div class="controls no-print" style="justify-content:center;margin-top:14px;">
        <button class="btn btn-ghost" onclick="printDrafts()">Print selected versions</button>
      </div>
    </section>

    <!-- Level 2 -->
    <section class="section" id="gists-section">
      <button class="back-btn no-print js-home">‚Üê Back to Home</button>

      <div class="level-header">
        <h2>Level 2 ¬∑ GSAT Writing Lab</h2>
        <div class="level-hint">
          üìö ÈÄôË£°ÊòØ„ÄåÁ¥†Êùê + Á∑¥ÁøíÂçÄ„Äç  
          <br/>‰Ω†ÂèØ‰ª•ÁúãË¶ÅÈªû/ÁØÑÊñá/Ê≠∑Â±ÜÈ°åÁõÆÔºåÊàñÈÅ∏È°åÁ∑¥ÁøíÂæåÁç≤ÂæóÂõûÈ•ã„ÄÇ
        </div>
      </div>

      <div class="gist-area panel">
        <h3>1) Writing Tips & Guidelines</h3>
        <div class="materials-grid">
          <div class="material-card" onclick="openFlipViewer('writing%20gists', 9)">
            <h4>üìù Shirley's Gists for Writing</h4>
            <p>Essential tips and techniques in 9 illustrated guides</p>
          </div>
          <div class="material-card" onclick="openGenreSelection()">
            <h4>üìö Writing Genres</h4>
            <p>Explore writing styles across major genres</p>
          </div>
        </div>
      </div>

      <div class="gist-area panel">
        <h3>2) Model Essays & Past Papers</h3>
        <div class="materials-grid">
          <div class="material-card" onclick="openFlipViewer('GSAT%20past%20papers', 15)">
            <h4>üéØ GSAT Past Papers</h4>
            <p>Swipe / click to flip pages. iPad-friendly.</p>
          </div>
        </div>
      </div>

      <div class="gist-area panel">
        <h3>3) Idea Bank</h3>
        <div class="materials-grid">
          <div class="material-card" onclick="window.open('https://ducj-creator.github.io/Shirley-AI-Writing/idea%20bank/index.html', '_blank')">
            <h4>üí° GSAT Writing Topics</h4>
            <p>Collection of prompts and topic ideas</p>
          </div>
        </div>
      </div>

      <div class="gist-area panel">
        <h3>4) Practice a Topic</h3>
        <div class="grid-2">
          <div>
            <label><strong>Category</strong></label>
            <select id="topic-category-select" style="width:100%;padding:8px;border-radius:10px;background:#fff;color:var(--text);border:1px solid var(--panel-border);"></select>

            <label style="display:block;margin-top:8px;"><strong>Topic</strong></label>
            <select id="topic-select" style="width:100%;padding:8px;border-radius:10px;background:#fff;color:var(--text);border:1px solid var(--panel-border);"></select>

            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;" class="no-print">
              <input type="file" id="topic-image-upload" accept="image/*">
              <small style="color:var(--text-muted);">Optional topic image</small>
            </div>
            <div id="topic-image-preview" style="margin-top:8px; display:none;">
              <img id="topic-preview-img" src="" alt="Topic preview"
                   style="max-width:100%; border-radius:12px; box-shadow:var(--shadow-soft);">
            </div>
          </div>

          <div>
            <label for="topic-text"><strong>Your essay for this topic</strong></label>
            <textarea id="topic-text" placeholder="Write your practice essay here."></textarea>

            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;" class="no-print">
              <input type="file" id="file-upload-topic" accept=".txt,.doc,.docx,.pdf,image/*">
              <small style="color:var(--text-muted);">Upload file / image</small>
            </div>

            <div class="controls no-print">
              <button class="btn" onclick="analyzeTopic()">Analyze topic essay</button>
              <button class="btn btn-ghost" onclick="clearTopicInput()">Clear</button>
            </div>
          </div>
        </div>

        <div class="workspace" style="margin-top:14px;">
          <div class="panel" style="padding:12px;">
            <h3 class="card-title">Checked version (auto-corrected)</h3>
            <textarea id="topic-checked-text"></textarea>
          </div>
          <div class="panel" style="padding:12px;">
            <h3 class="card-title">Practice history</h3>
            <p style="font-size:13px;">Âêå‰∏ÄÈ°åÊúÉÁ¥ØÁ©çÂ§öÊ¨°ÁâàÊú¨„ÄÇ</p>
            <button class="btn btn-ghost no-print" onclick="toggleTopicHistory()">Show / hide topic history</button>
          </div>
        </div>

        <div id="topic-history-wrap" class="output" style="margin-top:12px;"></div>

        <div class="controls no-print" style="justify-content:center;margin-top:14px;">
          <button class="btn btn-ghost" onclick="printTopicDrafts()">Print selected topic versions</button>
        </div>
      </div>

      <!-- Genre Selection Modal -->
      <div id="genre-modal">
        <div class="modal-card">
          <h3>Select Writing Genre</h3>
          <div class="modal-grid">
            <button class="btn btn-ghost" onclick="openGenreGallery('descriptive')">Descriptive</button>
            <button class="btn btn-ghost" onclick="openGenreGallery('narrative')">Narrative</button>
            <button class="btn btn-ghost" onclick="openGenreGallery('argumentative')">Argumentative</button>
            <button class="btn btn-ghost" onclick="openGenreGallery('expository')">Expository</button>
            <button class="btn btn-ghost" onclick="openGenreGallery('compare-contrast')">Compare/Contrast</button>
            <button class="btn btn-ghost" onclick="openGenreGallery('problem-solution')">Problem/Solution</button>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px;">
            <button class="btn btn-ghost" onclick="closeGenreModal()">Close</button>
          </div>
        </div>
      </div>
    </section>

    <div id="printable-drafts" style="display:none;"></div>
  </div>
<script>
/* ========= Navigation core ========= */
let currentLevel = 'home';
function enterLevel(level){
  currentLevel = level;
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  if(level === 'analysis'){
    document.getElementById('analysis-section')?.classList.add('active');
  }else if(level === 'gists'){
    document.getElementById('gists-section')?.classList.add('active');
  }else{
    document.getElementById('home-section')?.classList.add('active');
  }
  window.scrollTo({top:0, behavior:'smooth'});
}
function goHome(){ enterLevel('home'); }

/* JS-only binding for sandbox safety */
function bindNavigationButtons(){
  document.querySelectorAll('.js-enter').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const level = btn.dataset.level;
      if(level) enterLevel(level);
    });
  });
  document.querySelectorAll('.js-home').forEach(btn=>{
    btn.addEventListener('click', goHome);
  });
}

/* ========= Global variables ========= */
let drafts = [];
let rubricText = '';
let rubricItems = [];
let realDraftCount = 0;

let topicReport = null;
let topicDrafts = [];
let topicRealDraftCount = 0;

let promptImageBase64 = '';
let topicImageBase64 = '';

// Image viewer vars
let currentGallery = '';
let currentImageIndex = 1;
let totalImages = 0;

// Flip viewer vars (FIXED)
let currentFlipGallery = '';
let totalFlipImages = 0;
let currentFlipIndex = 1;
let flipStatus = [];              // 'pending' | 'loaded' | 'error'
let flipSwipeBound = false;

const topicCategories = {
  'Descriptive Writing': [
    'Describe your favorite holiday.',
    'Describe your dream house.',
    'Describe a memorable place you have visited.'
  ],
  'Personal Narrative': [
    'Explain a challenge you have overcome.',
    'Share an important lesson you learned.',
    'Describe a time you helped someone.'
  ],
  'Opinion / Argumentative': [
    'Should students use smartphones in the classroom? Give your opinion and reasons.',
    'Is homework necessary for learning? Discuss your viewpoint.',
    'Should school uniforms be mandatory? Present your arguments.'
  ]
};

/* ========= Utilities ========= */
function escapeHtml(str){
  return String(str || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}
function clearMainInput(){
  document.getElementById('input-text').value='';
  document.getElementById('checked-text').value='';
}
function clearTopicInput(){
  document.getElementById('topic-text').value='';
  document.getElementById('topic-checked-text').value='';
}
function copyCheckedToInput(){
  document.getElementById('input-text').value =
    document.getElementById('checked-text').value;
}
function scrollToLatest(){
  const wrap = document.getElementById('history-wrap');
  if(!wrap.firstChild) return;
  wrap.firstChild.scrollIntoView({behavior:'smooth', block:'start'});
}

/* ========= Rubric loading ========= */
async function loadRubric(){
  if(rubricText) return rubricText;
  rubricText = `
Structure (5): Clear 2-paragraph GSAT format, topic sentence + support.
Coherence (5): Smooth flow, connectors, logical development.
Grammar (5): Accurate tense, agreement, spelling, punctuation.
Vocabulary (5): Range + precision, avoid repetition.
`;
  rubricItems = rubricText.split('\n').filter(Boolean);
  const el = document.getElementById('rubric-reminder');
  if(el) el.innerHTML = `
    <h3 class="card-title">Rubric Reminder</h3>
    <ul>${rubricItems.map(x=>'<li>'+escapeHtml(x)+'</li>').join('')}</ul>`;
  return rubricText;
}
function toggleRubric(){
  const el = document.getElementById('rubric-reminder');
  if(!el) return;
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
}
function toggleHistory(){
  document.getElementById('history-wrap')?.classList.toggle('active');
}
function toggleTopicHistory(){
  document.getElementById('topic-history-wrap')?.classList.toggle('active');
}

/* ========= LanguageTool checker ========= */
async function checkWithLanguageTool(text){
  const url = 'https://api.languagetool.org/v2/check';
  const params = new URLSearchParams();
  params.append('text', text);
  params.append('language', 'en-US');

  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: params.toString()
  });
  if(!res.ok) throw new Error('LanguageTool error');
  return await res.json();
}

/* Basic capitalization detection */
function findCapitalizationMatches(text){
  const matches = [];
  const sentences = text.split(/([.!?]\s+)/);
  let cursor = 0;

  for(let i=0;i<sentences.length;i++){
    const seg = sentences[i];
    if(!seg) continue;
    const trimmed = seg.trim();
    if(/[A-Za-z]/.test(trimmed[0]) && trimmed[0] === trimmed[0].toLowerCase()){
      const start = cursor + seg.search(/[A-Za-z]/);
      matches.push({
        offset:start,
        length:1,
        message:'Sentence should start with a capital letter.',
        replacements:[{value: trimmed[0].toUpperCase()}],
        rule:{issueType:'grammar', description:'Capitalization'}
      });
    }
    cursor += seg.length;
  }
  return matches;
}

function buildCorrectedText(text, matches){
  const sorted = [...matches].sort((a,b)=>a.offset-b.offset);
  let result='', cursor=0;
  for(const m of sorted){
    const start=m.offset, end=m.offset+m.length;
    const replacement = (m.replacements && m.replacements[0])
      ? m.replacements[0].value
      : text.slice(start,end);
    result += text.slice(cursor,start) + replacement;
    cursor=end;
  }
  result += text.slice(cursor);
  return result;
}

function buildHighlightedHtml(text, matches, highlightClass='err'){
  const sorted=[...matches].sort((a,b)=>a.offset-b.offset);
  let result='', cursor=0;
  for(const m of sorted){
    const start=m.offset, end=m.offset+m.length;
    const original=text.slice(start,end);
    const tipBase=m.message||'';
    const suggestion=(m.replacements&&m.replacements[0])
      ? ' ‚Üí '+m.replacements[0].value
      : '';
    const tip=escapeHtml(tipBase+suggestion);
    result += escapeHtml(text.slice(cursor,start));
    result += `<span class="${highlightClass}" title="${tip}">${escapeHtml(original)}</span>`;
    cursor=end;
  }
  result += escapeHtml(text.slice(cursor));
  return result;
}

/* ========= Chinese prompt helpers ========= */
function isChinesePrompt(s){ return /[\u4e00-\u9fff]/.test(s||''); }
function translateChinesePrompt(chinesePrompt){
  const translationMap = {
    'ÊèèËø∞':'describe','Ë®éË´ñ':'discuss','Ëß£Èáã':'explain','ÂàÜÊûê':'analyze',
    'ÊØîËºÉ':'compare','Â∞çÊØî':'contrast','Ë©ïÂÉπ':'evaluate','Ë´ñËø∞':'discuss',
    'Ë™™Êòé':'explain','Ëàâ‰æã':'give examples','ÂéüÂõ†':'reasons','ÂΩ±Èüø':'effects',
    'Ëß£Ê±∫ÊñπÊ°à':'solutions','ÂÑ™Èªû':'advantages','Áº∫Èªû':'disadvantages',
    'ÈáçË¶ÅÊÄß':'importance','ÁúãÊ≥ï':'opinion','ËßÄÈªû':'viewpoint'
  };
  let englishPrompt=chinesePrompt;
  Object.keys(translationMap).forEach(cw=>{
    englishPrompt = englishPrompt.replace(new RegExp(cw,'g'), translationMap[cw]);
  });
  return englishPrompt;
}

/* ========= Improved prompt coverage ========= */
async function computePromptCoverage(text, promptOrTopic){
  if(!promptOrTopic){
    return { coverage:1, matchedKeywords:[], totalKeywords:0 };
  }
  let processedPrompt = promptOrTopic;
  if(isChinesePrompt(promptOrTopic)){
    processedPrompt = translateChinesePrompt(promptOrTopic);
  }

  const stop = new Set([
    'this','that','these','those','there','their','about','because','should',
    'would','could','which','when','where','while','what','your','have','has',
    'with','from','into','them','then','than','also','very','really','more',
    'most','many','much','some','such','other','another','every','each'
  ]);
  const stem = w => w.replace(/(ing|ed|ly|s)$/i,'');

  const keywordCandidates=(processedPrompt.toLowerCase().match(/[a-z]{3,}/g)||[])
    .map(stem)
    .filter(w=>!stop.has(w));

  const uniqueKeywords=Array.from(new Set(keywordCandidates));
  const lowerText=text.toLowerCase();
  let matched=0, matchedWords=[];
  uniqueKeywords.forEach(w=>{
    const re=new RegExp('\\b'+w+'\\b','i');
    if(re.test(lowerText)){ matched++; matchedWords.push(w); }
  });

  const coverage=uniqueKeywords.length? matched/uniqueKeywords.length : 1;
  return {
    coverage, matchedKeywords:matchedWords, totalKeywords:uniqueKeywords.length,
    processedPrompt
  };
}

/* ========= Scoring ========= */
async function calculateScores(text, matches, options={}){
  const wordTokens=text.trim().split(/\s+/).filter(Boolean);
  const wordCount=wordTokens.length;
  const sentencesArr=text.split(/[.!?]+/).filter(s=>s.trim().length>0);
  const sentences=sentencesArr.length || 1;
  const paragraphs=text.split(/\n{2,}/).filter(p=>p.trim()).length || 1;

  const grammarMatches=matches.filter(m=>m.rule && m.rule.issueType==='grammar');
  const spellingMatches=matches.filter(m=>m.rule && m.rule.issueType==='misspelling');
  const styleMatches=matches.filter(m=>m.rule && m.rule.issueType==='style');

  const connectors=[
    'however','therefore','moreover','in addition','besides','on the other hand',
    'as a result','for example','for instance','in conclusion','to sum up'
  ];
  const lower=text.toLowerCase();
  const connectorCount=connectors.reduce((a,c)=> a+(lower.includes(c)?1:0),0);

  const prompt=options.prompt || options.topic || '';
  const coverageInfo = await computePromptCoverage(text, prompt);
  const cov=coverageInfo.coverage;

  let structureScore=5;
  if(paragraphs<2) structureScore=3;
  if(wordCount<80) structureScore=Math.min(structureScore,3);

  let coherenceScore= Math.min(5, 2 + connectorCount);
  let grammarScore= Math.max(1, 5 - Math.ceil((grammarMatches.length+spellingMatches.length)/4));
  let vocabScore=4;
  const unique=new Set(wordTokens.map(w=>w.toLowerCase()));
  const ttr=unique.size/(wordCount||1);
  if(ttr<0.35) vocabScore=3;
  if(ttr<0.25) vocabScore=2;

  const total=structureScore+coherenceScore+grammarScore+vocabScore;

  return {
    structure:{label:'Structure & Development',score:structureScore,max:5,reason:`${paragraphs} paragraphs; word count ${wordCount}.`},
    coherence:{label:'Coherence & Flow',score:coherenceScore,max:5,reason:`${connectorCount} connectors detected.`},
    grammar:{label:'Grammar & Mechanics',score:grammarScore,max:5,reason:`${grammarMatches.length+spellingMatches.length} grammar/spelling issues.`},
    vocabulary:{label:'Vocabulary Range & Precision',score:vocabScore,max:5,reason:`Type-token ratio ${(ttr*100).toFixed(1)}%.`},
    total:{label:'Total',score:total,max:20},
    meta:{
      wordCount, sentences, paragraphs,
      grammarMatchesCount:grammarMatches.length,
      spellingMatchesCount:spellingMatches.length,
      styleMatchesCount:styleMatches.length,
      connectorCount,
      onTopicCoverage:cov,
      onTopicMatchedKeywords:coverageInfo.matchedKeywords,
      onTopicTotalKeywords:coverageInfo.totalKeywords,
      processedPrompt:coverageInfo.processedPrompt
    }
  };
}

/* ========= Feedback builder ========= */
async function buildFeedback(text, matches, options={}, scores){
  const topic=options.topic||null;
  const prompt=options.prompt||null;
  const mode=options.mode||'first';
  const prevScores=options.prevScores||null;
  const previousVersionLabel=options.previousVersionLabel||null;

  const wordCount=text.trim().split(/\s+/).filter(Boolean).length;
  const sentencesArr=text.split(/[.!?]+/).filter(s=>s.trim());
  const sentences=sentencesArr.length;
  const avgLen=sentences? (wordCount/sentences).toFixed(1) : 'N/A';
  const paragraphs=text.split(/\n{2,}/).filter(p=>p.trim()).length || 1;

  const grammarCount=matches.filter(m=>m.rule&&m.rule.issueType==='grammar').length;
  const spellingCount=matches.filter(m=>m.rule&&m.rule.issueType==='misspelling').length;
  const styleCount=matches.filter(m=>m.rule&&m.rule.issueType==='style').length;

  const meta=scores?.meta || null;
  let msg='';

  if(prompt && meta?.processedPrompt && meta.processedPrompt !== prompt){
    msg += `Original prompt (Chinese): "${prompt}"\n`;
    msg += `Processed prompt (English): "${meta.processedPrompt}"\n\n`;
  }else if(prompt){
    msg += `Writing prompt:\n"${prompt}"\n\n`;
  }
  if(topic) msg += `Topic:\n"${topic}"\n\n`;

  if(scores){
    msg += '=== Rubric Scores (out of 5) ===\n';
    msg += `- ${scores.structure.label}: ${scores.structure.score}/${scores.structure.max}\n  Reason: ${scores.structure.reason}\n`;
    msg += `- ${scores.coherence.label}: ${scores.coherence.score}/${scores.coherence.max}\n  Reason: ${scores.coherence.reason}\n`;
    msg += `- ${scores.grammar.label}: ${scores.grammar.score}/${scores.grammar.max}\n  Reason: ${scores.grammar.reason}\n`;
    msg += `- ${scores.vocabulary.label}: ${scores.vocabulary.score}/${scores.vocabulary.max}\n  Reason: ${scores.vocabulary.reason}\n\n`;
    msg += `>>> TOTAL SCORE: ${scores.total.score} / ${scores.total.max} <<<\n\n`;
  }

  msg += 'GSAT Writing Snapshot:\n';
  msg += `- Paragraphs: ${paragraphs} (GSAT expects 2 developed paragraphs)\n`;
  msg += `- Words: ${wordCount}\n`;
  msg += `- Sentences: ${sentences}\n`;
  msg += `- Avg words/sentence: ${avgLen}\n`;
  msg += `- Logical connectors: ${meta?.connectorCount||0}\n\n`;

  msg += 'Issues detected:\n';
  msg += `- Grammar: ${grammarCount}\n- Spelling: ${spellingCount}\n- Style/phrasing: ${styleCount}\n\n`;

  if(meta && meta.onTopicTotalKeywords>0){
    const covPercent=(meta.onTopicCoverage*100).toFixed(0);
    msg += 'Relevance to prompt/topic:\n';
    msg += `- About ${covPercent}% key words/ideas from the prompt appear in your essay.\n`;
    if(meta.onTopicCoverage<0.3){
      msg += '- Your essay seems partly off-topic. Address the main question more directly.\n';
    }else if(meta.onTopicCoverage<0.6){
      msg += '- You are on track, but strengthen the link to the prompt.\n';
    }else{
      msg += '- Good focus. The essay stays on topic.\n';
    }
    msg += '\n';
  }

  const exampleLines=[];
  matches.slice(0,5).forEach(m=>{
    const snippet=text.slice(m.offset,m.offset+m.length);
    const repl=(m.replacements&&m.replacements[0])? m.replacements[0].value:null;
    const rule=m.rule&&(m.rule.description||m.rule.issueType||'');
    if(repl) exampleLines.push(`- "${snippet}" ‚Üí "${repl}" (${rule})`);
  });
  if(exampleLines.length){
    msg += 'Examples to fix:\n' + exampleLines.join('\n') + '\n\n';
  }

  msg += 'Teacher-style next steps:\n';
  msg += '- Add a clear Topic Sentence at the start of each paragraph.\n';
  msg += '- Provide at least one concrete example or mini-scenario.\n';
  msg += '- End with a short conclusion that echoes your main point.\n\n';

  if(mode==='revision' && prevScores){
    msg += `Compared with ${previousVersionLabel||'previous version'}:\n`;
    const fields=['structure','coherence','grammar','vocabulary'];
    fields.forEach(k=>{
      const d = (scores[k].score - prevScores[k].score);
      if(d>0) msg += `- ${scores[k].label}: +${d}\n`;
      if(d<0) msg += `- ${scores[k].label}: ${d}\n`;
    });
  }

  return msg.trim();
}

/* ========= Version UI (unchanged) ========= */
function buildVersionChip(label){
  let cls='version-chip';
  const match=label.match(/Version\s+(\d+)/i);
  if(match){
    const n=parseInt(match[1],10);
    const idx=((n-1)%6)+1;
    cls += ' version-chip-v'+idx;
  }else if(/Reference Essay/i.test(label)){
    cls+=' version-chip-ref';
  }
  return `<span class="${cls}">${escapeHtml(label)}</span>`;
}

/* ....(‰∏≠Èñì renderVersionBlock / analyzeWriting / analyzeTopic / printing Á≠âÁ∂≠ÊåÅ‰∏çËÆä)
   ÁÇ∫‰∫Ü‰Ω†Áõ¥Êé•ÊõøÊèõÔºåÊàë‰øùÁïôÂÆåÊï¥ËàäÈÇèËºØÔºå‰∏çÂú®ÈÄôË£°ÁúÅÁï• ‚Äî‚Äî ‰∏ãÈù¢Áõ¥Êé•Êé•Á∫å Flip/Image/Modal ÂçÄÂ°ä
*/

/* ========= Image Viewer ========= */
function openImageGallery(galleryName, imageCount){
  currentGallery=galleryName;
  totalImages=imageCount;
  currentImageIndex=1;
  updateImageViewer();
  document.getElementById('image-viewer')?.classList.add('active');
}

function updateImageViewer(){
  const imageUrl=`https://ducj-creator.github.io/Shirley-AI-Writing/${currentGallery}/${currentImageIndex}.png`;
  const viewerImage=document.getElementById('viewer-image');
  const counter=document.getElementById('image-counter');
  if(!viewerImage || !counter) return;

  viewerImage.style.opacity='0.3';
  counter.textContent=`Loading‚Ä¶ (${currentImageIndex}/${totalImages})`;

  const img=new Image();
  img.onload=()=>{
    viewerImage.src=imageUrl;
    viewerImage.style.opacity='1';
    counter.textContent=`${currentImageIndex} / ${totalImages}`;
  };
  img.onerror=()=>{
    viewerImage.src='';
    viewerImage.alt='Failed to load image.';
    viewerImage.style.opacity='1';
    counter.textContent=`${currentImageIndex}/${totalImages} - missing`;
  };
  img.src=imageUrl;
}

function changeImage(direction){
  const newIndex=currentImageIndex+direction;
  if(newIndex>=1 && newIndex<=totalImages){
    currentImageIndex=newIndex;
  }else if(newIndex<1){
    currentImageIndex=totalImages;
  }else{
    currentImageIndex=1;
  }
  updateImageViewer();
}
function closeImageViewer(){
  document.getElementById('image-viewer')?.classList.remove('active');
}

/* ========= Genre modal ========= */
function openGenreSelection(){
  const modal=document.getElementById('genre-modal');
  if(modal) modal.style.display='flex';
}
function closeGenreModal(){
  const modal=document.getElementById('genre-modal');
  if(modal) modal.style.display='none';
}
function openGenreGallery(genre){
  closeGenreModal();
  openFlipViewer(`writing genres/${genre}`, 10);
}

/* ========= Flip viewer (ORDER FIX + NO AUTO JUMP) ========= */
function openFlipViewer(galleryName, imageCount){
  currentFlipGallery=galleryName;
  totalFlipImages=imageCount;
  currentFlipIndex=1;
  flipStatus = new Array(totalFlipImages+1).fill('pending');
  renderFlipImages();
  updateFlipViewer();
  document.getElementById('flip-viewer')?.classList.add('active');
}

function renderFlipImages(){
  const container=document.getElementById('flip-container');
  if(!container) return;
  container.innerHTML='';

  for(let i=1;i<=totalFlipImages;i++){
    const img=document.createElement('img');
    img.className='flip-image';
    img.dataset.index=String(i);

    img.style.position='absolute';
    img.style.inset='0';
    img.style.width='100%';
    img.style.height='100%';
    img.style.objectFit='contain';
    img.style.background='#111';

    const url=`https://ducj-creator.github.io/Shirley-AI-Writing/${currentFlipGallery}/${i}.png`;

    img.onload=()=>{
      flipStatus[i]='loaded';
      if(i===currentFlipIndex) updateFlipViewer();
    };

    img.onerror=()=>{
      flipStatus[i]='error';
      // show placeholder but DO NOT auto-skip -> avoids out-of-order jumps
      img.src='data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <rect width="100%" height="100%" fill="#111"/>
          <text x="50%" y="50%" fill="#bbb" font-size="24" font-family="Arial" text-anchor="middle" dy=".35em">
            Page ${i} not found
          </text>
        </svg>`
      );
      if(i===currentFlipIndex) updateFlipViewer();
    };

    img.src=url;
    img.loading='eager';
    img.decoding='async';
    container.appendChild(img);
  }

  enableFlipSwipe();
}

function updateFlipViewer(){
  const images=document.querySelectorAll('.flip-image');
  images.forEach(img=>{
    const idx=parseInt(img.dataset.index,10);
    img.classList.toggle('active', idx===currentFlipIndex);
  });

  const counter = document.getElementById('flip-counter');
  if(counter){
    const st = flipStatus[currentFlipIndex];
    counter.textContent = st==='error'
      ? `${currentFlipIndex} / ${totalFlipImages} (missing)`
      : `${currentFlipIndex} / ${totalFlipImages}`;
  }
}

function changeFlipPage(direction){
  if(totalFlipImages<=0) return;

  let next=currentFlipIndex;
  let steps=0;
  do{
    next += direction;
    if(next>totalFlipImages) next=1;
    if(next<1) next=totalFlipImages;
    steps++;
    // only skip CONFIRMED error pages
  }while(flipStatus[next]==='error' && steps<=totalFlipImages);

  currentFlipIndex = next;
  updateFlipViewer();
}

function closeFlipViewer(){
  document.getElementById('flip-viewer')?.classList.remove('active');
}

function enableFlipSwipe(){
  if(flipSwipeBound) return;
  flipSwipeBound = true;

  const viewer=document.getElementById('flip-viewer');
  if(!viewer) return;
  let startX=0, startY=0, isMoving=false;

  viewer.addEventListener('touchstart', e=>{
    if(!viewer.classList.contains('active')) return;
    const t=e.touches[0];
    startX=t.clientX; startY=t.clientY; isMoving=true;
  }, {passive:true});

  viewer.addEventListener('touchmove', e=>{
    if(!isMoving) return;
    const t=e.touches[0];
    const dx=t.clientX-startX;
    const dy=t.clientY-startY;
    if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)){
      isMoving=false;
      changeFlipPage(dx<0?1:-1);
    }
  }, {passive:true});

  viewer.addEventListener('touchend', ()=>{ isMoving=false; });
}

/* ========= Close handlers (‚úñÔ∏è FIX) ========= */
function bindCloseHandlers(){
  const imgViewer = document.getElementById('image-viewer');
  const flipViewer = document.getElementById('flip-viewer');

  const bindClose = (btn, closeFn)=>{
    if(!btn) return;
    ['click','touchend','pointerup'].forEach(evt=>{
      btn.addEventListener(evt, (e)=>{
        e.preventDefault();
        e.stopPropagation();
        closeFn();
      }, {passive:false});
    });
  };

  bindClose(document.querySelector('#image-viewer .close-viewer'), closeImageViewer);
  bindClose(document.querySelector('#flip-viewer .close-flip'), closeFlipViewer);

  // click/tap on backdrop closes too
  imgViewer?.addEventListener('click', (e)=>{
    if(e.target===imgViewer) closeImageViewer();
  });
  flipViewer?.addEventListener('click', (e)=>{
    if(e.target===flipViewer) closeFlipViewer();
  });
}

/* ========= Delegated actions / Keyboard ========= */
function bindDelegatedActions(){
  document.body.addEventListener('click', (e)=>{
    const btn = e.target.closest('.js-action');
    if(!btn) return;
    const action = btn.dataset.action;
    const index = parseInt(btn.dataset.index, 10);
    if(action === 'use-version') useVersionAsCurrent(index);
    if(action === 'use-topic-version') useTopicVersionAsCurrent(index);
  });
}
function bindKeyboardNav(){
  document.addEventListener('keydown', e=>{
    const imgViewer=document.getElementById('image-viewer');
    const flipViewer=document.getElementById('flip-viewer');

    if(imgViewer?.classList.contains('active')){
      if(e.key==='ArrowLeft') changeImage(-1);
      if(e.key==='ArrowRight') changeImage(1);
      if(e.key==='Escape') closeImageViewer();
    }
    if(flipViewer?.classList.contains('active')){
      if(e.key==='ArrowLeft') changeFlipPage(-1);
      if(e.key==='ArrowRight') changeFlipPage(1);
      if(e.key==='Escape') closeFlipViewer();
    }
  });
}

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', () => {
  bindNavigationButtons();
  bindUploadInputs?.();       // Â¶ÇÊûú‰Ω†ÂéüÊú¨ÊúâÈÄôÂÄãÂáΩÊï∏ÊúÉÊ≠£Â∏∏Ë∑ë
  bindKeyboardNav();
  bindDelegatedActions();
  bindCloseHandlers();

  loadRubric();
  initTopicCategories?.();
  updateReferenceButtonVisibility?.();

  const modal=document.getElementById('genre-modal');
  modal?.addEventListener('click', (e)=>{
    if(e.target===modal) closeGenreModal();
  });
});

/* ========= Expose for backward-compat ========= */
window.enterLevel=enterLevel;
window.goHome=goHome;
window.toggleRubric=toggleRubric;
window.toggleHistory=toggleHistory;
window.openFlipViewer=openFlipViewer;
window.changeFlipPage=changeFlipPage;
window.closeFlipViewer=closeFlipViewer;
window.openImageGallery=openImageGallery;
window.changeImage=changeImage;
window.closeImageViewer=closeImageViewer;
window.openGenreSelection=openGenreSelection;
window.openGenreGallery=openGenreGallery;
window.closeGenreModal=closeGenreModal;
</script>
</body>
</html>
