<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>
    <!-- diff / csv parser -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- OCR / PDF / DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --bg-main: #f6efe5;
            --bg-card: #fbf7f0;
            --bg-front: #f0e2c9;
            --accent: #c39a6b;
            --accent-dark: #8b5e34;
            --accent-soft: #e2c9a3;
            --text-main: #4a3b2a;
            --text-muted: #8a7b6a;
            --border-soft: #e0d2c3;
            --error-bg: #ffe9d9;
            --error-border: #e17055;
            --info-bg: #e8f4f6;
            --info-border: #17a2b8;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 60px;
            background: radial-gradient(circle at top, #fdf7ee 0, #f3eadf 40%, #ebdfd1 100%);
            color: var(--text-main);
        }
        .title {
            text-align: center;
            color: var(--accent-dark);
            font-size: 2.4em;
            margin-bottom: 8px;
            letter-spacing: 0.03em;
        }
        .subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.05em;
            margin-bottom: 20px;
        }
        .disclaimer {
            background: #fff7ea;
            border: 1px solid var(--border-soft);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .section {
            display: none;
            margin-bottom: 40px;
            border: 1px solid var(--border-soft);
            padding: 20px;
            border-radius: 16px;
            background: var(--bg-card);
            min-height: 60vh;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
        }
        .section.active { display: block; }
        .front-page {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f4e0c2, #e3c59a);
            color: #4e3424;
            border-radius: 18px;
            margin-bottom: 20px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .front-page h2 {
            margin-top: 0;
            font-size: 1.8em;
        }
        .front-page p {
            max-width: 600px;
            margin: 8px auto 0;
        }
        .front-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .front-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
            box-shadow: 0 6px 14px rgba(0,0,0,0.12);
        }
        .front-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 10px 22px rgba(0,0,0,0.16);
        }
        .analysis-btn {
            background: #c39a6b;
            color: white;
        }
        .gists-btn {
            background: #f3d9a4;
            color: #4a3422;
        }
        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 10px 20px;
            background: #d5b692;
            color: #3e2a19;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
        }
        .back-btn.active { display: inline-flex; align-items: center; gap: 4px; }
        textarea,
        select {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 12px;
            border: 1px solid var(--border-soft);
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            background: #fffdf8;
            color: var(--text-main);
        }
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }
        #prompt-input { height: 80px; }
        #input-text, #topic-text { height: 200px; }
        #checked-text, #topic-checked-text { height: 200px; }
        input[type="file"] {
            margin-bottom: 10px;
            font-size: 13px;
        }
        input[type="text"] {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            font-size: 13px;
            background: #fffdf8;
            width: 100%;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        button:not(.front-btn):not(.back-btn) {
            padding: 10px 18px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease;
        }
        button:not(.front-btn):not(.back-btn):hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
        }
        .output {
            margin-top: 16px;
            padding: 15px;
            border-radius: 12px;
            background: #fffdf8;
            border: 1px solid var(--border-soft);
        }
        .analysis-run {
            border: 1px solid var(--border-soft);
            background: var(--bg-card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .version-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) auto minmax(0, 1.1fr);
            gap: 14px;
        }
        .version-col h3 {
            margin-top: 0;
            font-size: 0.95em;
            color: var(--text-muted);
        }
        .version-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            justify-content: center;
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .version-actions small { display: block; text-align: center; }
        .version-header-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .diff { margin-top: 10px; }
        .feedback {
            background: var(--info-bg);
            padding: 10px 12px;
            border-left: 4px solid var(--info-border);
            margin-top: 14px;
            border-radius: 8px;
            font-size: 0.92em;
        }
        .scores-block {
            background: #fff9eb;
            border: 1px solid var(--accent-soft);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            font-size: 0.92em;
        }
        .scores-block strong {
            display: inline-block;
            margin-bottom: 4px;
        }
        .scores-block ul {
            padding-left: 18px;
            margin: 4px 0 6px;
        }
        .gist-area {
            background: #fff9ef;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-soft);
        }
        #writing-materials { min-height: 100px; }
        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .material-card {
            flex: 1 1 260px;
            background: #ffffff;
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 12px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            cursor: pointer;
        }
        .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }
        .material-card h4 {
            margin-top: 0;
            color: var(--accent-dark);
        }
        #printable-drafts { display: none; }
        .err {
            background: #ffeaa7;
            border-bottom: 2px solid #d63031;
            cursor: help;
        }
        .err-v1 { background: #ffeaa7; border-bottom-color: #d63031; }
        .err-v2 { background: #d1ffd6; border-bottom-color: #16a085; }
        .err-v3 { background: #d6e9ff; border-bottom-color: #2980b9; }
        .err-v4 { background: #f9d1ff; border-bottom-color: #8e44ad; }
        .err-v5 { background: #ffe6d1; border-bottom-color: #e67e22; }
        .err-v6 { background: #fff8b3; border-bottom-color: #f1c40f; }
        .err-topic { background: #ffd6e0; border-bottom-color: #c0392b; }
        .rubric-reminder {
            background: #fffdf8;
            border-radius: 10px;
            border: 1px dashed var(--accent-soft);
            padding: 10px 12px;
            margin-top: 8px;
            margin-bottom: 4px;
            font-size: 0.9em;
            max-height: 260px;
            overflow-y: auto;
        }
        .rubric-reminder h3 {
            margin: 0 0 6px;
            font-size: 0.95em;
            color: var(--accent-dark);
        }
        .rubric-toggle-btn {
            margin-top: 6px;
            margin-bottom: 4px;
            font-size: 0.82em;
            padding: 6px 14px;
        }
        .analysis-sticky {
            position: static;
        }
        .version-legend {
            margin: 4px 0 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 6px 14px;
        }
        .version-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            display: inline-block;
            width: 14px;
            height: 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            vertical-align: middle;
        }
        .legend-v1 { background: #ffeaa7; border-color: #d63031; }
        .legend-v2 { background: #d1ffd6; border-color: #16a085; }
        .legend-v3 { background: #d6e9ff; border-color: #2980b9; }
        .legend-v4 { background: #f9d1ff; border-color: #8e44ad; }
        .legend-v5 { background: #ffe6d1; border-color: #e67e22; }
        .legend-v6 { background: #fff8b3; border-color: #f1c40f; }
        .legend-topic { background: #ffd6e0; border-color: #c0392b; }
        .version-chip {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .version-chip-v1 { background: #fff4d0; border: 1px solid #d63031; color: #6b2b1e; }
        .version-chip-v2 { background: #ddffea; border: 1px solid #16a085; color: #10624f; }
        .version-chip-v3 { background: #e1f0ff; border: 1px solid #2980b9; color: #1c496d; }
        .version-chip-v4 { background: #fbe3ff; border: 1px solid #8e44ad; color: #5a2c73; }
        .version-chip-v5 { background: #ffe9d6; border: 1px solid #e67e22; color: #8c3f09; }
        .version-chip-v6 { background: #fffad1; border: 1px solid #f1c40f; color: #8a6d1e; }
        .version-chip-ref { background: #e6e6e6; border: 1px solid #aaaaaa; color: #444; }
        .prompt-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 8px;
            margin-bottom: 10px;
        }
        .prompt-main {
            flex: 2 1 0;
        }
        .student-info {
            flex: 1 1 0;
            font-size: 0.85em;
            color: var(--text-muted);
            background: #fffdf8;
            border-radius: 10px;
            border: 1px solid var(--border-soft);
            padding: 8px 10px;
        }
        .student-info-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--accent-dark);
        }
        .student-info-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }
        .student-info-row label {
            min-width: 55px;
        }
        .student-info-row input {
            flex: 1 1 auto;
        }
        @media print {
            .no-print,
            .no-print-temp {
                display: none !important;
            }
            #printable-drafts {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0 10mm;
                box-sizing: border-box;
                background: #ffffff;
            }
            .printable {
                page-break-after: always;
            }
        }
        @media (max-width: 900px) {
            .version-layout {
                grid-template-columns: minmax(0, 1fr);
            }
            .version-actions {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        @media (max-width: 800px) {
            .prompt-row {
                flex-direction: column;
            }
        }
        @media (max-width: 600px) {
            .front-buttons { flex-direction: column; align-items: center; }
            body { padding: 16px 12px 40px; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">‚Üê <span>Back</span></button>
    <h1 class="title">Shirley's AI Writing Coach</h1>
    <p class="subtitle">Educational Practice & Entertainment only </p>
    <div class="disclaimer">
        <strong>This tool‚Äî"Shirley's AI Writing Coach"‚Äîis for educational practice and entertainment only.</strong><br>
        Focus on iterating with the feedback‚Äîpractice drives progress!
    </div>

    <!-- Home -->
    <section class="section active front-page" id="home-section">
        <h2>Welcome! Choose Your Writing Adventure</h2>
        <p>Press a button below to enter the next level of your writing journey.</p>
        <div class="front-buttons">
            <button class="front-btn analysis-btn" onclick="enterSection('analysis-section')">Writing Analysis Level</button>
            <button class="front-btn gists-btn" onclick="enterSection('gists-section')">Gists for English Writing Level</button>
        </div>
    </section>

    <!-- Level 1 -->
    <section class="section" id="analysis-section">
        <div class="analysis-sticky">
            <div class="analysis-header-inner">
                <h2>Level 1: Writing Analysis / Feedback</h2>
                <p>Paste or upload your writing below. The AI will provide grammar corrections, rubric-based feedback, and scores.<br>
                   <strong>Important:</strong> Your essay must answer the writing prompt and stay on topic.</p>
                <button type="button" class="rubric-toggle-btn" onclick="toggleRubric()">
                    Show / hide rubric reminder
                </button>
                <div id="rubric-reminder" class="rubric-reminder" style="display:none;">
                    <h3>Rubric Reminder (for all drafts)</h3>
                    <p>Loading rubric...</p>
                </div>
                <div class="prompt-row">
                    <div class="prompt-main">
                        <label for="prompt-input"><strong>Writing prompt / question:</strong></label>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start;">
                            <textarea id="prompt-input" placeholder="Enter the writing task or question here..."></textarea>
                            <div style="flex: 0 0 200px;">
                                <input type="file" id="prompt-image-upload" accept="image/*" style="font-size:12px;margin-bottom:6px;">
                                <small>Optional: Add an image to the prompt</small>
                                <div id="prompt-image-preview" style="margin-top:8px; display:none;">
                                    <img id="prompt-preview-img" src="" alt="Prompt preview" style="max-width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="student-info">
                        <div class="student-info-title">Student Information</div>
                        <div class="student-info-row">
                            <label for="student-school">School</label>
                            <input type="text" id="student-school" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-class">Class</label>
                            <input type="text" id="student-class" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-seat">Seat No.</label>
                            <input type="text" id="student-seat" placeholder="">
                        </div>
                        <div class="student-info-row">
                            <label for="student-name">Name</label>
                            <input type="text" id="student-name" placeholder="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis-run">
                <div class="version-header-inline">
                    <span><strong>Current Draft Workspace</strong></span>
                    <span style="font-size:0.85em;">Use this row for each version. History is kept for printing.</span>
                </div>
                <div class="version-legend">
                    <span class="version-legend-item">
                        <span class="legend-color legend-v1"></span> Version 1 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v2"></span> Version 2 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v3"></span> Version 3 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v4"></span> Version 4 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v5"></span> Version 5 highlight style
                    </span>
                    <span class="version-legend-item">
                        <span class="legend-color legend-v6"></span> Version 6 highlight style
                    </span>
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text (or OCR result)</h3>
                        <textarea id="input-text" placeholder="Paste your writing here, or upload a file / image to extract text..."></textarea>
                    </div>
                    <div class="version-col version-actions">
                        <div>
                            <strong style="font-size:0.9em;">Upload a file</strong>
                            <input
                                type="file"
                                id="file-upload-main"
                                accept=".txt,.pdf,.doc,.docx,image/*"
                            >
                            <small>Supports images (OCR), txt, pdf, doc / docx.</small>
                        </div>
                        <button onclick="analyzeWriting()">Analyze &amp; Feedback</button>
                        <button id="ref-btn" onclick="generateReferenceEssay()" style="display:none;">Generate reference essay</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea id="checked-text" placeholder="Corrected version will appear here. You can still edit it manually."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div id="output" class="output"></div>
        <div class="controls no-print" style="margin-top:16px;">
            <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
                <button onclick="printDrafts()">Print selected versions</button>
            </div>
        </div>
    </section>

    <!-- Level 2: Gists È¶ñÈ†Å -->
    <section class="section" id="gists-section">
        <h2>Level 2: Shirley's Gists for English Writing</h2>
        <p>Enhance your writing skills with these resources.</p>
        <div class="gist-area">
            <h3>1) All about Writing: Self-Designed Materials</h3>
            <div id="writing-materials">Loading materials...</div>
        </div>
        <div class="gist-area">
            <h3>2) Practice with a Topic</h3>
            <label for="topic-category-select"><strong>Topic Category:</strong></label>
            <select id="topic-category-select">
                <option value="">-- Choose a category --</option>
            </select>
            <label for="topic-select" style="margin-top:6px;"><strong>Choose a writing topic:</strong></label>
            <select id="topic-select">
                <option value="">-- Please choose a topic --</option>
            </select>
            <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;">
                <div style="flex:1; min-width:300px;">
                    <label><strong>Optional: Add an image to the topic (for inspiration)</strong></label>
                    <input type="file" id="topic-image-upload" accept="image/*" style="font-size:12px;margin-top:4px;">
                </div>
                <div style="flex:0 0 200px;">
                    <div id="topic-image-preview" style="margin-top:8px; display:none;">
                        <img id="topic-preview-img" src="" alt="Topic image preview" style="max-width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                    </div>
                </div>
            </div>
            <p style="margin-top:8px; font-size: 0.9em;">
                (Teachers can edit category & topics in the JavaScript topicCategories object.)
            </p>
            <div class="analysis-run no-print">
                <div class="version-header-inline">
                    <span><strong>Topic Practice Workspace</strong></span>
                    <span style="font-size:0.85em;">Same analysis flow as Level 1 (with file upload).</span>
                </div>
                <div class="version-legend">
                    <span class="version-legend-item">
                        <span class="legend-color legend-topic"></span> Topic draft highlight style
                    </span>
                </div>
                <div class="version-layout">
                    <div class="version-col">
                        <h3>Original text (or OCR result)</h3>
                        <textarea id="topic-text" placeholder="Write your essay here, or upload a file / image..."></textarea>
                    </div>
                    <div class="version-col version-actions">
                        <div>
                            <strong style="font-size:0.9em;">Upload a file</strong>
                            <input
                                type="file"
                                id="file-upload-topic"
                                accept=".txt,.pdf,.doc,.docx,image/*"
                            >
                            <small>Supports images (OCR), txt, pdf, doc / docx.</small>
                        </div>
                        <button onclick="analyzeTopic()">Analyze &amp; Feedback</button>
                    </div>
                    <div class="version-col">
                        <h3>Checked version</h3>
                        <textarea id="topic-checked-text" placeholder="Corrected topic essay will appear here."></textarea>
                    </div>
                </div>
            </div>
            <div id="topic-output" class="output"></div>
            <div class="controls no-print" style="margin-top:16px;">
                <button onclick="printTopicDrafts()">Print selected topic versions</button>
            </div>
        </div>
    </section>

    <!-- üìò Writing Tips Â≠êÈÅ∏ÂñÆ -->
    <section class="section" id="writing-tips-menu-section">
        <h2>Writing Tips & Guidelines</h2>
        <div class="materials-grid">
            <div class="material-card" onclick="enterSection('writing-gists-viewer-section'); renderWritingGists();">
                <h4>Writing Gists</h4>
                <p>9 illustrated pages of core writing tips.</p>
            </div>
            <div class="material-card" onclick="enterSection('writing-genres-section'); renderWritingGenres();">
                <h4>Writing Genres</h4>
                <p>Explore 6 common writing types with examples.</p>
            </div>
        </div>
    </section>

    <!-- üìñ Writing Gists ÁøªÈñ±Âô® -->
    <section class="section" id="writing-gists-viewer-section">
        <h2>Writing Gists</h2>
        <div id="writing-gists-container"></div>
    </section>

    <!-- üìö Writing Genres ÈÅ∏ÂñÆ -->
    <section class="section" id="writing-genres-section">
        <h2>Writing Genres</h2>
        <div id="writing-genres-container"></div>
    </section>

    <!-- üñºÔ∏è Genre ÂúñÁâáÁÄèË¶ΩÂô® -->
    <section class="section" id="genre-image-viewer-section">
        <h2 id="genre-viewer-title">Genre Examples</h2>
        <div id="genre-viewer-container"></div>
    </section>

    <!-- üìò Model Essays ÈÅ∏ÂñÆ -->
    <section class="section" id="model-essays-section">
        <h2>Model Essays</h2>
        <div class="materials-grid">
            <div class="material-card" onclick="enterSection('gsat-viewer-section'); renderGsatPapers();">
                <h4>GSAT Past Papers</h4>
                <p>View past GSAT writing prompts and sample responses.</p>
            </div>
        </div>
    </section>

    <!-- üìÑ GSAT Papers Viewer -->
    <section class="section" id="gsat-viewer-section">
        <h2>GSAT Past Papers</h2>
        <div id="gsat-viewer-container"></div>
    </section>

    <div id="printable-drafts"></div>

    <script>
        // ========= ÂÖ®ÂüüÁãÄÊÖã =========
        let sectionHistory = ['home-section'];
        let drafts = [];
        let topicDrafts = [];
        let rubricText = '';
        let rubricItems = [];
        let promptImageBase64 = '';
        let topicImageBase64 = '';
        const topicCategories = {
            'Descriptive Writing': ['Describe your favorite holiday.'],
            'Personal Narrative': ['Explain a challenge you have overcome.'],
            'Opinion / Argumentative': ['Should students use smartphones in the classroom? Give your opinion and reasons.']
        };

        // ========= Â∞éËà™ =========
        function enterSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(sectionId);
            if (target) target.classList.add('active');

            if (sectionHistory[sectionHistory.length - 1] !== sectionId) {
                sectionHistory.push(sectionId);
            }
            document.querySelector('.back-btn').classList.toggle('active', sectionId !== 'home-section');

            if (sectionId === 'gists-section') {
                loadWritingMaterials();
                initTopicCategories();
            }
            if (sectionId === 'analysis-section') {
                loadRubric();
            }
        }

        function goBack() {
            if (sectionHistory.length <= 1) {
                sectionHistory = ['home-section'];
                enterSection('home-section');
                return;
            }
            sectionHistory.pop();
            const prev = sectionHistory[sectionHistory.length - 1];
            enterSection(prev);
        }

        // ========= ÁøªÈ†ÅÈü≥Êïà =========
        const PAGE_TURN_SOUND = 'audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';

        function playFlipSound(pageId) {
            const pageEl = document.getElementById(pageId);
            if (!pageEl) return;

            const audio = new Audio(PAGE_TURN_SOUND);
            audio.play().catch(e => console.log('Audio play failed:', e));

            const angle = -15;
            pageEl.style.transform = `rotateY(${angle}deg)`;
            pageEl.style.boxShadow = '0 16px 32px rgba(0,0,0,0.2)';

            setTimeout(() => {
                pageEl.style.transform = '';
                pageEl.style.boxShadow = '';
            }, 300);
        }

        // ========= Writing materials Âç°Áâá =========
        function loadWritingMaterials() {
            const container = document.getElementById('writing-materials');
            container.innerHTML = `
                <div class="materials-grid">
                    <div class="material-card" onclick="enterSection('writing-tips-menu-section')">
                        <h4>Writing Tips & Guidelines</h4>
                        <p>Click to explore writing gists and genres.</p>
                    </div>
                    <div class="material-card" onclick="enterSection('model-essays-section')">
                        <h4>Model Essays</h4>
                        <p>Click to browse sample essays and past papers.</p>
                    </div>
                    <div class="material-card">
                        <h4>Idea Bank / Writing Materials (coming soon)</h4>
                        <p>Collect interesting ideas, vocabulary, or prompts for students.</p>
                    </div>
                </div>
            `;
        }

        // ========= Writing Gists ÁøªÈ†Å =========
        function renderWritingGists() {
            const container = document.getElementById('writing-gists-container');
            const baseUrl = 'https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing%20gists/';
            const totalPages = 9;
            let currentPage = 1;

            function render() {
                const prevDisabled = currentPage <= 1;
                const nextDisabled = currentPage >= totalPages;

                container.innerHTML = `
                    <div style="text-align:center; margin-bottom:12px; color:var(--text-muted); font-size:1em;">
                        Page <strong>${currentPage}</strong> / ${totalPages}
                    </div>
                    <div id="gists-flip-container" style="display:flex; justify-content:center; align-items:center; min-height:500px; padding:0 10px;">
                        <div id="gists-page" style="width:95%; max-width:800px; background:white; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; transition:transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55),box-shadow 0.3s ease; transform-style:preserve-3d;">
                            <img src="${baseUrl}${currentPage}.png" 
                                 alt="Writing gist ${currentPage}"
                                 style="width:100%; display:block; background:#faf9f7;"
                                 onerror="this.parentElement.innerHTML='<p style=\'color:var(--error-border); padding:30px; text-align:center;\'>Image load failed.</p>'"
                            >
                        </div>
                    </div>
                    <div style="display:flex; gap:16px; justify-content:center; margin-top:20px;">
                        <button id="prev-btn" ${prevDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">‚Üê Previous</button>
                        <button id="next-btn" ${nextDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">Next ‚Üí</button>
                    </div>
                `;

                document.getElementById('prev-btn').onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        playFlipSound('gists-page');
                        render();
                    }
                };
                document.getElementById('next-btn').onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        playFlipSound('gists-page');
                        render();
                    }
                };

                const flipContainer = document.getElementById('gists-flip-container');
                if (flipContainer) {
                    let startX = 0;
                    flipContainer.addEventListener('touchstart', e => {
                        startX = e.touches[0].clientX;
                    }, { passive: true });
                    flipContainer.addEventListener('touchend', e => {
                        const endX = e.changedTouches[0].clientX;
                        const diff = startX - endX;
                        if (Math.abs(diff) > 60) {
                            if (diff > 0 && currentPage < totalPages) {
                                currentPage++;
                                playFlipSound('gists-page');
                                render();
                            } else if (diff < 0 && currentPage > 1) {
                                currentPage--;
                                playFlipSound('gists-page');
                                render();
                            }
                        }
                    }, { passive: true });
                }
            }
            render();
        }

        // ========= GSAT Past Papers ÁøªÈ†Å =========
        function renderGsatPapers() {
            const container = document.getElementById('gsat-viewer-container');
            const baseUrl = 'https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/GSAT%20past%20papers/';
            const totalPages = 11;
            let currentPage = 1;

            function render() {
                const prevDisabled = currentPage <= 1;
                const nextDisabled = currentPage >= totalPages;

                container.innerHTML = `
                    <div style="text-align:center; margin-bottom:12px; color:var(--text-muted); font-size:1em;">
                        Page <strong>${currentPage}</strong> / ${totalPages}
                    </div>
                    <div id="gsat-flip-container" style="display:flex; justify-content:center; align-items:center; min-height:500px; padding:0 10px;">
                        <div id="gsat-page" style="width:95%; max-width:800px; background:white; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; transition:transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55),box-shadow 0.3s ease; transform-style:preserve-3d;">
                            <img src="${baseUrl}${currentPage}.png" 
                                 alt="GSAT paper ${currentPage}"
                                 style="width:100%; display:block; background:#faf9f7;"
                                 onerror="this.parentElement.innerHTML='<p style=\'color:var(--error-border); padding:30px; text-align:center;\'>Image load failed.</p>'"
                            >
                        </div>
                    </div>
                    <div style="display:flex; gap:16px; justify-content:center; margin-top:20px;">
                        <button id="prev-btn" ${prevDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">‚Üê Previous</button>
                        <button id="next-btn" ${nextDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">Next ‚Üí</button>
                    </div>
                `;

                document.getElementById('prev-btn').onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        playFlipSound('gsat-page');
                        render();
                    }
                };
                document.getElementById('next-btn').onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        playFlipSound('gsat-page');
                        render();
                    }
                };

                const flipContainer = document.getElementById('gsat-flip-container');
                if (flipContainer) {
                    let startX = 0;
                    flipContainer.addEventListener('touchstart', e => {
                        startX = e.touches[0].clientX;
                    }, { passive: true });
                    flipContainer.addEventListener('touchend', e => {
                        const endX = e.changedTouches[0].clientX;
                        const diff = startX - endX;
                        if (Math.abs(diff) > 60) {
                            if (diff > 0 && currentPage < totalPages) {
                                currentPage++;
                                playFlipSound('gsat-page');
                                render();
                            } else if (diff < 0 && currentPage > 1) {
                                currentPage--;
                                playFlipSound('gsat-page');
                                render();
                            }
                        }
                    }, { passive: true });
                }
            }
            render();
        }

        // ========= Writing Genres ÈÅ∏ÂñÆ =========
        function renderWritingGenres() {
            const container = document.getElementById('writing-genres-container');
            const genres = [
                { name: "Diagrams", folder: "diagram" },
                { name: "Argumentative", folder: "argumentative" },
                { name: "Images", folder: "images" },
                { name: "Narrative", folder: "narrative" },
                { name: "Expository", folder: "expository" },
                { name: "Descriptive", folder: "descriptive" }
            ];

            const html = genres.map(g => `
                <div class="material-card" style="cursor:pointer;" 
                     onclick="enterSection('genre-image-viewer-section'); renderGenreImages('${g.folder}', '${g.name}')">
                    <h4>${g.name}</h4>
                    <p>Examples for ${g.name.toLowerCase()} writing.</p>
                </div>
            `).join('');

            container.innerHTML = `<div class="materials-grid">${html}</div>`;
        }

        // ========= Genre ÂúñÁâáÁøªÈ†Å =========
        function renderGenreImages(folder, displayName) {
            const container = document.getElementById('genre-viewer-container');
            const baseUrl = `https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing%20genres/${folder}/`;
            const maxPages = 10;
            let currentPage = 1;
            let totalPages = 1;

            async function detectTotalPages() {
                for (let i = 1; i <= maxPages; i++) {
                    try {
                        const response = await fetch(`${baseUrl}${i}.png`, { method: 'HEAD' });
                        if (!response.ok) {
                            totalPages = i - 1;
                            break;
                        }
                        if (i === maxPages) totalPages = maxPages;
                    } catch {
                        totalPages = i - 1;
                        break;
                    }
                }
                if (totalPages < 1) totalPages = 1;
                document.getElementById('genre-viewer-title').textContent = `${displayName} Examples`;
                render();
            }

            function render() {
                const prevDisabled = currentPage <= 1;
                const nextDisabled = currentPage >= totalPages;

                container.innerHTML = `
                    <div style="text-align:center; margin-bottom:12px; color:var(--text-muted); font-size:1em;">
                        Page <strong>${currentPage}</strong> / ${totalPages}
                    </div>
                    <div id="genre-flip-container" style="display:flex; justify-content:center; align-items:center; min-height:500px; padding:0 10px;">
                        <div id="genre-page" style="width:95%; max-width:800px; background:white; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; transition:transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55),box-shadow 0.3s ease; transform-style:preserve-3d;">
                            <img src="${baseUrl}${currentPage}.png" 
                                 alt="${folder} example ${currentPage}"
                                 style="width:100%; display:block; background:#faf9f7;"
                                 onerror="this.parentElement.innerHTML='<p style=\'color:var(--error-border); padding:30px; text-align:center;\'>Image load failed.</p>'"
                            >
                        </div>
                    </div>
                    <div style="display:flex; gap:16px; justify-content:center; margin-top:20px;">
                        <button id="prev-btn" ${prevDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">‚Üê Previous</button>
                        <button id="next-btn" ${nextDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">Next ‚Üí</button>
                    </div>
                `;

                document.getElementById('prev-btn').onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        playFlipSound('genre-page');
                        render();
                    }
                };
                document.getElementById('next-btn').onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        playFlipSound('genre-page');
                        render();
                    }
                };

                const flipContainer = document.getElementById('genre-flip-container');
                if (flipContainer) {
                    let startX = 0;
                    flipContainer.addEventListener('touchstart', e => {
                        startX = e.touches[0].clientX;
                    }, { passive: true });
                    flipContainer.addEventListener('touchend', e => {
                        const endX = e.changedTouches[0].clientX;
                        const diff = startX - endX;
                        if (Math.abs(diff) > 60) {
                            if (diff > 0 && currentPage < totalPages) {
                                currentPage++;
                                playFlipSound('genre-page');
                                render();
                            } else if (diff < 0 && currentPage > 1) {
                                currentPage--;
                                playFlipSound('genre-page');
                                render();
                            }
                        }
                    }, { passive: true });
                }
            }

            detectTotalPages();
        }

        // ========= Rubric ËºâÂÖ• =========
        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function loadRubric() {
            if (rubricText) return;
            try {
                const response = await fetch('https://ducj-creator.github.io/Shirley-AI-Writing/writing%20rubric.csv');
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true }).data;
                rubricItems = [];
                parsed.forEach(row => {
                    const crit = (row['Criteria'] || '').trim();
                    if (!crit) return;
                    const levels = {
                        1: (row['1 Point'] || '').trim(),
                        2: (row['2 Points'] || '').trim(),
                        3: (row['3 Points'] || '').trim(),
                        4: (row['4 Points'] || '').trim(),
                        5: (row['5 Points'] || '').trim()
                    };
                    rubricItems.push({ criteria: crit, levels });
                });
                if (rubricItems.length === 0) throw new Error('Empty rubric after parsing');
                rubricText = rubricItems.map(item => {
                    const lv3 = item.levels[3] ? `3 pts: ${item.levels[3]}` : '';
                    const lv4 = item.levels[4] ? `4 pts: ${item.levels[4]}` : '';
                    const lv5 = item.levels[5] ? `5 pts: ${item.levels[5]}` : '';
                    const parts = [lv3, lv4, lv5].filter(Boolean).join('\n');
                    return `- ${item.criteria}:\n${parts}`;
                }).join('\n');
                const rubricDiv = document.getElementById('rubric-reminder');
                if (rubricDiv) {
                    rubricDiv.innerHTML = `
                        <h3>Rubric Reminder (for all drafts)</h3>
                        <pre style="white-space: pre-wrap; font-size:0.9em;">${escapeHtml(rubricText)}</pre>
                    `;
                }
            } catch (e) {
                console.warn('Rubric parse failed, using default.', e);
                rubricItems = [
                    { criteria: 'Essay Structure', levels: { 3: 'Clear introduction, body, and conclusion.' } },
                    { criteria: 'Coherence & Cohesion', levels: { 3: 'Logical order and basic transitions.' } },
                    { criteria: 'Grammar Accuracy', levels: { 3: 'Some minor errors but meaning is clear.' } },
                    { criteria: 'Vocabulary Range & Precision', levels: { 3: 'Adequate vocabulary with some variety.' } }
                ];
                rubricText = rubricItems.map(i => `- ${i.criteria}: ${Object.values(i.levels)[0]}`).join('\n');
                const rubricDiv = document.getElementById('rubric-reminder');
                if (rubricDiv) {
                    rubricDiv.innerHTML = `
                        <h3>Rubric Reminder (default)</h3>
                        <pre style="white-space: pre-wrap; font-size:0.9em;">${escapeHtml(rubricText)}</pre>
                    `;
                }
            }
        }

        function toggleRubric() {
            const div = document.getElementById('rubric-reminder');
            if (!div) return;
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        // ========= LanguageTool ÊñáÊ≥ïÊ™¢Êü• =========
        async function checkWithLanguageTool(text) {
            const params = new URLSearchParams();
            params.append('text', text);
            params.append('language', 'en-US');
            const res = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            if (!res.ok) throw new Error('LanguageTool error: ' + res.status);
            return await res.json();
        }

        function buildCorrectedText(text, matches) {
            // ‰æùÁÖß offset ÂæûÂæåÈù¢ÈñãÂßãÊîπÔºåÈÅøÂÖç index ‰∫ÇÊéâ
            const sorted = [...matches].sort((a, b) => (b.offset) - (a.offset));
            let result = text;
            for (const m of sorted) {
                const replacement = (m.replacements && m.replacements[0] && m.replacements[0].value) || null;
                if (!replacement) continue;
                const start = m.offset;
                const end = m.offset + m.length;
                result = result.slice(0, start) + replacement + result.slice(end);
            }
            return result;
        }

        function buildHighlightedHtml(text, matches, cls) {
            if (!matches || matches.length === 0) return escapeHtml(text);
            const parts = [];
            let cursor = 0;
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            sorted.forEach(m => {
                const start = m.offset;
                const end = m.offset + m.length;
                if (start > cursor) {
                    parts.push(escapeHtml(text.slice(cursor, start)));
                }
                const chunk = text.slice(start, end);
                const msg = m.message || '';
                parts.push(`<span class="err ${cls}" title="${escapeHtml(msg)}">${escapeHtml(chunk)}</span>`);
                cursor = end;
            });
            if (cursor < text.length) {
                parts.push(escapeHtml(text.slice(cursor)));
            }
            return parts.join('');
        }

        function computePromptCoverage(text, prompt) {
            if (!prompt) return { coverage: 1 };
            const pWords = prompt.toLowerCase().match(/[a-z]+/g) || [];
            const tWords = text.toLowerCase().match(/[a-z]+/g) || [];
            if (pWords.length === 0) return { coverage: 1 };
            const pSet = new Set(pWords.filter(w => w.length > 3));
            if (pSet.size === 0) return { coverage: 1 };
            const tSet = new Set(tWords);
            let hit = 0;
            pSet.forEach(w => { if (tSet.has(w)) hit++; });
            const coverage = hit / pSet.size;
            return { coverage: coverage };
        }

        function calculateScores(text, matches, opts) {
            const wordCount = (text.match(/\S+/g) || []).length;
            const sentenceCount = (text.match(/[.!?]/g) || []).length || 1;
            const errorCount = matches.length;

            function clamp(x, min, max) { return Math.max(min, Math.min(max, x)); }

            const grammarScore = clamp(5 - Math.round(errorCount / Math.max(1, sentenceCount * 0.8)), 1, 5);
            const structureScore = clamp(Math.round(Math.min(5, sentenceCount / 2)), 1, 5);
            const vocabScore = clamp(Math.round(Math.min(5, wordCount / 40)), 1, 5);

            const coverage = opts.coverage ?? 1;
            const coverageScore = clamp(Math.round(coverage * 5), 1, 5);

            const totalScore = clamp(Math.round((grammarScore + structureScore + vocabScore + coverageScore) / 4), 1, 5);

            return {
                structure: { score: structureScore },
                coherence: { score: coverageScore },
                grammar: { score: grammarScore, errorCount },
                vocabulary: { score: vocabScore },
                total: { score: totalScore },
                meta: { wordCount, sentenceCount, coverage }
            };
        }

        function buildFeedback(text, matches, opts, scores) {
            const lines = [];
            lines.push(`Overall score: ${scores.total.score} / 5.`);
            lines.push('');
            lines.push(`‚Ä¢ Essay structure: ${scores.structure.score} / 5 ‚Äî introduction, body, and conclusion are basically present.`);
            lines.push(`‚Ä¢ Coherence & on-topic: ${scores.coherence.score} / 5 ‚Äî the essay is mostly related to the prompt and ideas are connected.`);
            lines.push(`‚Ä¢ Grammar accuracy: ${scores.grammar.score} / 5 ‚Äî about ${scores.grammar.errorCount} issues were detected by the checker.`);
            lines.push(`‚Ä¢ Vocabulary: ${scores.vocabulary.score} / 5 ‚Äî you use a fair range of words; try to add more precise or advanced expressions.`);
            lines.push('');
            if (scores.grammar.errorCount > 0) {
                lines.push('Grammar tips:');
                lines.push('- Review subject‚Äìverb agreement and basic tense consistency.');
                lines.push('- Pay attention to articles (a / an / the) and plural nouns.');
                lines.push('- Check prepositions and word forms (for example, use verbs after "to", nouns after "for").');
                lines.push('');
            }
            lines.push('Next steps:');
            lines.push('- Read the corrected version carefully and compare it with your original sentences.');
            lines.push('- Choose two or three sentences to rewrite by yourself, using the feedback as a guide.');
            lines.push('- Practice writing another short paragraph on the same topic using what you have learned.');
            return lines.join('\n');
        }

        function buildVersionChip(label, cls) {
            return `<span class="version-chip ${cls}">${label}</span>`;
        }

        // ========= Level 1 ÂàÜÊûê‰∏ªÊµÅÁ®ã =========
        async function analyzeWriting() {
            const textArea = document.getElementById('input-text');
            const checkedArea = document.getElementById('checked-text');
            const outputEl = document.getElementById('output');
            const prompt = document.getElementById('prompt-input').value || '';

            if (!textArea || !outputEl) return;
            const text = textArea.value.trim();
            if (!text) {
                alert('Please paste your writing first.');
                return;
            }

            outputEl.innerHTML = '<p>Running grammar check with LanguageTool... please wait.</p>';
            try {
                const ltResult = await checkWithLanguageTool(text);
                const matches = ltResult.matches || [];

                const corrected = buildCorrectedText(text, matches);
                const coverageInfo = computePromptCoverage(text, prompt);
                const scores = calculateScores(text, matches, coverageInfo);

                if (checkedArea) {
                    checkedArea.value = corrected;
                }

                const versionIndex = drafts.length + 1;
                const cls = 'err-v' + (((versionIndex - 1) % 6) + 1);
                const highlighted = buildHighlightedHtml(text, matches, cls);
                const feedback = buildFeedback(text, matches, coverageInfo, scores);

                drafts.push({
                    id: versionIndex,
                    textOriginal: text,
                    textCorrected: corrected,
                    highlightedHtml: highlighted,
                    feedback,
                    scores
                });

                const chip = buildVersionChip(`Draft ${versionIndex}`, 'version-chip-v' + (((versionIndex - 1) % 6) + 1));

                const scoresHtml = `
                    <div class="scores-block">
                        <strong>Scores summary</strong>
                        <ul>
                            <li>Structure: ${scores.structure.score} / 5</li>
                            <li>Coherence & on-topic: ${scores.coherence.score} / 5</li>
                            <li>Grammar: ${scores.grammar.score} / 5 (errors: ${scores.grammar.errorCount})</li>
                            <li>Vocabulary: ${scores.vocabulary.score} / 5</li>
                            <li>Total: ${scores.total.score} / 5</li>
                            <li>Word count: ${scores.meta.wordCount}</li>
                        </ul>
                    </div>
                `;

                const fbHtml = `
                    <div class="feedback">
                        <strong>Teacher-style feedback</strong><br><br>
                        ${escapeHtml(feedback).replace(/\n/g, '<br>')}
                    </div>
                `;

                const blockHtml = `
                    <div class="analysis-run printable">
                        <div class="version-header-inline">
                            <span>${chip}</span>
                            <span style="font-size:0.85em;">Latest analysis result</span>
                        </div>
                        ${scoresHtml}
                        <div class="diff">
                            <strong>Highlighted original text</strong><br><br>
                            ${highlighted}
                        </div>
                        ${fbHtml}
                    </div>
                `;

                outputEl.innerHTML = blockHtml;

                const refBtn = document.getElementById('ref-btn');
                if (refBtn) {
                    refBtn.style.display = 'inline-block';
                }
            } catch (e) {
                console.error(e);
                outputEl.innerHTML = `
                    <div class="feedback" style="background:var(--error-bg); border-left-color:var(--error-border);">
                        <strong>Oops, the grammar checker is not available right now.</strong><br>
                        You can still edit your writing manually and try again later.
                    </div>
                `;
            }
        }

        // ========= Generate Reference EssayÔºà‰∏ç‰ΩøÁî®‰ªª‰Ωï APIÔºâ=========
        function generateReferenceEssay() {
            const prompt = document.getElementById('prompt-input').value.trim();
            const outputEl = document.getElementById('output');
            const checkedEl = document.getElementById('checked-text');

            if (!prompt) {
                alert('Please enter the writing prompt / question first.');
                return;
            }

            const refEssay = buildReferenceEssayFromPrompt(prompt);

            if (checkedEl) {
                checkedEl.value = refEssay;
            }

            if (outputEl) {
                const chip = buildVersionChip('Reference Essay', 'version-chip-ref');
                outputEl.innerHTML = `
                    <div class="analysis-run printable">
                        <div class="version-header-inline">
                            <span>${chip}</span>
                            <span style="font-size:0.85em;">Sample essay generated from the prompt</span>
                        </div>
                        <div class="diff">
                            <strong>Reference Essay</strong><br><br>
                            ${escapeHtml(refEssay).replace(/\n/g, '<br>')}
                        </div>
                        <div class="feedback">
                            <strong>How to use this sample</strong><br><br>
                            1. Read the reference essay and underline useful sentence patterns.<br>
                            2. Try to rewrite one or two paragraphs in your own words.<br>
                            3. Do not copy it in an exam. Use it only for practice and idea building.
                        </div>
                    </div>
                `;
            }

            const wordCount = (refEssay.match(/\S+/g) || []).length;

            drafts.push({
                id: drafts.length + 1,
                textOriginal: '(Reference essay for prompt)',
                textCorrected: refEssay,
                highlightedHtml: '',
                feedback: 'Reference essay generated from the prompt for study and imitation.',
                scores: {
                    structure: { score: 5 },
                    coherence: { score: 5 },
                    grammar: { score: 5, errorCount: 0 },
                    vocabulary: { score: 4 },
                    total: { score: 5 },
                    meta: { wordCount, coverage: 1 }
                },
                isReference: true
            });
        }

        function buildReferenceEssayFromPrompt(prompt) {
            const safePrompt = prompt.replace(/\s+/g, ' ').trim();

            const intro =
`In response to the writing task, "${safePrompt}", this essay will first introduce the main idea, then explain several key reasons and examples, and finally give a clear conclusion.`;

            const body1 =
`To begin with, it is important to understand the basic background of this topic. Many students and teachers have different experiences related to it, and these experiences show that the topic is closely connected to our daily lives. When we look at real situations in school, family, and society, we can see why this issue matters.`;

            const body2 =
`Another important point is that we should think about both advantages and disadvantages. On the one hand, there are clear benefits, such as personal growth, stronger relationships, or better learning results. On the other hand, there may also be challenges, including time pressure, stress, or misunderstandings between people. By comparing these sides carefully, we can make a more balanced judgment.`;

            const body3 =
`In addition, examples from students' lives can make the argument more convincing. For instance, imagine a student who follows this idea in a responsible way. He or she may become more confident, improve communication skills, and learn how to solve problems independently. These examples help readers see how the topic is not only abstract, but also practical and meaningful in real life.`;

            const body4 =
`Furthermore, we need to consider how this idea influences our future. When students develop good habits and a positive attitude toward this topic, they are more likely to succeed in further studies, future careers, and social interactions. Therefore, it is necessary to take action step by step, instead of only talking about the idea in theory.`;

            const conclusion =
`In conclusion, the topic of "${safePrompt}" is worth careful discussion. By understanding the background, weighing advantages and disadvantages, using clear examples, and thinking about future impact, we can see why this issue is so important. Students are encouraged to reflect on their own experiences and make wise choices, so that they can grow into responsible and thoughtful young adults.`;

            return [intro, body1, body2, body3, body4, conclusion].join('\n\n');
        }

        // ========= Level 2 Topic ÂàÜÊûêÔºàÁ∞°ÂåñÁâàÔºâ=========
        async function analyzeTopic() {
            const textArea = document.getElementById('topic-text');
            const checkedArea = document.getElementById('topic-checked-text');
            const outputEl = document.getElementById('topic-output');
            const topicPrompt = document.getElementById('topic-select').value || '';

            if (!textArea || !outputEl) return;
            const text = textArea.value.trim();
            if (!text) {
                alert('Please write your topic essay first.');
                return;
            }

            outputEl.innerHTML = '<p>Running grammar check with LanguageTool for topic essay...</p>';
            try {
                const ltResult = await checkWithLanguageTool(text);
                const matches = ltResult.matches || [];
                const corrected = buildCorrectedText(text, matches);
                const coverageInfo = computePromptCoverage(text, topicPrompt);
                const scores = calculateScores(text, matches, coverageInfo);

                if (checkedArea) {
                    checkedArea.value = corrected;
                }

                const versionIndex = topicDrafts.length + 1;
                const highlighted = buildHighlightedHtml(text, matches, 'err-topic');
                const feedback = buildFeedback(text, matches, coverageInfo, scores);

                topicDrafts.push({
                    id: versionIndex,
                    textOriginal: text,
                    textCorrected: corrected,
                    highlightedHtml: highlighted,
                    feedback,
                    scores
                });

                const chip = buildVersionChip(`Topic Draft ${versionIndex}`, 'version-chip-ref');

                const scoresHtml = `
                    <div class="scores-block">
                        <strong>Scores summary (topic)</strong>
                        <ul>
                            <li>Structure: ${scores.structure.score} / 5</li>
                            <li>Coherence & on-topic: ${scores.coherence.score} / 5</li>
                            <li>Grammar: ${scores.grammar.score} / 5 (errors: ${scores.grammar.errorCount})</li>
                            <li>Vocabulary: ${scores.vocabulary.score} / 5</li>
                            <li>Total: ${scores.total.score} / 5</li>
                            <li>Word count: ${scores.meta.wordCount}</li>
                        </ul>
                    </div>
                `;

                const fbHtml = `
                    <div class="feedback">
                        <strong>Feedback for topic practice</strong><br><br>
                        ${escapeHtml(feedback).replace(/\n/g, '<br>')}
                    </div>
                `;

                const blockHtml = `
                    <div class="analysis-run printable">
                        <div class="version-header-inline">
                            <span>${chip}</span>
                            <span style="font-size:0.85em;">Latest topic analysis</span>
                        </div>
                        ${scoresHtml}
                        <div class="diff">
                            <strong>Highlighted topic draft</strong><br><br>
                            ${highlighted}
                        </div>
                        ${fbHtml}
                    </div>
                `;

                outputEl.innerHTML = blockHtml;
            } catch (e) {
                console.error(e);
                outputEl.innerHTML = `
                    <div class="feedback" style="background:var(--error-bg); border-left-color:var(--error-border);">
                        <strong>Topic grammar checker is not available right now.</strong><br>
                        You can still edit your writing manually and try again later.
                    </div>
                `;
            }
        }

        // ========= Topic È°ûÂà•ÂàùÂßãÂåñ =========
        function initTopicCategories() {
            const catSelect = document.getElementById('topic-category-select');
            if (!catSelect) return;
            catSelect.innerHTML = '<option value="">-- Choose a category --</option>';
            Object.keys(topicCategories).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                catSelect.appendChild(opt);
            });
            catSelect.addEventListener('change', () => {
                const cat = catSelect.value;
                const topicSelect = document.getElementById('topic-select');
                topicSelect.innerHTML = '<option value="">-- Please choose a topic --</option>';
                if (topicCategories[cat]) {
                    topicCategories[cat].forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.textContent = t;
                        topicSelect.appendChild(opt);
                    });
                }
            });
        }

        // ========= Ê™îÊ°à / ÂúñÁâáËôïÁêÜ =========
        function handleFileInput(file, targetTextareaId) {
            if (!file) return;
            const name = file.name.toLowerCase();
            const textarea = document.getElementById(targetTextareaId);
            if (!textarea) return;

            if (file.type.startsWith('image/')) {
                textarea.value = 'Running OCR on image...';
                Tesseract.recognize(file, 'eng', { logger: m => console.log(m) })
                    .then(result => {
                        textarea.value = result.data.text || '(No text recognized)';
                    })
                    .catch(err => {
                        console.error(err);
                        textarea.value = 'OCR failed. Please try another image or paste text manually.';
                    });
            } else if (name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = e => {
                    textarea.value = e.target.result || '';
                };
                reader.onerror = () => {
                    textarea.value = 'Failed to read text file.';
                };
                reader.readAsText(file);
            } else if (name.endsWith('.pdf')) {
                textarea.value = 'PDF reading is not implemented in this version. Please copy-paste the text manually.';
            } else if (name.endsWith('.doc') || name.endsWith('.docx')) {
                textarea.value = 'DOC / DOCX reading is not implemented in this version. Please copy-paste the text manually.';
            } else {
                textarea.value = 'Unsupported file type. Please use image, txt, pdf, or doc/docx.';
            }
        }

        // prompt image preview
        document.getElementById('prompt-image-upload')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                promptImageBase64 = ev.target.result;
                const previewDiv = document.getElementById('prompt-image-preview');
                const img = document.getElementById('prompt-preview-img');
                if (previewDiv && img) {
                    img.src = promptImageBase64;
                    previewDiv.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        });

        // topic image preview
        document.getElementById('topic-image-upload')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                topicImageBase64 = ev.target.result;
                const previewDiv = document.getElementById('topic-image-preview');
                const img = document.getElementById('topic-preview-img');
                if (previewDiv && img) {
                    img.src = topicImageBase64;
                    previewDiv.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('file-upload-main')?.addEventListener('change', e => {
            handleFileInput(e.target.files[0], 'input-text');
        });
        document.getElementById('file-upload-topic')?.addEventListener('change', e => {
            handleFileInput(e.target.files[0], 'topic-text');
        });

        // ========= ÂàóÂç∞ÔºàÁ∞°ÊòìÂç†‰ΩçÔºâ=========
        function printDrafts() {
            window.print();
        }
        function printTopicDrafts() {
            window.print();
        }

        // ========= ÂÖ®ÂüüÊö¥Èú≤ =========
        window.enterSection = enterSection;
        window.goBack = goBack;
        window.analyzeWriting = analyzeWriting;
        window.generateReferenceEssay = generateReferenceEssay;
        window.analyzeTopic = analyzeTopic;
        window.printDrafts = printDrafts;
        window.printTopicDrafts = printTopicDrafts;
        window.renderWritingGists = renderWritingGists;
        window.renderWritingGenres = renderWritingGenres;
        window.renderGenreImages = renderGenreImages;
        window.renderGsatPapers = renderGsatPapers;
        window.toggleRubric = toggleRubric;

        // ========= Init =========
        loadWritingMaterials();
        loadRubric();
        initTopicCategories();
    </script>
</body>
</html>
