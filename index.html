<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>

    <!-- diff / csv parser（全域掛在 window） -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
        .disclaimer { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #856404; }
        .title { text-align: center; color: #6c5ce7; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #a29bfe; font-size: 1.2em; margin-bottom: 20px; }
        .section { display: none; margin-bottom: 40px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white; min-height: 60vh; }
        .section.active { display: block; }
        .front-page { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border-radius: 8px; margin-bottom: 20px; }
        .front-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
        .front-btn { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; transition: transform 0.2s; }
        .front-btn:hover { transform: scale(1.05); }
        .analysis-btn { background: #00b894; color: white; }
        .gists-btn { background: #fdcb6e; color: #2d3436; }
        .back-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #74b9ff; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 1000; display: none; }
        .back-btn.active { display: block; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="file"] { margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        button:not(.front-btn):not(.back-btn) { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #74b9ff; color: white; }
        .output { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; }
        .diff { margin-top: 10px; }
        .feedback { background: #d1ecf1; padding: 10px; border-left: 4px solid #17a2b8; margin-top: 10px; }
        .gist-area { background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        #writing-materials { height: 200px; overflow-y: auto; }
        #printable-drafts { display: none; }

        /* 錯誤高亮 */
        .err {
            background: #ffeaa7;
            border-bottom: 2px solid #d63031;
            cursor: help;
        }
        .err::after {
            content: "";
        }

        @media print {
            .no-print { display: none; }
            .printable { page-break-after: always; }
        }
        @media (max-width: 600px) {
            .front-buttons { flex-direction: column; align-items: center; }
            .controls { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goHome()">← Back to Home</button>

    <h1 class="title">Shirley's AI Writing Coach</h1>
    <p class="subtitle">Educational practice and entertainment only. Use this tool to enhance your writing skills with AI feedback.</p>

    <div class="disclaimer">
        <strong>This tool—"Shirley's AI Writing Coach"—is for educational practice and entertainment only.</strong><br>
        Focus on iterating with the feedback—practice drives progress!
    </div>

    <!-- Home -->
    <section class="section active front-page" id="home-section">
        <h2>Welcome! Choose Your Writing Adventure</h2>
        <p>Press a button below to enter the next level of your writing journey.</p>
        <div class="front-buttons">
            <button class="front-btn analysis-btn" onclick="enterLevel('analysis')">Writing Analysis Level</button>
            <button class="front-btn gists-btn" onclick="enterLevel('gists')">Gists for English Writing Level</button>
        </div>
    </section>

    <!-- Level 1 -->
    <section class="section" id="analysis-section">
        <h2>Level 1: Writing Analysis / Feedback</h2>
        <p>Paste or upload your writing below. The AI will provide grammar corrections and feedback based on a rubric (rubric.csv in your GitHub repo).</p>
        <textarea id="input-text" placeholder="Paste your writing here..."></textarea>
        <input type="file" id="file-upload" accept=".txt" style="display: block; margin-bottom: 10px;">
        <div class="controls">
            <button onclick="analyzeWriting()" class="no-print">Analyze & Feedback</button>
        </div>
        <div id="output" class="output"></div>
        <textarea id="edit-text" placeholder="Edit your draft here..."></textarea>
        <div class="controls">
            <button onclick="submitEdit()" class="no-print">Submit Edit for Feedback</button>
            <button onclick="printDrafts()" class="no-print">Print All Drafts</button>
        </div>
    </section>

    <!-- Level 2 -->
    <section class="section" id="gists-section">
        <h2>Level 2: Shirley's Gists for English Writing</h2>
        <p>Enhance your writing skills with these resources.</p>

        <div class="gist-area">
            <h3>1) All about Writing: Self-Designed Materials</h3>
            <div id="writing-materials">Loading materials...</div>
        </div>

        <div class="gist-area">
            <h3>2) Practice with a Topic</h3>
            <input type="text" id="topic-input" placeholder="Enter the topic (e.g., 'Describe your favorite holiday')">
            <textarea id="topic-text" placeholder="Write your essay here..."></textarea>
            <div class="controls">
                <button onclick="analyzeTopic()">Submit for Feedback</button>
            </div>
            <div id="topic-output" class="output"></div>
        </div>
    </section>

    <div id="printable-drafts" class="printable"></div>

    <script>
        let currentLevel = 'home';
        let drafts = [];
        let rubricText = '';

        // --------- 小工具 ---------
        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // LanguageTool API：檢查英文文法/拼字
        async function checkWithLanguageTool(text) {
            const params = new URLSearchParams();
            params.append('text', text);
            params.append('language', 'en-US');
            const res = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            if (!res.ok) {
                throw new Error('LanguageTool error: ' + res.status);
            }
            return await res.json();
        }

        // 根據 match 建 corrected 版本
        function buildCorrectedText(text, matches) {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const replacement = (m.replacements && m.replacements[0])
                    ? m.replacements[0].value
                    : text.slice(start, end);
                result += text.slice(cursor, start) + replacement;
                cursor = end;
            }
            result += text.slice(cursor);
            return result;
        }

        // 把原文標出錯誤
        function buildHighlightedHtml(text, matches) {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const original = text.slice(start, end);
                const tipBase = m.message || '';
                const suggestion = (m.replacements && m.replacements[0])
                    ? ' → ' + m.replacements[0].value
                    : '';
                const tip = escapeHtml(tipBase + suggestion);

                result += escapeHtml(text.slice(cursor, start));
                result += `<span class="err" title="${tip}">${escapeHtml(original)}</span>`;
                cursor = end;
            }
            result += escapeHtml(text.slice(cursor));
            return result;
        }

        // 根據 matches & rubric 組合文字 feedback
        function buildFeedback(text, matches, topic) {
            const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
            const avgLen = sentences ? (wordCount / sentences).toFixed(1) : 'N/A';

            const grammarCount = matches.filter(m => m.rule && m.rule.issueType === 'grammar').length;
            const spellingCount = matches.filter(m => m.rule && m.rule.issueType === 'misspelling').length;
            const styleCount = matches.filter(m => m.rule && m.rule.issueType === 'style').length;

            let msg = '';

            if (topic) {
                msg += `Topic: ${topic}\n\n`;
            }

            msg += `Length & structure:\n`;
            msg += `- Words: ${wordCount}\n`;
            msg += `- Sentences: ${sentences}\n`;
            msg += `- Average words per sentence: ${avgLen}\n\n`;

            msg += `Issues detected:\n`;
            msg += `- Grammar: ${grammarCount}\n`;
            msg += `- Spelling: ${spellingCount}\n`;
            msg += `- Style / phrasing: ${styleCount}\n\n`;

            msg += `Suggestions:\n`;
            if (grammarCount > 0) {
                msg += `- Focus on subject–verb agreement and correct verb forms.\n`;
            }
            if (spellingCount > 0) {
                msg += `- Review the highlighted spelling mistakes; add difficult words to your personal word list.\n`;
            }
            if (styleCount > 0) {
                msg += `- Some sentences may be wordy or informal; try to make them more concise and academic.\n`;
            }
            msg += `- Read your writing aloud to check if the sentences flow naturally.\n`;

            if (topic) {
                msg += `- Check that every paragraph clearly supports the topic: "${topic}".\n`;
            }

            if (rubricText) {
                msg += `\nRubric reminder (summary):\n`;
                msg += rubricText.split('\n').slice(0, 5).join('\n');
            }

            return msg;
        }

        // 讀 rubric.csv
        async function loadRubric() {
            if (rubricText) return;
            try {
                const response = await fetch('https://ducj-creator.github.io/Shirley-AI-Writing/writing%20rubric.csv');
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true }).data;
                rubricText = parsed
                    .map(row => `${row.Criterion || 'Criterion'}: ${row.Description || 'N/A'}`)
                    .join('\n');
            } catch (e) {
                rubricText = 'Criterion: Grammar; Description: Check verb forms, subject–verb agreement, and basic sentence structure.\n' +
                             'Criterion: Vocabulary; Description: Use appropriate and varied word choices.\n' +
                             'Criterion: Organization; Description: Use clear topic sentences and logical flow.\n';
            }
        }

        async function loadWritingMaterials() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing-materials.md');
                const md = await response.text();
                document.getElementById('writing-materials').innerHTML = `<pre>${md}</pre>`;
            } catch (e) {
                document.getElementById('writing-materials').innerHTML =
                    '<p>Place your self-designed materials in writing-materials.md in the repo and update the fetch URL.</p>';
            }
        }

        // --------- UI 切換 ---------
        function enterLevel(level) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(level + '-section');
            if (target) target.classList.add('active');
            document.querySelector('.back-btn').classList.add('active');
            currentLevel = level;
            if (level === 'gists') loadWritingMaterials();
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            document.querySelector('.back-btn').classList.remove('active');
            currentLevel = 'home';
        }

        // --------- Level 1：一般寫作 ---------
        async function analyzeWriting() {
            const output = document.getElementById('output');
            const text = document.getElementById('input-text').value;

            if (!text.trim()) {
                alert('Please enter text.');
                return;
            }

            output.innerHTML = '<em>Checking your writing... (using LanguageTool grammar checker)</em>';

            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matches = result.matches || [];

                const corrected = buildCorrectedText(text, matches);
                const highlighted = buildHighlightedHtml(text, matches);
                const feedbackText = buildFeedback(text, matches, null);

                output.innerHTML = `
                    <h3>Corrected Version:</h3>
                    <div class="diff">${escapeHtml(corrected).replace(/\n/g, '<br>')}</div>
                    <h3 style="margin-top:20px;">Original with highlighted issues:</h3>
                    <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                    <div class="feedback">
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(feedbackText)}</pre>
                    </div>
                `;

                document.getElementById('edit-text').value = corrected;
                drafts.push({ original: text, corrected, feedback: feedbackText });

            } catch (err) {
                console.error(err);
                output.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        function submitEdit() {
            document.getElementById('input-text').value = document.getElementById('edit-text').value;
            analyzeWriting();
        }

        function printDrafts() {
            const printable = document.getElementById('printable-drafts');
            printable.innerHTML = drafts
                .map(
                    (draft, i) => `
                <div class="printable">
                    <h2>Draft ${i + 1}</h2>
                    <h3>Original:</h3><p>${escapeHtml(draft.original).replace(/\n/g, '<br>')}</p>
                    <h3>Corrected:</h3><p>${escapeHtml(draft.corrected).replace(/\n/g, '<br>')}</p>
                    <h3>Feedback:</h3><pre style="white-space: pre-wrap;">${escapeHtml(draft.feedback)}</pre>
                </div>
            `
                )
                .join('');
            printable.style.display = 'block';
            window.print();
            printable.style.display = 'none';
        }

        // --------- Level 2：題目作文 ---------
        async function analyzeTopic() {
            const output = document.getElementById('topic-output');
            const topic = document.getElementById('topic-input').value;
            const text = document.getElementById('topic-text').value;

            if (!topic.trim() || !text.trim()) {
                alert('Please enter topic and text.');
                return;
            }

            output.innerHTML = '<em>Checking your essay for this topic...</em>';

            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matches = result.matches || [];

                const corrected = buildCorrectedText(text, matches);
                const highlighted = buildHighlightedHtml(text, matches);
                const feedbackText = buildFeedback(text, matches, topic);

                output.innerHTML = `
                    <h3>Corrected Essay:</h3>
                    <div class="diff">${escapeHtml(corrected).replace(/\n/g, '<br>')}</div>
                    <h3 style="margin-top:20px;">Original with highlighted issues:</h3>
                    <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                    <div class="feedback">
                        <h3>Topic-Specific Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(feedbackText)}</pre>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                output.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        // 檔案上傳
        document.getElementById('file-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    document.getElementById('input-text').value = ev.target.result;
                };
                reader.readAsText(file);
            }
        });

        // 讓這些函式在 HTML 的 onclick 上可用
        window.enterLevel = enterLevel;
        window.goHome = goHome;
        window.analyzeWriting = analyzeWriting;
        window.submitEdit = submitEdit;
        window.printDrafts = printDrafts;
        window.analyzeTopic = analyzeTopic;

        // 一進頁面試著載教材
        loadWritingMaterials();
    </script>
</body>
</html>
