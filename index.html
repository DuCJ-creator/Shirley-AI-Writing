<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>

    <!-- diff / csv parser（全域掛在 window） -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- OCR / PDF / DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --bg-main: #f6efe5;
            --bg-card: #fbf7f0;
            --bg-front: #f0e2c9;
            --accent: #c39a6b;
            --accent-dark: #8b5e34;
            --accent-soft: #e2c9a3;
            --text-main: #4a3b2a;
            --text-muted: #8a7b6a;
            --border-soft: #e0d2c3;
            --error-bg: #ffe9d9;
            --error-border: #e17055;
            --info-bg: #e8f4f6;
            --info-border: #17a2b8;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 60px;
            background: radial-gradient(circle at top, #fdf7ee 0, #f3eadf 40%, #ebdfd1 100%);
            color: var(--text-main);
        }

        .title {
            text-align: center;
            color: var(--accent-dark);
            font-size: 2.4em;
            margin-bottom: 8px;
            letter-spacing: 0.03em;
        }

        .subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.05em;
            margin-bottom: 20px;
        }

        .disclaimer {
            background: #fff7ea;
            border: 1px solid var(--border-soft);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }

        .section {
            display: none;
            margin-bottom: 40px;
            border: 1px solid var(--border-soft);
            padding: 20px;
            border-radius: 16px;
            background: var(--bg-card);
            min-height: 60vh;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
        }
        .section.active { display: block; }

        .front-page {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f4e0c2, #e3c59a);
            color: #4e3424;
            border-radius: 18px;
            margin-bottom: 20px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .front-page h2 {
            margin-top: 0;
            font-size: 1.8em;
        }
        .front-page p {
            max-width: 600px;
            margin: 8px auto 0;
        }

        .front-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .front-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
            box-shadow: 0 6px 14px rgba(0,0,0,0.12);
        }
        .front-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 10px 22px rgba(0,0,0,0.16);
        }
        .analysis-btn {
            background: #c39a6b;
            color: white;
        }
        .gists-btn {
            background: #f3d9a4;
            color: #4a3422;
        }

        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 10px 20px;
            background: #d5b692;
            color: #3e2a19;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
        }
        .back-btn.active { display: inline-flex; align-items: center; gap: 4px; }

        textarea,
        select {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 12px;
            border: 1px solid var(--border-soft);
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            background: #fffdf8;
            color: var(--text-main);
        }
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }

        #prompt-input { height: 80px; }
        #input-text, #topic-text { height: 200px; }
        #checked-text, #topic-checked-text { height: 200px; }

        input[type="file"] {
            margin-bottom: 10px;
            font-size: 13px;
        }

        input[type="text"] {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            font-size: 13px;
            background: #fffdf8;
            width: 100%;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(195,154,107,0.18);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        button:not(.front-btn):not(.back-btn) {
            padding: 10px 18px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: background 0.18s ease, transform 0.18s ease, box-shadow 0.18s ease;
        }
        button:not(.front-btn):not(.back-btn):hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
        }

        .output {
            margin-top: 16px;
            padding: 15px;
            border-radius: 12px;
            background: #fffdf8;
            border: 1px solid var(--border-soft);
        }

        .analysis-run {
            border: 1px solid var(--border-soft);
            background: var(--bg-card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .version-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) auto minmax(0, 1.1fr);
            gap: 14px;
        }

        .version-col h3 {
            margin-top: 0;
            font-size: 0.95em;
            color: var(--text-muted);
        }

        .version-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            justify-content: center;
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .version-actions small { display: block; text-align: center; }

        .version-header-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .diff { margin-top: 10px; }

        .feedback {
            background: var(--info-bg);
            padding: 10px 12px;
            border-left: 4px solid var(--info-border);
            margin-top: 14px;
            border-radius: 8px;
            font-size: 0.92em;
        }

        .scores-block {
            background: #fff9eb;
            border: 1px solid var(--accent-soft);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            font-size: 0.92em;
        }
        .scores-block strong {
            display: inline-block;
            margin-bottom: 4px;
        }
        .scores-block ul {
            padding-left: 18px;
            margin: 4px 0 6px;
        }

        .gist-area {
            background: #fff9ef;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-soft);
        }

        #writing-materials { min-height: 100px; }

        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .material-card {
            flex: 1 1 260px;
            background: #ffffff;
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 12px;
        }
        .material-card h4 { margin-top: 0; }

        #printable-drafts { display: none; }

        /* 錯誤高亮共用基底 */
        .err {
            background: #ffeaa7;
            border-bottom: 2px solid #d63031;
            cursor: help;
        }

        /* 不同版本的顏色（Version 1~6 循環使用） */
        .err-v1 { background: #ffeaa7; border-bottom-color: #d63031; }
        .err-v2 { background: #d1ffd6; border-bottom-color: #16a085; }
        .err-v3 { background: #d6e9ff; border-bottom-color: #2980b9; }
        .err-v4 { background: #f9d1ff; border-bottom-color: #8e44ad; }
        .err-v5 { background: #ffe6d1; border-bottom-color: #e67e22; }
        .err-v6 { background: #fff8b3; border-bottom-color: #f1c40f; }

        /* Level 2（topic 練習）的顏色 */
        .err-topic { background: #ffd6e0; border-bottom-color: #c0392b; }

        /* Rubric reminder block（預設收合，由按鈕開啟） */
        .rubric-reminder {
            background: #fffdf8;
            border-radius: 10px;
            border: 1px dashed var(--accent-soft);
            padding: 10px 12px;
            margin-top: 8px;
            margin-bottom: 4px;
            font-size: 0.9em;
            max-height: 260px;
            overflow-y: auto;
        }
        .rubric-reminder h3 {
            margin: 0 0 6px;
            font-size: 0.95em;
            color: var(--accent-dark);
        }

        .rubric-toggle-btn {
            margin-top: 6px;
            margin-bottom: 4px;
            font-size: 0.82em;
            padding: 6px 14px;
        }

        /* 原本 sticky 的 class，現在只當一般容器用（取消凍結） */
        .analysis-sticky {
            position: static;
        }

        /* 版本顏色 legend */
        .version-legend {
            margin: 4px 0 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 6px 14px;
        }
        .version-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            display: inline-block;
            width: 14px;
            height: 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            vertical-align: middle;
        }
        .legend-v1 { background: #ffeaa7; border-color: #d63031; }
        .legend-v2 { background: #d1ffd6; border-color: #16a085; }
        .legend-v3 { background: #d6e9ff; border-color: #2980b9; }
        .legend-v4 { background: #f9d1ff; border-color: #8e44ad; }
        .legend-v5 { background: #ffe6d1; border-color: #e67e22; }
        .legend-v6 { background: #fff8b3; border-color: #f1c40f; }
        .legend-topic { background: #ffd6e0; border-color: #c0392b; }

        /* 版本標題的小彩色 badge */
        .version-chip {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .version-chip-v1 { background: #fff4d0; border: 1px solid #d63031; color: #6b2b1e; }
        .version-chip-v2 { background: #ddffea; border: 1px solid #16a085; color: #10624f; }
        .version-chip-v3 { background: #e1f0ff; border: 1px solid #2980b9; color: #1c496d; }
        .version-chip-v4 { background: #fbe3ff; border: 1px solid #8e44ad; color: #5a2c73; }
        .version-chip-v5 { background: #ffe9d6; border: 1px solid #e67e22; color: #8c3f09; }
        .version-chip-v6 { background: #fffad1; border: 1px solid #f1c40f; color: #8a6d1e; }
        .version-chip-ref { background: #e6e6e6; border: 1px solid #aaaaaa; color: #444; }

        /* Prompt + 學生資訊 */
        .prompt-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 8px;
            margin-bottom: 10px;
        }
        .prompt-main {
            flex: 2 1 0;
        }
        .student-info {
            flex: 1 1 0;
            font-size: 0.85em;
            color: var(--text-muted);
            background: #fffdf8;
            border-radius: 10px;
            border: 1px solid var(--border-soft);
            padding: 8px 10px;
        }
        .student-info-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--accent-dark);
        }
        .student-info-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }
        .student-info-row label {
            min-width: 55px;
        }
        .student-info-row input {
            flex: 1 1 auto;
        }

        /* 列印時的 header 區塊 */
        .print-header {
            margin-bottom: 12px;
        }
        .print-header h1 {
            margin: 0 0 4px;
        }
        .print-header p {
            margin: 2px 0;
            font-size: 0.92em;
        }

        @
