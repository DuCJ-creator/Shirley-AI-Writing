<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Writing Coach</title>

    <!-- diff / csv parser（全域掛在 window） -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
        .disclaimer { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #856404; }
        .title { text-align: center; color: #6c5ce7; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #a29bfe; font-size: 1.2em; margin-bottom: 20px; }
        .section { display: none; margin-bottom: 40px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white; min-height: 60vh; }
        .section.active { display: block; }
        .front-page { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border-radius: 8px; margin-bottom: 20px; }
        .front-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
        .front-btn { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; transition: transform 0.2s; }
        .front-btn:hover { transform: scale(1.05); }
        .analysis-btn { background: #00b894; color: white; }
        .gists-btn { background: #fdcb6e; color: #2d3436; }
        .back-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #74b9ff; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 1000; display: none; }
        .back-btn.active { display: block; }
        textarea { width: 100%; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #prompt-input { height: 80px; }
        #input-text, #topic-text { height: 200px; }
        input[type="file"] { margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        button:not(.front-btn):not(.back-btn) { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #74b9ff; color: white; }
        .output { margin-top: 20px; padding: 15px; border-radius: 4px; }

        .analysis-run {
            border: 1px solid #ddd;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .version-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .diff { margin-top: 10px; }
        .feedback { background: #d1ecf1; padding: 10px; border-left: 4px solid #17a2b8; margin-top: 10px; }
        .gist-area { background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 20px; }

        #writing-materials { min-height: 100px; }
        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .material-card {
            flex: 1 1 260px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
        }
        .material-card h4 {
            margin-top: 0;
        }

        #printable-drafts { display: none; }

        /* 錯誤高亮 */
        .err {
            background: #ffeaa7;
            border-bottom: 2px solid #d63031;
            cursor: help;
        }

        @media print {
            .no-print { display: none; }
            .printable { page-break-after: always; }
        }
        @media (max-width: 600px) {
            .front-buttons { flex-direction: column; align-items: center; }
            .controls { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goHome()">← Back to Home</button>

    <h1 class="title">Shirley's AI Writing Coach</h1>
    <p class="subtitle">Educational practice and entertainment only. Use this tool to enhance your writing skills with AI feedback.</p>

    <div class="disclaimer">
        <strong>This tool—"Shirley's AI Writing Coach"—is for educational practice and entertainment only.</strong><br>
        Focus on iterating with the feedback—practice drives progress!
    </div>

    <!-- Home -->
    <section class="section active front-page" id="home-section">
        <h2>Welcome! Choose Your Writing Adventure</h2>
        <p>Press a button below to enter the next level of your writing journey.</p>
        <div class="front-buttons">
            <button class="front-btn analysis-btn" onclick="enterLevel('analysis')">Writing Analysis Level</button>
            <button class="front-btn gists-btn" onclick="enterLevel('gists')">Gists for English Writing Level</button>
        </div>
    </section>

    <!-- Level 1 -->
    <section class="section" id="analysis-section">
        <h2>Level 1: Writing Analysis / Feedback</h2>
        <p>Paste or upload your writing below. The AI will provide grammar corrections and feedback based on a rubric (rubric.csv in your GitHub repo).</p>

        <!-- 新增寫作題目 / prompt -->
        <label for="prompt-input"><strong>Writing prompt / question:</strong></label>
        <textarea id="prompt-input" placeholder="Enter the writing task or question here..."></textarea>

        <textarea id="input-text" placeholder="Paste your writing here..."></textarea>
        <input type="file" id="file-upload" accept=".txt" style="display: block; margin-bottom: 10px;">
        <div class="controls no-print">
            <button onclick="analyzeWriting()">Analyze & Feedback</button>
            <button id="ref-btn" onclick="generateReferenceEssay()" style="display:none;">Generate reference essay</button>
        </div>

        <!-- 多版本結果一個接一個放這裡 -->
        <div id="output" class="output"></div>

        <textarea id="edit-text" placeholder="Edit your draft here..."></textarea>
        <div class="controls no-print">
            <button onclick="submitEdit()">Submit Edit for Feedback</button>
            <button onclick="printDrafts()">Print Selected Versions</button>
        </div>
    </section>

    <!-- Level 2 -->
    <section class="section" id="gists-section">
        <h2>Level 2: Shirley's Gists for English Writing</h2>
        <p>Enhance your writing skills with these resources.</p>

        <div class="gist-area">
            <h3>1) All about Writing: Self-Designed Materials</h3>
            <div id="writing-materials">Loading materials...</div>
        </div>

        <div class="gist-area">
            <h3>2) Practice with a Topic</h3>
            <!-- 多題寫作題目讓學生選 -->
            <label for="topic-select"><strong>Choose a writing topic:</strong></label>
            <select id="topic-select">
                <option value="">-- Please choose a topic --</option>
                <option value="Describe your favorite holiday.">Describe your favorite holiday.</option>
                <option value="Explain a challenge you have overcome.">Explain a challenge you have overcome.</option>
                <option value="Should students use smartphones in the classroom? Give your opinion and reasons.">
                    Should students use smartphones in the classroom? Give your opinion and reasons.
                </option>
                <!-- 老師可以直接在這裡增加/修改題目 -->
            </select>
            <p style="margin-top:8px; font-size: 0.9em;">
                (Teachers can edit the topic list in the HTML.)
            </p>

            <textarea id="topic-text" placeholder="Write your essay here..."></textarea>
            <div class="controls no-print">
                <button onclick="analyzeTopic()">Submit for Feedback</button>
            </div>
            <div id="topic-output" class="output"></div>
        </div>
    </section>

    <div id="printable-drafts" class="printable"></div>

    <script>
        let currentLevel = 'home';
        let drafts = [];      // 每個元素：{ original, corrected, highlighted, feedback }
        let rubricText = '';
        let rubricItems = []; // [{criteria, levels:{1..5}}]

        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // LanguageTool API
        async function checkWithLanguageTool(text) {
            const params = new URLSearchParams();
            params.append('text', text);
            params.append('language', 'en-US');
            const res = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            if (!res.ok) throw new Error('LanguageTool error: ' + res.status);
            return await res.json();
        }

        function buildCorrectedText(text, matches) {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const replacement = (m.replacements && m.replacements[0])
                    ? m.replacements[0].value
                    : text.slice(start, end);
                result += text.slice(cursor, start) + replacement;
                cursor = end;
            }
            result += text.slice(cursor);
            return result;
        }

        function buildHighlightedHtml(text, matches) {
            const sorted = [...matches].sort((a, b) => a.offset - b.offset);
            let result = '';
            let cursor = 0;
            for (const m of sorted) {
                const start = m.offset;
                const end = m.offset + m.length;
                const original = text.slice(start, end);
                const tipBase = m.message || '';
                const suggestion = (m.replacements && m.replacements[0])
                    ? ' → ' + m.replacements[0].value
                    : '';
                const tip = escapeHtml(tipBase + suggestion);

                result += escapeHtml(text.slice(cursor, start));
                result += `<span class="err" title="${tip}">${escapeHtml(original)}</span>`;
                cursor = end;
            }
            result += escapeHtml(text.slice(cursor));
            return result;
        }

        // options: { topic?, prompt? }
        function buildFeedback(text, matches, options = {}) {
            const topic = options.topic || null;
            const prompt = options.prompt || null;

            const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
            const sentencesArr = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentences = sentencesArr.length;
            const avgLen = sentences ? (wordCount / sentences).toFixed(1) : 'N/A';
            const paragraphs = text.split(/\n{2,}/).filter(p => p.trim().length > 0).length || 1;

            const grammarCount = matches.filter(m => m.rule && m.rule.issueType === 'grammar').length;
            const spellingCount = matches.filter(m => m.rule && m.rule.issueType === 'misspelling').length;
            const styleCount = matches.filter(m => m.rule && m.rule.issueType === 'style').length;

            let msg = '';

            if (prompt) {
                msg += `Writing prompt:\n"${prompt}"\n\n`;
            }
            if (topic) {
                msg += `Topic:\n"${topic}"\n\n`;
            }

            msg += `Length & structure:\n`;
            msg += `- Paragraphs: ${paragraphs} (aim for at least 3: introduction, body, conclusion)\n`;
            msg += `- Words: ${wordCount}\n`;
            msg += `- Sentences: ${sentences}\n`;
            msg += `- Average words per sentence: ${avgLen}\n\n`;

            msg += `Issues detected:\n`;
            msg += `- Grammar: ${grammarCount}\n`;
            msg += `- Spelling: ${spellingCount}\n`;
            msg += `- Style / phrasing: ${styleCount}\n\n`;

            // 更具體的文法例子
            const exampleLines = [];
            matches.slice(0, 5).forEach(m => {
                const snippet = text.slice(m.offset, m.offset + m.length);
                const repl = (m.replacements && m.replacements[0]) ? m.replacements[0].value : null;
                const rule = m.rule && (m.rule.description || m.rule.issueType || '');
                if (repl) {
                    exampleLines.push(`- "${snippet}" → "${repl}" (${rule})`);
                } else {
                    exampleLines.push(`- "${snippet}" (${rule})`);
                }
            });
            if (exampleLines.length > 0) {
                msg += `Example grammar / wording issues:\n`;
                msg += exampleLines.join('\n') + '\n\n';
            }

            msg += `Suggestions on structure & logic:\n`;
            msg += `- Make sure the first paragraph clearly introduces the topic and your main idea.\n`;
            msg += `- Each body paragraph should focus on ONE main point, supported by examples.\n`;
            msg += `- Use linking words (for example, however, therefore, in addition) to connect ideas.\n`;
            msg += `- End with a conclusion that summarizes the main points and reflects on the topic.\n`;
            if (prompt || topic) {
                msg += `- Check that every paragraph directly responds to the prompt/topic, not just tells unrelated details.\n`;
            }
            msg += '\n';

            msg += `Suggestions on language:\n`;
            msg += `- Review highlighted grammar and spelling errors and rewrite the sentences.\n`;
            msg += `- Replace repeated simple words (good, nice, very) with more precise vocabulary when possible.\n\n`;

            if (rubricItems.length > 0) {
                msg += `Rubric reminder (summary):\n`;
                // 用 bullet points 呈現每個 criterion
                rubricItems.forEach(item => {
                    const lv1 = item.levels[1] ? `1 pt: ${item.levels[1]}` : '';
                    const lv3 = item.levels[3] ? `3 pts: ${item.levels[3]}` : '';
                    const lv5 = item.levels[5] ? `5 pts: ${item.levels[5]}` : '';
                    const parts = [lv1, lv3, lv5].filter(Boolean).join(' | ');
                    msg += `- ${item.criteria}: ${parts}\n`;
                });
            }

            return msg;
        }

        // === 讀取 rubric：對應 Criteria + 1~5 Points 結構 ===
        async function loadRubric() {
            if (rubricText) return;
            try {
                const response = await fetch('https://ducj-creator.github.io/Shirley-AI-Writing/writing%20rubric.csv');
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true }).data;

                rubricItems = [];
                parsed.forEach(row => {
                    const crit = (row['Criteria'] || '').trim();
                    if (!crit) return;
                    const levels = {
                        1: (row['1 Point'] || '').trim(),
                        2: (row['2 Points'] || '').trim(),
                        3: (row['3 Points'] || '').trim(),
                        4: (row['4 Points'] || '').trim(),
                        5: (row['5 Points'] || '').trim()
                    };
                    rubricItems.push({ criteria: crit, levels });
                });

                if (rubricItems.length === 0) throw new Error('Empty rubric after parsing');

                // 轉成文字（給需要用文字顯示的地方）
                rubricText = rubricItems.map(item => {
                    const lv3 = item.levels[3] ? `3 pts: ${item.levels[3]}` : '';
                    const lv4 = item.levels[4] ? `4 pts: ${item.levels[4]}` : '';
                    const lv5 = item.levels[5] ? `5 pts: ${item.levels[5]}` : '';
                    const parts = [lv3, lv4, lv5].filter(Boolean).join(' | ');
                    return `- ${item.criteria}: ${parts}`;
                }).join('\n');
            } catch (e) {
                console.warn('Rubric parse failed, using default.', e);
                rubricItems = [
                    { criteria: 'Essay Structure', levels: { 3: 'Clear introduction, body, and conclusion.' } },
                    { criteria: 'Coherence & Cohesion', levels: { 3: 'Logical order and basic transitions.' } },
                    { criteria: 'Grammar Accuracy', levels: { 3: 'Some minor errors but meaning is clear.' } },
                    { criteria: 'Vocabulary Range & Precision', levels: { 3: 'Adequate vocabulary with some variety.' } }
                ];
                rubricText = rubricItems.map(i => `- ${i.criteria}: ${Object.values(i.levels)[0]}`).join('\n');
            }
        }

        async function loadWritingMaterials() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing-materials.md');
                const md = await response.text();
                const container = document.getElementById('writing-materials');
                container.innerHTML = `
                    <div class="materials-grid">
                        <div class="material-card">
                            <h4>Writing Tips & Guidelines</h4>
                            <pre style="white-space: pre-wrap;">${escapeHtml(md)}</pre>
                        </div>
                        <div class="material-card">
                            <h4>Model Essays (coming soon)</h4>
                            <p>Teachers can place sample essays here in the future.</p>
                        </div>
                        <div class="material-card">
                            <h4>Idea Bank / Writing Materials (coming soon)</h4>
                            <p>Collect interesting ideas, vocabulary, or prompts for students.</p>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('writing-materials').innerHTML =
                    '<p>Place your self-designed materials in writing-materials.md in the repo and update the fetch URL.</p>';
            }
        }

        // --------- UI 切換 ---------
        function enterLevel(level) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(level + '-section');
            if (target) target.classList.add('active');
            document.querySelector('.back-btn').classList.add('active');
            currentLevel = level;
            if (level === 'gists') loadWritingMaterials();
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('home-section').classList.add('active');
            document.querySelector('.back-btn').classList.remove('active');
            currentLevel = 'home';
        }

        function updateReferenceButtonVisibility() {
            const btn = document.getElementById('ref-btn');
            if (!btn) return;
            btn.style.display = drafts.length >= 2 ? 'inline-block' : 'none';
        }

        // --------- Level 1：一般寫作 ---------
        async function analyzeWriting() {
            const container = document.getElementById('output');
            const text = document.getElementById('input-text').value;
            const prompt = document.getElementById('prompt-input').value;

            if (!text.trim()) {
                alert('Please enter text.');
                return;
            }

            const tempDiv = document.createElement('div');
            tempDiv.className = 'analysis-run';
            tempDiv.innerHTML = '<em>Checking your writing... (using grammar checker)</em>';
            container.appendChild(tempDiv);

            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matches = result.matches || [];

                const corrected = buildCorrectedText(text, matches);
                const highlighted = buildHighlightedHtml(text, matches);
                const feedbackText = buildFeedback(text, matches, { prompt });

                const index = drafts.length; // 版本編號
                drafts.push({ original: text, corrected, highlighted, feedback: feedbackText });

                tempDiv.innerHTML = `
                    <div class="version-header">
                        <strong>Version ${index + 1}</strong>
                        <label class="no-print">
                            <input type="checkbox" class="print-select" data-index="${index}">
                            Select this version for printing
                        </label>
                    </div>
                    <h3>Corrected Version:</h3>
                    <div class="diff">${escapeHtml(corrected).replace(/\n/g, '<br>')}</div>
                    <h3 style="margin-top:20px;">Original with highlighted issues:</h3>
                    <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                    <div class="feedback">
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(feedbackText)}</pre>
                    </div>
                `;

                document.getElementById('edit-text').value = corrected;
                updateReferenceButtonVisibility();

            } catch (err) {
                console.error(err);
                tempDiv.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        function submitEdit() {
            document.getElementById('input-text').value = document.getElementById('edit-text').value;
            analyzeWriting();
        }

        // 產生參考范文（以最新版本的 corrected 為基礎）
        function generateReferenceEssay() {
            if (drafts.length < 1) {
                alert('Please run analysis at least once first.');
                return;
            }
            const lastIndex = drafts.length - 1;
            const draft = drafts[lastIndex];

            const container = document.getElementById('output');
            const div = document.createElement('div');
            div.className = 'analysis-run';

            const referenceText =
                'This is a polished reference version based on your latest corrected draft:\n\n' +
                draft.corrected;

            const feedbackText =
                'Reference essay notes:\n' +
                '- Use this version only as a model. Do NOT copy it directly.\n' +
                '- Compare it with your own draft and highlight what has improved in grammar, vocabulary, and structure.\n' +
                '- Try to write your OWN final version after reading this reference.\n';

            const index = drafts.length;
            drafts.push({
                original: draft.corrected,
                corrected: referenceText,
                highlighted: escapeHtml(draft.corrected),
                feedback: feedbackText
            });

            div.innerHTML = `
                <div class="version-header">
                    <strong>Reference Essay (based on Version ${lastIndex + 1})</strong>
                    <label class="no-print">
                        <input type="checkbox" class="print-select" data-index="${index}">
                        Select this version for printing
                    </label>
                </div>
                <h3>Reference Essay:</h3>
                <div class="diff">${escapeHtml(referenceText).replace(/\n/g, '<br>')}</div>
                <div class="feedback">
                    <h3>How to use this reference:</h3>
                    <pre style="white-space: pre-wrap;">${escapeHtml(feedbackText)}</pre>
                </div>
            `;

            container.appendChild(div);
        }

        // 只印出有勾選的版本
        function printDrafts() {
            const selected = Array.from(document.querySelectorAll('.print-select:checked'));
            if (selected.length === 0) {
                alert('Please select at least one version to print.');
                return;
            }

            const printable = document.getElementById('printable-drafts');
            printable.innerHTML = selected.map(checkbox => {
                const idx = parseInt(checkbox.getAttribute('data-index'), 10);
                const draft = drafts[idx];
                if (!draft) return '';

                return `
                    <div class="printable">
                        <h2>Version ${idx + 1}</h2>
                        <h3>Corrected / Reference Version:</h3>
                        <p>${escapeHtml(draft.corrected).replace(/\n/g, '<br>')}</p>
                        <h3>Original with highlighted issues:</h3>
                        <p>${draft.highlighted.replace(/\n/g, '<br>')}</p>
                        <h3>Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(draft.feedback)}</pre>
                    </div>
                `;
            }).join('');

            printable.style.display = 'block';
            window.print();
            printable.style.display = 'none';
        }

        // --------- Level 2：題目作文 ---------
        async function analyzeTopic() {
            const output = document.getElementById('topic-output');
            const topic = document.getElementById('topic-select').value;
            const text = document.getElementById('topic-text').value;

            if (!topic.trim() || !text.trim()) {
                alert('Please choose a topic and enter your essay.');
                return;
            }

            output.innerHTML = '<em>Checking your essay for this topic...</em>';

            try {
                await loadRubric();
                const result = await checkWithLanguageTool(text);
                const matches = result.matches || [];

                const corrected = buildCorrectedText(text, matches);
                const highlighted = buildHighlightedHtml(text, matches);
                const feedbackText = buildFeedback(text, matches, { topic });

                output.innerHTML = `
                    <h3>Corrected Essay:</h3>
                    <div class="diff">${escapeHtml(corrected).replace(/\n/g, '<br>')}</div>
                    <h3 style="margin-top:20px;">Original with highlighted issues:</h3>
                    <div class="diff">${highlighted.replace(/\n/g, '<br>')}</div>
                    <div class="feedback">
                        <h3>Topic-Specific Feedback:</h3>
                        <pre style="white-space: pre-wrap;">${escapeHtml(feedbackText)}</pre>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                output.innerHTML = '<p style="color:red;">Error while calling grammar checker. Please try again later.</p>';
            }
        }

        // 檔案上傳
        document.getElementById('file-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    document.getElementById('input-text').value = ev.target.result;
                };
                reader.readAsText(file);
            }
        });

        // 讓這些函式在 HTML 的 onclick 上可用
        window.enterLevel = enterLevel;
        window.goHome = goHome;
        window.analyzeWriting = analyzeWriting;
        window.submitEdit = submitEdit;
        window.printDrafts = printDrafts;
        window.analyzeTopic = analyzeTopic;
        window.generateReferenceEssay = generateReferenceEssay;

        // 進頁面先試著載教材
        loadWritingMaterials();
    </script>
</body>
</html>
