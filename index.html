<script>
    // ========== 導航歷史 ==========
    let sectionHistory = ['home-section'];
    function enterSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        if (sectionHistory[sectionHistory.length - 1] !== sectionId) {
            sectionHistory.push(sectionId);
        }
        document.querySelector('.back-btn').classList.toggle('active', sectionId !== 'home-section');
    }
    function goBack() {
        if (sectionHistory.length <= 1) {
            sectionHistory = ['home-section'];
            enterSection('home-section');
            return;
        }
        sectionHistory.pop();
        const prev = sectionHistory[sectionHistory.length - 1];
        enterSection(prev);
    }

    // ========== 音效 ==========
    const PAGE_TURN_SOUND = 'data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';

    function playFlipSound(pageId) {
        const pageEl = document.getElementById(pageId);
        if (!pageEl) return;
        const audio = new Audio(PAGE_TURN_SOUND);
        audio.play().catch(() => {});
        const angle = -15;
        pageEl.style.transform = `rotateY(${angle}deg)`;
        pageEl.style.boxShadow = '0 16px 32px rgba(0,0,0,0.2)';
        setTimeout(() => {
            pageEl.style.transform = '';
            pageEl.style.boxShadow = '';
        }, 300);
    }

    // ========== 共用翻頁器（解決所有翻頁失效問題）==========
    function createPager({ containerId, pageId, baseUrl, totalPages, currentPage = 1, onRenderComplete = null }) {
        let page = currentPage;

        const container = document.getElementById(containerId);
        if (!container) return;

        function render() {
            const prevDisabled = page <= 1;
            const nextDisabled = page >= totalPages;

            container.innerHTML = `
                <div style="text-align:center; margin-bottom:12px; color:var(--text-muted); font-size:1em;">
                    Page <strong>${page}</strong> / ${totalPages}
                </div>
                <div id="${containerId}-flip" style="display:flex; justify-content:center; align-items:center; min-height:500px; padding:0 10px;">
                    <div id="${pageId}" style="width:95%; max-width:800px; background:white; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; transition:transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55),box-shadow 0.3s ease; transform-style:preserve-3d;">
                        <img src="${baseUrl}${page}.png"
                             alt="Page ${page}"
                             style="width:100%; display:block; background:#faf9f7;"
                             onerror="this.parentElement.innerHTML='<p style=\\'color:var(--error-border); padding:30px; text-align:center;\\'>Image load failed.</p>'">
                    </div>
                </div>
                <div style="display:flex; gap:16px; justify-content:center; margin-top:20px;">
                    <button class="pager-prev" ${prevDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">← Previous</button>
                    <button class="pager-next" ${nextDisabled ? 'disabled' : ''} style="padding:10px 20px; font-size:16px;">Next →</button>
                </div>
            `;

            // 重新綁定事件（關鍵！）
            document.querySelectorAll('.pager-prev').forEach(btn => {
                btn.onclick = () => {
                    if (page > 1) {
                        page--;
                        playFlipSound(pageId);
                        render();
                    }
                };
            });
            document.querySelectorAll('.pager-next').forEach(btn => {
                btn.onclick = () => {
                    if (page < totalPages) {
                        page++;
                        playFlipSound(pageId);
                        render();
                    }
                };
            });

            // Touch swipe
            const flipContainer = document.getElementById(`${containerId}-flip`);
            if (flipContainer) {
                let startX = 0;
                flipContainer.addEventListener('touchstart', e => startX = e.touches[0].clientX, { passive: true });
                flipContainer.addEventListener('touchend', e => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = startX - endX;
                    if (Math.abs(diff) > 60) {
                        if (diff > 0 && page < totalPages) { page++; playFlipSound(pageId); render(); }
                        else if (diff < 0 && page > 1) { page--; playFlipSound(pageId); render(); }
                    }
                }, { passive: true });
            }

            if (onRenderComplete) onRenderComplete();
        }

        render();
        return { render, getPage: () => page };
    }

    // ========== Writing Gists ==========
    function renderWritingGists() {
        const baseUrl = 'https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing%20gists/';
        createPager({
            containerId: 'writing-gists-container',
            pageId: 'gists-page',
            baseUrl: baseUrl,
            totalPages: 9
        });
    }

    // ========== GSAT Past Papers ==========
    function renderGsatPapers() {
        const baseUrl = 'https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/GSAT%20past%20papers/';
        createPager({
            containerId: 'gsat-viewer-container',
            pageId: 'gsat-page',
            baseUrl: baseUrl,
            totalPages: 11
        });
    }

    // ========== Writing Genres 圖片瀏覽器 ==========
    function renderGenreImages(folder, displayName) {
        const baseUrl = `https://raw.githubusercontent.com/ducj-creator/Shirley-AI-Writing/main/writing%20genres/${folder}/`;
        const maxPossible = 20; // 最多檢查 20 張，避免無限迴圈

        document.getElementById('genre-viewer-title').textContent = `${displayName} Examples`;

        // 先偵測實際頁數
        let detectedPages = 0;
        let checking = 0;

        function checkNext() {
            if (checking >= maxPossible) {
                detectedPages = maxPossible;
                startPager();
                return;
            }
            checking++;
            fetch(`${baseUrl}${checking}.png`, { method: 'HEAD' })
                .then(r => {
                    if (r.ok) {
                        detectedPages = checking;
                        checkNext();
                    } else {
                        startPager();
                    }
                })
                .catch(() => startPager());
        }

        function startPager() {
            if (detectedPages === 0) detectedPages = 1; // 至少一頁
            createPager({
                containerId: 'genre-viewer-container',
                pageId: 'genre-page',
                baseUrl: baseUrl,
                totalPages: detectedPages
            });
        }

        checkNext();
    }

    // ========== Writing Genres 選單 ==========
    function renderWritingGenres() {
        const container = document.getElementById('writing-genres-container');
        const genres = [
            { name: "Diagrams", folder: "diagram" },
            { name: "Argumentative", folder: "argumentative" },
            { name: "Images", folder: "images" },
            { name: "Narrative", folder: "narrative" },
            { name: "Expository", folder: "expository" },
            { name: "Descriptive", folder: "descriptive" }
        ];
        const html = genres.map(g => `
            <div class="material-card" style="cursor:pointer;"
                 onclick="enterSection('genre-image-viewer-section'); renderGenreImages('${g.folder}', '${g.name}')">
                <h4>${g.name}</h4>
                <p>Examples for ${g.name.toLowerCase()} writing.</p>
            </div>
        `).join('');
        container.innerHTML = `<div class="materials-grid">${html}</div>`;
    }

    // ========== 其他原本函數（保持不變）==========
    function loadWritingMaterials() {
        const container = document.getElementById('writing-materials');
        container.innerHTML = `
            <div class="materials-grid">
                <div class="material-card" onclick="enterSection('writing-tips-menu-section')">
                    <h4>Writing Tips & Guidelines</h4>
                    <p>Click to explore writing gists and genres.</p>
                </div>
                <div class="material-card" onclick="enterSection('model-essays-section')">
                    <h4>Model Essays</h4>
                    <p>Click to browse sample essays and past papers.</p>
                </div>
                <div class="material-card">
                    <h4>Idea Bank / Writing Materials (coming soon)</h4>
                    <p>Collect interesting ideas, vocabulary, or prompts for students.</p>
                </div>
            </div>
        `;
    }

    // 以下為你原本就有的 mock 函數，保持不變
    function toggleRubric() { }
    function analyzeWriting() { alert('Analysis triggered (mock)'); }
    function printDrafts() { }
    function analyzeTopic() { }
    function generateReferenceEssay() { }
    function useVersionAsCurrent() { }
    function useTopicVersionAsCurrent() { }
    function printTopicDrafts() { }
    function initTopicCategories() { }
    function loadRubric() { }

    // 全域暴露
    window.enterSection = enterSection;
    window.goBack = goBack;
    window.toggleRubric = toggleRubric;
    window.analyzeWriting = analyzeWriting;
    window.printDrafts = printDrafts;
    window.analyzeTopic = analyzeTopic;
    window.generateReferenceEssay = generateReferenceEssay;
    window.useVersionAsCurrent = useVersionAsCurrent;
    window.useTopicVersionAsCurrent = useTopicVersionAsCurrent;
    window.printTopicDrafts = printTopicDrafts;

    // Init
    loadWritingMaterials();
    loadRubric();
    initTopicCategories();
</script>
